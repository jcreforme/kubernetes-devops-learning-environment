# 4. Helm Upgrade With File

## ğŸ¯ Learning Objectives
- [ ] Master `helm upgrade -f values.yaml` command
- [ ] Understand values file precedence
- [ ] Learn to use multiple values files
- [ ] Practice safe upgrade strategies
- [ ] Implement configuration management workflows

## ğŸ“‹ Basic Upgrade with Values File

### Command Syntax
```bash
helm upgrade [RELEASE] [CHART] -f [VALUES-FILE]
```

### Simple Values File Upgrade
```bash
# Create or modify values file
cat > my-values.yaml << EOF
replicaCount: 3
image:
  tag: "1.26.0"
service:
  type: LoadBalancer
EOF

# Upgrade release with values file
helm upgrade my-release bitnami/nginx -f my-values.yaml
```

### Upgrade with Install Fallback
```bash
# Install if release doesn't exist, upgrade if it does
helm upgrade --install my-release bitnami/nginx -f my-values.yaml
```

## ğŸ“ Values File Examples

### Development Environment Values (dev-values.yaml)
```yaml
# Development configuration
replicaCount: 1

image:
  repository: nginx
  tag: "1.25.3"
  pullPolicy: Always

service:
  type: NodePort
  port: 80

resources:
  limits:
    cpu: 200m
    memory: 256Mi
  requests:
    cpu: 100m
    memory: 128Mi

# Development-specific settings
autoscaling:
  enabled: false

ingress:
  enabled: true
  className: "nginx"
  hosts:
    - host: myapp-dev.local
      paths:
        - path: /
          pathType: Prefix

# Enable debug mode
env:
  - name: DEBUG
    value: "true"
  - name: LOG_LEVEL
    value: "debug"
```

### Production Environment Values (prod-values.yaml)
```yaml
# Production configuration
replicaCount: 3

image:
  repository: nginx
  tag: "1.25.3"
  pullPolicy: IfNotPresent

service:
  type: LoadBalancer
  port: 80

resources:
  limits:
    cpu: 500m
    memory: 512Mi
  requests:
    cpu: 250m
    memory: 256Mi

# Production scaling
autoscaling:
  enabled: true
  minReplicas: 3
  maxReplicas: 10
  targetCPUUtilizationPercentage: 70

ingress:
  enabled: true
  className: "nginx"
  annotations:
    cert-manager.io/cluster-issuer: "letsencrypt-prod"
  hosts:
    - host: myapp.example.com
      paths:
        - path: /
          pathType: Prefix
  tls:
    - secretName: myapp-tls
      hosts:
        - myapp.example.com

# Security settings
securityContext:
  runAsNonRoot: true
  runAsUser: 1001
  fsGroup: 1001

# Production monitoring
env:
  - name: LOG_LEVEL
    value: "info"
```

## ğŸ”„ Multiple Values Files

### Using Multiple Files
```bash
# Apply multiple values files (later files override earlier ones)
helm upgrade my-release bitnami/nginx \
  -f base-values.yaml \
  -f environment-specific.yaml \
  -f secrets.yaml
```

### Values File Hierarchy Example
```bash
# Base configuration for all environments
# base-values.yaml
image:
  repository: nginx
  pullPolicy: IfNotPresent
service:
  port: 80

# Environment-specific overrides
# prod-values.yaml
replicaCount: 3
resources:
  limits:
    cpu: 500m
    memory: 512Mi

# Apply both files
helm upgrade my-release bitnami/nginx \
  -f base-values.yaml \
  -f prod-values.yaml
```

## âš™ï¸ Advanced Upgrade Options

### Upgrade with Timeout
```bash
helm upgrade my-release bitnami/nginx \
  -f my-values.yaml \
  --timeout 10m
```

### Upgrade with Wait
```bash
# Wait for all resources to be ready
helm upgrade my-release bitnami/nginx \
  -f my-values.yaml \
  --wait \
  --wait-for-jobs
```

### Upgrade with Atomic Operation
```bash
# Rollback automatically if upgrade fails
helm upgrade my-release bitnami/nginx \
  -f my-values.yaml \
  --atomic
```

### Force Upgrade
```bash
# Force resource updates even if unchanged
helm upgrade my-release bitnami/nginx \
  -f my-values.yaml \
  --force
```

## ğŸ›¡ï¸ Safe Upgrade Strategies

### 1. Dry Run Before Upgrade
```bash
# Test upgrade without applying changes
helm upgrade my-release bitnami/nginx \
  -f my-values.yaml \
  --dry-run \
  --debug
```

### 2. Backup Before Upgrade
```bash
# Get current values before upgrade
helm get values my-release --all > backup-values.yaml

# Get current manifest
helm get manifest my-release > backup-manifest.yaml

# Proceed with upgrade
helm upgrade my-release bitnami/nginx -f new-values.yaml
```

### 3. Staged Rollout
```bash
# Step 1: Update image only
helm upgrade my-release bitnami/nginx \
  --set image.tag=1.26.0 \
  --wait

# Step 2: Scale up replicas
helm upgrade my-release bitnami/nginx \
  -f production-scale.yaml \
  --wait

# Step 3: Apply full configuration
helm upgrade my-release bitnami/nginx \
  -f complete-values.yaml \
  --wait
```

## ğŸ“Š Configuration Management Workflows

### GitOps Workflow with Values Files
```bash
# Directory structure
environments/
â”œâ”€â”€ dev/
â”‚   â””â”€â”€ values.yaml
â”œâ”€â”€ staging/
â”‚   â””â”€â”€ values.yaml
â””â”€â”€ prod/
    â””â”€â”€ values.yaml

# Deploy to different environments
helm upgrade dev-release myapp/chart -f environments/dev/values.yaml
helm upgrade staging-release myapp/chart -f environments/staging/values.yaml
helm upgrade prod-release myapp/chart -f environments/prod/values.yaml
```

### Environment Promotion Pipeline
```bash
#!/bin/bash
# promote-environment.sh

CHART_NAME="myapp"
CHART_VERSION="1.0.0"

# Deploy to dev
helm upgrade --install dev-myapp $CHART_NAME \
  --version $CHART_VERSION \
  -f values/common.yaml \
  -f values/dev.yaml \
  --namespace dev

# If dev succeeds, promote to staging
if [ $? -eq 0 ]; then
  helm upgrade --install staging-myapp $CHART_NAME \
    --version $CHART_VERSION \
    -f values/common.yaml \
    -f values/staging.yaml \
    --namespace staging
fi

# If staging succeeds, promote to production
if [ $? -eq 0 ]; then
  helm upgrade --install prod-myapp $CHART_NAME \
    --version $CHART_VERSION \
    -f values/common.yaml \
    -f values/prod.yaml \
    --namespace production
fi
```

## ğŸ” Troubleshooting Upgrades

### Check Upgrade Status
```bash
# Check release status
helm status my-release

# View upgrade history
helm history my-release

# Get current values
helm get values my-release --all
```

### Debug Failed Upgrades
```bash
# Check what would be applied
helm upgrade my-release bitnami/nginx \
  -f my-values.yaml \
  --dry-run \
  --debug

# Check Kubernetes events
kubectl get events --sort-by=.metadata.creationTimestamp

# Check pod logs
kubectl logs -l app.kubernetes.io/instance=my-release
```

### Rollback Failed Upgrade
```bash
# Rollback to previous version
helm rollback my-release

# Rollback to specific revision
helm rollback my-release 2
```

## ğŸ“ Practice Exercises

### Exercise 1: Basic Upgrade
1. **Install a release**: `helm install test-app bitnami/nginx`
2. **Create values file**: Define custom replica count and image tag
3. **Upgrade release**: `helm upgrade test-app bitnami/nginx -f my-values.yaml`
4. **Verify changes**: Check pods and configuration

### Exercise 2: Multi-Environment Setup
1. **Create base values**: Common configuration for all environments
2. **Create environment-specific values**: Different settings for dev/prod
3. **Deploy to multiple environments**: Use different values files
4. **Compare configurations**: Use `helm get values` to verify differences

### Exercise 3: Safe Upgrade Practice
1. **Perform dry run**: Test upgrade before applying
2. **Backup current state**: Save current values and manifest
3. **Execute upgrade**: Apply new configuration
4. **Validate deployment**: Ensure application works correctly
5. **Practice rollback**: Simulate failure recovery

## ğŸ“ Best Practices Summary

### Values File Management
- âœ… Use meaningful file names (dev-values.yaml, prod-values.yaml)
- âœ… Keep environment-specific values separate
- âœ… Version control all values files
- âœ… Document value changes and their impact

### Upgrade Safety
- âœ… Always perform dry runs before upgrades
- âœ… Backup current configuration before changes
- âœ… Use atomic upgrades for critical deployments
- âœ… Monitor applications after upgrades

### Organization
- âœ… Organize values files by environment
- âœ… Use consistent naming conventions
- âœ… Implement proper change management processes
- âœ… Test upgrades in non-production environments first

## â¡ï¸ Next Steps
Now that you understand upgrading with values files, proceed to [5. Helm-Upgrade-Set-Values.md](5.%20Helm-Upgrade-Set-Values.md) to learn about setting individual values during upgrades.