# 5. Helm Upgrade Set Values

## üéØ Learning Objectives
- [ ] Master `helm upgrade --set key=value` command
- [ ] Understand value override precedence
- [ ] Learn complex value setting techniques
- [ ] Practice combining --set with -f flags
- [ ] Implement dynamic configuration updates

## üìã Basic --set Command Usage

### Simple Value Setting
```bash
# Set a single value
helm upgrade my-release bitnami/nginx --set replicaCount=3

# Set multiple values
helm upgrade my-release bitnami/nginx \
  --set replicaCount=3 \
  --set image.tag=1.26.0
```

### String Values
```bash
# Set string values (automatic quoting)
helm upgrade my-release bitnami/nginx \
  --set image.repository=nginx \
  --set service.type=LoadBalancer

# Force string values with explicit quotes
helm upgrade my-release bitnami/nginx \
  --set 'tolerations[0].key="node-role"'
```

## üîß Complex Value Setting

### Nested Object Values
```bash
# Set nested values using dot notation
helm upgrade my-release bitnami/nginx \
  --set image.repository=nginx \
  --set image.tag=1.26.0 \
  --set image.pullPolicy=Always
```

### Array Values
```bash
# Set array values using bracket notation
helm upgrade my-release bitnami/nginx \
  --set 'tolerations[0].key=node-role' \
  --set 'tolerations[0].operator=Equal' \
  --set 'tolerations[0].value=worker' \
  --set 'tolerations[0].effect=NoSchedule'

# Set multiple array elements
helm upgrade my-release bitnami/nginx \
  --set 'env[0].name=DEBUG' \
  --set 'env[0].value=true' \
  --set 'env[1].name=LOG_LEVEL' \
  --set 'env[1].value=info'
```

### Boolean and Numeric Values
```bash
# Boolean values
helm upgrade my-release bitnami/nginx \
  --set autoscaling.enabled=true \
  --set ingress.enabled=false

# Numeric values
helm upgrade my-release bitnami/nginx \
  --set replicaCount=5 \
  --set service.port=8080
```

## üìä Advanced --set Techniques

### Multi-line Values
```bash
# Set multi-line string values
helm upgrade my-release bitnami/nginx \
  --set 'config.nginx\.conf=server {
    listen 80;
    server_name localhost;
    location / {
        proxy_pass http://backend;
    }
}'
```

### JSON Values
```bash
# Set complex JSON structures
helm upgrade my-release bitnami/nginx \
  --set-json 'resources={"limits":{"cpu":"500m","memory":"512Mi"},"requests":{"cpu":"250m","memory":"256Mi"}}'
```

### File-based Values
```bash
# Set values from files
helm upgrade my-release bitnami/nginx \
  --set-file config.data=./config.properties

# Set multiple file values
helm upgrade my-release bitnami/nginx \
  --set-file app.config=./app.conf \
  --set-file nginx.config=./nginx.conf
```

## üîÑ Combining --set with Values Files

### Override Values File with --set
```bash
# Values file takes precedence, --set overrides specific values
helm upgrade my-release bitnami/nginx \
  -f production-values.yaml \
  --set image.tag=hotfix-1.26.1 \
  --set replicaCount=5
```

### Multiple Override Levels
```bash
# Precedence order: --set > -f files (last file wins) > chart defaults
helm upgrade my-release bitnami/nginx \
  -f base-values.yaml \
  -f environment-values.yaml \
  --set image.tag=urgent-patch \
  --set resources.limits.cpu=1000m
```

## üöÄ Common Use Cases

### Quick Environment Switches
```bash
# Switch to development mode
helm upgrade my-release bitnami/nginx \
  --set env.DEBUG=true \
  --set resources.limits.cpu=200m \
  --set autoscaling.enabled=false

# Switch to production mode
helm upgrade my-release bitnami/nginx \
  --set env.DEBUG=false \
  --set resources.limits.cpu=500m \
  --set autoscaling.enabled=true
```

### Scaling Operations
```bash
# Quick scale up
helm upgrade my-release bitnami/nginx --set replicaCount=10

# Scale with resource adjustments
helm upgrade my-release bitnami/nginx \
  --set replicaCount=8 \
  --set resources.requests.cpu=300m \
  --set resources.requests.memory=384Mi
```

### Image Updates
```bash
# Deploy new image version
helm upgrade my-release bitnami/nginx \
  --set image.tag=1.27.0 \
  --wait

# Deploy with different repository
helm upgrade my-release bitnami/nginx \
  --set image.repository=my-registry.com/nginx \
  --set image.tag=custom-1.26.0 \
  --set image.pullPolicy=Always
```

### Configuration Updates
```bash
# Update service configuration
helm upgrade my-release bitnami/nginx \
  --set service.type=LoadBalancer \
  --set service.port=443 \
  --set 'service.annotations.service\.beta\.kubernetes\.io/aws-load-balancer-type=nlb'

# Update ingress settings
helm upgrade my-release bitnami/nginx \
  --set ingress.enabled=true \
  --set 'ingress.hosts[0].host=myapp.example.com' \
  --set 'ingress.hosts[0].paths[0].path=/' \
  --set 'ingress.hosts[0].paths[0].pathType=Prefix'
```

## üìù Real-world Examples

### Emergency Scaling
```bash
#!/bin/bash
# emergency-scale.sh - Quick scaling script

RELEASE_NAME="production-app"
CHART_NAME="myapp/web"
REPLICAS=${1:-5}

echo "Scaling $RELEASE_NAME to $REPLICAS replicas..."

helm upgrade $RELEASE_NAME $CHART_NAME \
  --set replicaCount=$REPLICAS \
  --wait \
  --timeout 5m

if [ $? -eq 0 ]; then
  echo "Successfully scaled to $REPLICAS replicas"
  kubectl get pods -l app.kubernetes.io/instance=$RELEASE_NAME
else
  echo "Scaling failed, consider rollback"
  helm rollback $RELEASE_NAME
fi
```

### Configuration Hotfix
```bash
#!/bin/bash
# hotfix-config.sh - Apply configuration hotfix

RELEASE_NAME="api-server"
CHART_NAME="myapp/api"

# Apply hotfix configuration
helm upgrade $RELEASE_NAME $CHART_NAME \
  --set 'config.maxConnections=1000' \
  --set 'config.timeoutSeconds=30' \
  --set 'config.retryAttempts=3' \
  --reuse-values \
  --wait

echo "Hotfix applied successfully"
```

### A/B Testing Deployment
```bash
# Deploy version A
helm upgrade app-version-a bitnami/nginx \
  --set image.tag=v2.0.0 \
  --set 'labels.version=a' \
  --set replicaCount=2

# Deploy version B
helm upgrade app-version-b bitnami/nginx \
  --set image.tag=v2.1.0-beta \
  --set 'labels.version=b' \
  --set replicaCount=1
```

## ‚ö° Dynamic Value Setting

### Environment-based Values
```bash
# Set values based on environment variables
ENVIRONMENT=${DEPLOYMENT_ENV:-development}
IMAGE_TAG=${CI_COMMIT_SHA:-latest}

helm upgrade my-release bitnami/nginx \
  --set environment=$ENVIRONMENT \
  --set image.tag=$IMAGE_TAG \
  --set 'labels.buildId'=$CI_BUILD_ID
```

### Conditional Value Setting
```bash
#!/bin/bash
# conditional-upgrade.sh

RELEASE_NAME="my-app"
CHART_NAME="myapp/chart"
ENVIRONMENT=${1:-dev}

BASE_CMD="helm upgrade $RELEASE_NAME $CHART_NAME"

case $ENVIRONMENT in
  "prod")
    $BASE_CMD \
      --set replicaCount=5 \
      --set resources.limits.cpu=500m \
      --set autoscaling.enabled=true
    ;;
  "staging")
    $BASE_CMD \
      --set replicaCount=2 \
      --set resources.limits.cpu=250m \
      --set autoscaling.enabled=false
    ;;
  "dev")
    $BASE_CMD \
      --set replicaCount=1 \
      --set resources.limits.cpu=100m \
      --set env.DEBUG=true
    ;;
esac
```

## üõ†Ô∏è Troubleshooting --set Values

### Escaping Special Characters
```bash
# Escape dots in keys
helm upgrade my-release bitnami/nginx \
  --set 'annotations.prometheus\.io/scrape=true'

# Escape quotes in values
helm upgrade my-release bitnami/nginx \
  --set 'config.message="Hello \"World\""'

# Escape commas in values
helm upgrade my-release bitnami/nginx \
  --set 'config.tags="tag1\,tag2\,tag3"'
```

### Debugging Value Setting
```bash
# Use dry-run to see what values would be set
helm upgrade my-release bitnami/nginx \
  --set replicaCount=3 \
  --set image.tag=1.26.0 \
  --dry-run \
  --debug

# Check current values after upgrade
helm get values my-release --all
```

## üìù Practice Exercises

### Exercise 1: Basic Value Setting
1. **Install a release**: `helm install test-nginx bitnami/nginx`
2. **Scale replicas**: Use --set to change replica count to 3
3. **Update image**: Set a specific image tag
4. **Verify changes**: Check pods and configuration

### Exercise 2: Complex Value Updates
1. **Set nested values**: Configure image repository, tag, and pull policy
2. **Set array values**: Add environment variables using --set
3. **Enable features**: Turn on autoscaling and ingress
4. **Combine methods**: Use both -f and --set together

### Exercise 3: Dynamic Configuration
1. **Create a script**: Dynamically set values based on parameters
2. **Environment switching**: Script that deploys different configs per environment
3. **Hotfix simulation**: Quick configuration change without values file

## üéì Best Practices Summary

### When to Use --set
- ‚úÖ Quick configuration changes
- ‚úÖ Environment-specific overrides
- ‚úÖ CI/CD pipeline dynamic values
- ‚úÖ Emergency hotfixes
- ‚úÖ Testing different configurations

### When to Use Values Files Instead
- ‚úÖ Complex configuration structures
- ‚úÖ Multiple related changes
- ‚úÖ Configuration that needs version control
- ‚úÖ Repeatable deployments
- ‚úÖ Documentation of configuration

### Safety Tips
- ‚úÖ Use --dry-run to preview changes
- ‚úÖ Validate values with helm get values
- ‚úÖ Escape special characters properly
- ‚úÖ Combine with --wait for safer deployments
- ‚úÖ Test in non-production first

## üîÑ Value Precedence Order
1. **--set flags** (highest precedence)
2. **--set-file flags**
3. **-f/--values files** (last file wins)
4. **Chart default values** (lowest precedence)

## ‚û°Ô∏è Next Steps
Now that you understand setting values during upgrades, proceed to [6. Helm-Rollback.md](6.%20Helm-Rollback.md) to learn about rolling back failed or problematic deployments.