# 6. Helm Rollback

## ğŸ¯ Learning Objectives
- [ ] Master `helm rollback` command and options
- [ ] Understand revision management and history
- [ ] Learn rollback strategies and best practices
- [ ] Practice failure recovery scenarios
- [ ] Implement automated rollback procedures

## ğŸ“‹ Basic Rollback Commands

### Simple Rollback to Previous Version
```bash
# Rollback to the previous revision
helm rollback my-release

# Rollback with confirmation
helm rollback my-release --wait
```

### Rollback to Specific Revision
```bash
# Check release history first
helm history my-release

# Rollback to specific revision
helm rollback my-release 3

# Rollback to specific revision with wait
helm rollback my-release 2 --wait --timeout 5m
```

## ğŸ“Š Understanding Release History

### View Release History
```bash
# Basic history
helm history my-release

# Detailed history
helm history my-release --max 10

# History output example
REVISION  UPDATED                   STATUS      CHART         APP VERSION  DESCRIPTION
1         Mon Jan 15 10:00:00 2024  superseded  nginx-1.15.4  1.25.3       Install complete
2         Mon Jan 15 11:00:00 2024  superseded  nginx-1.15.4  1.25.3       Upgrade complete
3         Mon Jan 15 12:00:00 2024  failed      nginx-1.15.5  1.25.4       Upgrade failed
4         Mon Jan 15 13:00:00 2024  deployed    nginx-1.15.4  1.25.3       Rollback to 2
```

### Revision States Explained

| Status | Description |
|--------|-------------|
| `deployed` | Currently active revision |
| `superseded` | Previous revision, replaced by newer one |
| `failed` | Revision that failed during deployment |
| `pending-install` | Installation in progress |
| `pending-upgrade` | Upgrade in progress |
| `pending-rollback` | Rollback in progress |

### Compare Revisions
```bash
# Get values from specific revision
helm get values my-release --revision 1
helm get values my-release --revision 2

# Get manifest from specific revision
helm get manifest my-release --revision 1

# Compare current vs previous values
helm get values my-release --revision 1 > rev1-values.yaml
helm get values my-release --revision 2 > rev2-values.yaml
diff rev1-values.yaml rev2-values.yaml
```

## ğŸ”„ Rollback Scenarios and Strategies

### Scenario 1: Failed Upgrade Recovery
```bash
# Check failed release
helm list --failed

# View history to understand failure
helm history failed-release

# Get error details
helm status failed-release

# Rollback to last working revision
helm rollback failed-release --wait
```

### Scenario 2: Performance Regression
```bash
# Application performance degraded after upgrade
# Check current metrics/logs first

# Quick rollback to previous version
helm rollback my-release $(helm history my-release --max 2 -o json | jq '.[1].revision')

# Verify rollback success
helm status my-release
kubectl get pods -l app.kubernetes.io/instance=my-release
```

### Scenario 3: Configuration Error
```bash
# Wrong configuration deployed
# Check what changed
helm get values my-release --revision $(helm history my-release --max 1 -o json | jq '.[0].revision')

# Rollback to known good configuration
helm rollback my-release 2 --wait

# Verify configuration is correct
helm get values my-release
```

## âš™ï¸ Advanced Rollback Options

### Rollback with Cleanup
```bash
# Clean up resources after rollback
helm rollback my-release --cleanup-on-fail
```

### Force Rollback
```bash
# Force rollback even if resources are in use
helm rollback my-release --force
```

### Dry Run Rollback
```bash
# Preview rollback without applying
helm rollback my-release 2 --dry-run
```

### Rollback with Timeout
```bash
# Set custom timeout for rollback operation
helm rollback my-release --timeout 10m --wait
```

## ğŸ›¡ï¸ Safe Rollback Practices

### Pre-Rollback Checklist
```bash
#!/bin/bash
# pre-rollback-check.sh

RELEASE_NAME=$1
TARGET_REVISION=${2:-"previous"}

echo "ğŸ” Pre-rollback checks for $RELEASE_NAME"

# 1. Check current status
echo "Current status:"
helm status $RELEASE_NAME

# 2. View history
echo "Release history:"
helm history $RELEASE_NAME

# 3. Check cluster resources
echo "Current pods:"
kubectl get pods -l app.kubernetes.io/instance=$RELEASE_NAME

# 4. Check for persistent volumes
echo "Checking for PVs:"
kubectl get pv -o wide | grep $RELEASE_NAME

# 5. Backup current configuration
echo "Backing up current configuration..."
helm get values $RELEASE_NAME --all > backup-${RELEASE_NAME}-$(date +%Y%m%d-%H%M%S).yaml

echo "âœ… Pre-rollback checks complete"
```

### Automated Rollback with Monitoring
```bash
#!/bin/bash
# monitored-rollback.sh

RELEASE_NAME=$1
TARGET_REVISION=$2
HEALTH_CHECK_URL=$3

# Perform rollback
echo "ğŸ”„ Rolling back $RELEASE_NAME to revision $TARGET_REVISION"
helm rollback $RELEASE_NAME $TARGET_REVISION --wait

if [ $? -eq 0 ]; then
  echo "âœ… Rollback successful, checking health..."
  
  # Wait for pods to be ready
  kubectl wait --for=condition=ready pods -l app.kubernetes.io/instance=$RELEASE_NAME --timeout=300s
  
  # Health check
  if [ ! -z "$HEALTH_CHECK_URL" ]; then
    for i in {1..5}; do
      if curl -f $HEALTH_CHECK_URL > /dev/null 2>&1; then
        echo "âœ… Health check passed"
        break
      else
        echo "âš ï¸ Health check failed, attempt $i/5"
        sleep 10
      fi
    done
  fi
  
  echo "ğŸ‰ Rollback completed successfully"
else
  echo "âŒ Rollback failed"
  exit 1
fi
```

## ğŸš¨ Emergency Rollback Procedures

### Quick Emergency Rollback
```bash
#!/bin/bash
# emergency-rollback.sh - Ultra-fast rollback script

RELEASE_NAME=$1

if [ -z "$RELEASE_NAME" ]; then
  echo "Usage: $0 <release-name>"
  exit 1
fi

echo "ğŸš¨ EMERGENCY ROLLBACK for $RELEASE_NAME"

# Find last successful revision
LAST_GOOD_REV=$(helm history $RELEASE_NAME --max 10 -o json | \
  jq -r '.[] | select(.status=="superseded" or .status=="deployed") | .revision' | \
  tail -2 | head -1)

if [ -z "$LAST_GOOD_REV" ]; then
  echo "âŒ No good revision found"
  exit 1
fi

echo "ğŸ”„ Rolling back to revision $LAST_GOOD_REV"
helm rollback $RELEASE_NAME $LAST_GOOD_REV --wait --timeout 2m

# Verify rollback
if [ $? -eq 0 ]; then
  echo "âœ… Emergency rollback successful"
  kubectl get pods -l app.kubernetes.io/instance=$RELEASE_NAME
else
  echo "âŒ Emergency rollback failed"
  exit 1
fi
```

### Blue-Green Rollback Strategy
```bash
#!/bin/bash
# blue-green-rollback.sh

BLUE_RELEASE="app-blue"
GREEN_RELEASE="app-green"
SERVICE_NAME="app-service"

# Check which deployment is currently active
CURRENT_SELECTOR=$(kubectl get service $SERVICE_NAME -o jsonpath='{.spec.selector.version}')

if [ "$CURRENT_SELECTOR" = "blue" ]; then
  ACTIVE_RELEASE=$BLUE_RELEASE
  STANDBY_RELEASE=$GREEN_RELEASE
  NEW_SELECTOR="green"
else
  ACTIVE_RELEASE=$GREEN_RELEASE
  STANDBY_RELEASE=$BLUE_RELEASE
  NEW_SELECTOR="blue"
fi

echo "ğŸ”„ Rolling back from $ACTIVE_RELEASE to $STANDBY_RELEASE"

# Switch service selector
kubectl patch service $SERVICE_NAME -p '{"spec":{"selector":{"version":"'$NEW_SELECTOR'"}}}'

echo "âœ… Traffic switched to $STANDBY_RELEASE"

# Scale down old deployment after verification
echo "â³ Waiting for verification before scaling down old deployment..."
read -p "Press enter to scale down $ACTIVE_RELEASE or Ctrl+C to abort: "

helm upgrade $ACTIVE_RELEASE myapp/chart --set replicaCount=0
echo "ğŸ‰ Rollback complete"
```

## ğŸ” Troubleshooting Rollbacks

### Failed Rollback Recovery
```bash
# If rollback fails, check cluster state
kubectl get events --sort-by=.metadata.creationTimestamp

# Check resource conflicts
kubectl get all -l app.kubernetes.io/instance=my-release

# Force delete stuck resources if needed
kubectl delete pods -l app.kubernetes.io/instance=my-release --force --grace-period=0

# Try rollback again
helm rollback my-release --force
```

### Rollback Verification
```bash
# Verify rollback completion
helm status my-release

# Check if pods are running with correct image
kubectl get pods -l app.kubernetes.io/instance=my-release -o jsonpath='{.items[*].spec.containers[*].image}'

# Compare current values with expected values
helm get values my-release
```

## ğŸ“Š Rollback Monitoring and Alerting

### Post-Rollback Health Checks
```bash
#!/bin/bash
# health-check-after-rollback.sh

RELEASE_NAME=$1
NAMESPACE=${2:-default}

echo "ğŸ¥ Health check for $RELEASE_NAME in $NAMESPACE"

# Check pod status
echo "Pod status:"
kubectl get pods -l app.kubernetes.io/instance=$RELEASE_NAME -n $NAMESPACE

# Check service endpoints
echo "Service endpoints:"
kubectl get endpoints -l app.kubernetes.io/instance=$RELEASE_NAME -n $NAMESPACE

# Check ingress (if exists)
echo "Ingress status:"
kubectl get ingress -l app.kubernetes.io/instance=$RELEASE_NAME -n $NAMESPACE 2>/dev/null || echo "No ingress found"

# Application-specific health check
HEALTH_ENDPOINT=$(kubectl get ingress -l app.kubernetes.io/instance=$RELEASE_NAME -n $NAMESPACE -o jsonpath='{.items[0].spec.rules[0].host}' 2>/dev/null)
if [ ! -z "$HEALTH_ENDPOINT" ]; then
  echo "Testing health endpoint: https://$HEALTH_ENDPOINT/health"
  curl -f https://$HEALTH_ENDPOINT/health || echo "Health endpoint not responding"
fi
```

## ğŸ“ Practice Exercises

### Exercise 1: Basic Rollback
1. **Deploy application**: `helm install test-app bitnami/nginx`
2. **Upgrade with changes**: Change replica count and image tag
3. **Simulate failure**: Deploy with invalid configuration
4. **Practice rollback**: Roll back to previous working version
5. **Verify recovery**: Ensure application is working correctly

### Exercise 2: Revision Management
1. **Create multiple revisions**: Perform several upgrades
2. **Explore history**: Use `helm history` to understand changes
3. **Compare revisions**: Check differences between revisions
4. **Selective rollback**: Roll back to specific revision (not just previous)

### Exercise 3: Emergency Scenario
1. **Simulate production issue**: Deploy problematic configuration
2. **Quick diagnosis**: Identify the issue using Helm and kubectl
3. **Emergency rollback**: Perform rapid rollback using scripts
4. **Validation**: Verify system recovery and stability

### Exercise 4: Automated Rollback
1. **Create rollback script**: Automated rollback with health checks
2. **Test script**: Validate script with different scenarios
3. **Integrate monitoring**: Add health checks and alerting
4. **Document procedure**: Create runbook for team usage

## ğŸ“ Rollback Best Practices

### Before Rolling Back
- âœ… Understand the root cause of the issue
- âœ… Check if the issue can be fixed with a forward upgrade
- âœ… Review the target revision's configuration
- âœ… Backup current state before rollback
- âœ… Communicate with stakeholders

### During Rollback
- âœ… Use --wait flag to ensure completion
- âœ… Monitor application logs during rollback
- âœ… Watch for resource conflicts or issues
- âœ… Have a communication plan ready

### After Rollback
- âœ… Verify application functionality
- âœ… Check all integrated systems
- âœ… Update monitoring and alerting
- âœ… Document the incident and rollback
- âœ… Plan forward fix to avoid future rollbacks

### Rollback Prevention
- âœ… Use --dry-run before upgrades
- âœ… Test upgrades in staging environments
- âœ… Implement gradual rollout strategies
- âœ… Monitor application health continuously
- âœ… Use atomic upgrades when possible

## â¡ï¸ Next Steps
Now that you understand rollback procedures, proceed to [7. Dry-Runs.md](7.%20Dry-Runs.md) to learn about safely testing changes before applying them.