# 8. Reusable Kustomize Components

## ğŸ¯ Learning Objectives
- [ ] Understand Kustomize components architecture and benefits
- [ ] Create reusable components for common deployment patterns
- [ ] Implement component composition and inheritance
- [ ] Build a component library for organizational reuse
- [ ] Master component versioning and lifecycle management

## ğŸ§© Understanding Kustomize Components

### What are Components?
Components in Kustomize are reusable configuration units that can be included in multiple Kustomizations. They provide:

```
Components Benefits:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ âœ… Reusability    â”‚ Share common patterns across projects    â”‚
â”‚ âœ… Consistency    â”‚ Standardize configurations organization   â”‚
â”‚ âœ… Modularity     â”‚ Compose complex systems from simple partsâ”‚
â”‚ âœ… Maintainabilityâ”‚ Update once, apply everywhere           â”‚
â”‚ âœ… Abstraction    â”‚ Hide complexity behind simple interfaces â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Traditional Approach:         Component Approach:
Project A/                    components/
â”œâ”€â”€ base/                     â”œâ”€â”€ monitoring/
â”‚   â”œâ”€â”€ app.yaml             â”‚   â”œâ”€â”€ kustomization.yaml
â”‚   â””â”€â”€ monitoring.yaml  â”€â”€â–º â”‚   â”œâ”€â”€ prometheus.yaml
Project B/                    â”‚   â””â”€â”€ grafana.yaml
â”œâ”€â”€ base/                     â””â”€â”€ ingress-nginx/
â”‚   â”œâ”€â”€ api.yaml                  â”œâ”€â”€ kustomization.yaml
â”‚   â””â”€â”€ monitoring.yaml           â”œâ”€â”€ controller.yaml
Project C/                        â””â”€â”€ configmap.yaml
â”œâ”€â”€ base/                     
â”‚   â”œâ”€â”€ web.yaml              Project A, B, C/
â”‚   â””â”€â”€ monitoring.yaml       â””â”€â”€ overlays/prod/
                                  â””â”€â”€ kustomization.yaml
                                      components:
                                        - ../../components/monitoring
```

### Component vs Base vs Overlay
```yaml
# Base: Foundation resources
bases:
  - ../base  # Complete application stack

# Overlay: Environment-specific modifications  
resources:
  - ../base  # Inherits everything from base

# Component: Reusable optional functionality
components:
  - ../../components/monitoring  # Add monitoring capability
  - ../../components/logging     # Add logging capability
  - ../../components/security    # Add security policies
```

## ğŸ—ï¸ Component Architecture Patterns

### 1. Single-Purpose Components
```
monitoring/               # Purpose: Add observability
â”œâ”€â”€ kustomization.yaml   # Component definition
â”œâ”€â”€ prometheus.yaml      # Metrics collection
â”œâ”€â”€ grafana.yaml        # Visualization
â””â”€â”€ servicemonitor.yaml # Service discovery

ingress/                # Purpose: Add ingress capability
â”œâ”€â”€ kustomization.yaml  # Component definition
â”œâ”€â”€ nginx-controller.yaml # Controller deployment
â”œâ”€â”€ default-backend.yaml  # Default backend
â””â”€â”€ configmap.yaml      # Configuration
```

### 2. Multi-Tier Components
```
database-stack/         # Purpose: Complete database solution
â”œâ”€â”€ kustomization.yaml  # Component orchestration
â”œâ”€â”€ components/
â”‚   â”œâ”€â”€ postgresql/     # Database engine
â”‚   â”‚   â”œâ”€â”€ kustomization.yaml
â”‚   â”‚   â”œâ”€â”€ statefulset.yaml
â”‚   â”‚   â””â”€â”€ configmap.yaml
â”‚   â”œâ”€â”€ backup/         # Backup solution
â”‚   â”‚   â”œâ”€â”€ kustomization.yaml
â”‚   â”‚   â”œâ”€â”€ cronjob.yaml
â”‚   â”‚   â””â”€â”€ pvc.yaml
â”‚   â””â”€â”€ monitoring/     # Database metrics
â”‚       â”œâ”€â”€ kustomization.yaml
â”‚       â””â”€â”€ servicemonitor.yaml
â””â”€â”€ patches/
    â”œâ”€â”€ production.yaml  # Production-specific patches
    â””â”€â”€ development.yaml # Development patches
```

### 3. Platform Components
```
platform-base/          # Purpose: Organization-wide standards
â”œâ”€â”€ kustomization.yaml  # Platform component
â”œâ”€â”€ security/
â”‚   â”œâ”€â”€ network-policies.yaml
â”‚   â”œâ”€â”€ pod-security.yaml
â”‚   â””â”€â”€ rbac.yaml
â”œâ”€â”€ monitoring/
â”‚   â”œâ”€â”€ basic-metrics.yaml
â”‚   â””â”€â”€ alerting-rules.yaml
â””â”€â”€ governance/
    â”œâ”€â”€ resource-quotas.yaml
    â”œâ”€â”€ limit-ranges.yaml
    â””â”€â”€ policies.yaml
```

## ğŸ¨ Building Component Library

### Component 1: Monitoring Stack
```yaml
# components/monitoring/kustomization.yaml
apiVersion: kustomize.config.k8s.io/v1alpha1
kind: Component

metadata:
  name: monitoring-stack
  annotations:
    component.kustomize.io/version: v1.2.0
    component.kustomize.io/description: "Complete monitoring solution with Prometheus and Grafana"
    component.kustomize.io/maintainer: platform-team@company.com

resources:
  - prometheus-deployment.yaml
  - prometheus-service.yaml
  - prometheus-configmap.yaml
  - grafana-deployment.yaml
  - grafana-service.yaml
  - grafana-configmap.yaml
  - servicemonitor.yaml

# Component labels added to all resources
commonLabels:
  component: monitoring-stack
  version: v1.2.0
  managed-by: platform-team

commonAnnotations:
  component.description: monitoring-stack
  component.version: v1.2.0

# Configurable image versions
images:
  - name: prometheus
    newTag: v2.40.0
  - name: grafana
    newTag: 9.3.0

# Default configuration (can be overridden)
configMapGenerator:
  - name: prometheus-config
    files:
      - prometheus.yml
  - name: grafana-dashboards
    files:
      - kubernetes-dashboard.json
      - application-dashboard.json

# Variables that can be set by consumers
vars:
  - name: PROMETHEUS_RETENTION
    objref:
      kind: ConfigMap
      name: prometheus-config
      apiVersion: v1
    fieldref:
      fieldpath: data.retention
  - name: GRAFANA_ADMIN_PASSWORD
    objref:
      kind: Secret
      name: grafana-admin
      apiVersion: v1
    fieldref:
      fieldpath: data.admin-password
```

### Monitoring Component Resources
```yaml
# components/monitoring/prometheus-deployment.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: prometheus
  labels:
    app.kubernetes.io/name: prometheus
    app.kubernetes.io/component: metrics
spec:
  replicas: 1
  selector:
    matchLabels:
      app.kubernetes.io/name: prometheus
  template:
    metadata:
      labels:
        app.kubernetes.io/name: prometheus
    spec:
      serviceAccountName: prometheus
      containers:
      - name: prometheus
        image: prometheus/prometheus:v2.40.0
        args:
        - '--config.file=/etc/prometheus/prometheus.yml'
        - '--storage.tsdb.path=/prometheus/'
        - '--web.console.libraries=/etc/prometheus/console_libraries'
        - '--web.console.templates=/etc/prometheus/consoles'
        - '--storage.tsdb.retention.time=$(PROMETHEUS_RETENTION)'
        - '--web.enable-lifecycle'
        env:
        - name: PROMETHEUS_RETENTION
          value: "15d"  # Default, can be overridden
        ports:
        - containerPort: 9090
          name: web
        volumeMounts:
        - name: prometheus-config
          mountPath: /etc/prometheus
        - name: prometheus-storage
          mountPath: /prometheus
        resources:
          requests:
            cpu: 500m
            memory: 1Gi
          limits:
            cpu: 1000m
            memory: 2Gi
        livenessProbe:
          httpGet:
            path: /-/healthy
            port: 9090
          initialDelaySeconds: 30
          periodSeconds: 15
        readinessProbe:
          httpGet:
            path: /-/ready
            port: 9090
          initialDelaySeconds: 5
          periodSeconds: 5
      volumes:
      - name: prometheus-config
        configMap:
          name: prometheus-config
      - name: prometheus-storage
        emptyDir: {}

---
# components/monitoring/grafana-deployment.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: grafana
  labels:
    app.kubernetes.io/name: grafana
    app.kubernetes.io/component: visualization
spec:
  replicas: 1
  selector:
    matchLabels:
      app.kubernetes.io/name: grafana
  template:
    metadata:
      labels:
        app.kubernetes.io/name: grafana
    spec:
      containers:
      - name: grafana
        image: grafana/grafana:9.3.0
        env:
        - name: GF_SECURITY_ADMIN_PASSWORD
          valueFrom:
            secretKeyRef:
              name: grafana-admin
              key: admin-password
              optional: true
        - name: GF_SECURITY_ADMIN_PASSWORD
          value: admin  # Fallback default
        - name: GF_INSTALL_PLUGINS
          value: "grafana-piechart-panel,grafana-clock-panel"
        ports:
        - containerPort: 3000
          name: web
        volumeMounts:
        - name: grafana-storage
          mountPath: /var/lib/grafana
        - name: grafana-dashboards
          mountPath: /etc/grafana/provisioning/dashboards
        resources:
          requests:
            cpu: 250m
            memory: 512Mi
          limits:
            cpu: 500m
            memory: 1Gi
        livenessProbe:
          httpGet:
            path: /api/health
            port: 3000
          initialDelaySeconds: 30
          periodSeconds: 30
        readinessProbe:
          httpGet:
            path: /api/health
            port: 3000
          initialDelaySeconds: 5
          periodSeconds: 10
      volumes:
      - name: grafana-storage
        emptyDir: {}
      - name: grafana-dashboards
        configMap:
          name: grafana-dashboards
```

### Component 2: Security Policies
```yaml
# components/security-policies/kustomization.yaml
apiVersion: kustomize.config.k8s.io/v1alpha1
kind: Component

metadata:
  name: security-policies
  annotations:
    component.kustomize.io/version: v2.1.0
    component.kustomize.io/description: "Standard security policies and network controls"

resources:
  - network-policy-default-deny.yaml
  - network-policy-allow-dns.yaml
  - pod-security-policy.yaml
  - rbac-readonly.yaml
  - rbac-developer.yaml

commonLabels:
  component: security-policies
  security-tier: standard

# Patch templates for common security patterns
patches:
  - target:
      kind: Deployment
    patch: |-
      apiVersion: apps/v1
      kind: Deployment
      metadata:
        name: not-used
      spec:
        template:
          spec:
            securityContext:
              runAsNonRoot: true
              runAsUser: 1000
              fsGroup: 2000
            containers:
            - name: not-used
              securityContext:
                allowPrivilegeEscalation: false
                readOnlyRootFilesystem: true
                capabilities:
                  drop:
                  - ALL

# Configuration options
configMapGenerator:
  - name: security-config
    literals:
      - DEFAULT_RUNASUSER=1000
      - DEFAULT_FSGROUP=2000
      - NETWORK_POLICY_ENABLED=true
```

### Security Component Resources
```yaml
# components/security-policies/network-policy-default-deny.yaml
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: default-deny-all
  annotations:
    policy.description: "Default deny all ingress and egress traffic"
spec:
  podSelector: {}
  policyTypes:
  - Ingress
  - Egress

---
# components/security-policies/network-policy-allow-dns.yaml
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-dns-access
  annotations:
    policy.description: "Allow DNS resolution for all pods"
spec:
  podSelector: {}
  policyTypes:
  - Egress
  egress:
  - to: []
    ports:
    - protocol: UDP
      port: 53
    - protocol: TCP
      port: 53

---
# components/security-policies/pod-security-policy.yaml
apiVersion: policy/v1beta1
kind: PodSecurityPolicy
metadata:
  name: restricted-psp
  annotations:
    seccomp.security.alpha.kubernetes.io/allowedProfileNames: 'docker/default,runtime/default'
    apparmor.security.beta.kubernetes.io/allowedProfileNames: 'runtime/default'
    seccomp.security.alpha.kubernetes.io/defaultProfileName:  'runtime/default'
    apparmor.security.beta.kubernetes.io/defaultProfileName:  'runtime/default'
spec:
  privileged: false
  allowPrivilegeEscalation: false
  requiredDropCapabilities:
    - ALL
  volumes:
    - 'configMap'
    - 'emptyDir'
    - 'projected'
    - 'secret'
    - 'downwardAPI'
    - 'persistentVolumeClaim'
  runAsUser:
    rule: 'MustRunAsNonRoot'
  seLinux:
    rule: 'RunAsAny'
  fsGroup:
    rule: 'RunAsAny'
```

### Component 3: Database Stack
```yaml
# components/postgresql-stack/kustomization.yaml
apiVersion: kustomize.config.k8s.io/v1alpha1
kind: Component

metadata:
  name: postgresql-stack
  annotations:
    component.kustomize.io/version: v3.0.0
    component.kustomize.io/description: "Production-ready PostgreSQL with backup and monitoring"

resources:
  - postgresql-statefulset.yaml
  - postgresql-service.yaml
  - postgresql-headless-service.yaml
  - backup-cronjob.yaml
  - pgbouncer-deployment.yaml
  - pgbouncer-service.yaml

components:
  - ../monitoring  # Include monitoring component

commonLabels:
  component: postgresql-stack
  database-engine: postgresql
  backup-enabled: "true"

# Database configuration
configMapGenerator:
  - name: postgresql-config
    files:
      - postgresql.conf
      - pg_hba.conf
  - name: backup-scripts
    files:
      - backup.sh
      - restore.sh

secretGenerator:
  - name: postgresql-credentials
    literals:
      - postgres-password=$(POSTGRES_PASSWORD)
      - replication-password=$(REPLICATION_PASSWORD)
    type: Opaque

# Configurable options
images:
  - name: postgresql
    newTag: "14.6"
  - name: pgbouncer  
    newTag: "1.17"
  - name: postgres-backup
    newTag: "14"

vars:
  - name: POSTGRES_PASSWORD
    objref:
      kind: Secret
      name: postgresql-credentials
      apiVersion: v1
    fieldref:
      fieldpath: data.postgres-password
  - name: DATABASE_SIZE
    objref:
      kind: ConfigMap
      name: postgresql-config
      apiVersion: v1
    fieldref:
      fieldpath: data.storage-size

# Environment-specific patches
patches:
  - target:
      kind: StatefulSet
      name: postgresql
    patch: |-
      apiVersion: apps/v1
      kind: StatefulSet
      metadata:
        name: postgresql
      spec:
        volumeClaimTemplates:
        - metadata:
            name: postgresql-storage
          spec:
            accessModes: [ "ReadWriteOnce" ]
            resources:
              requests:
                storage: $(DATABASE_SIZE)
```

### Component 4: Ingress Controller
```yaml
# components/ingress-nginx/kustomization.yaml
apiVersion: kustomize.config.k8s.io/v1alpha1
kind: Component

metadata:
  name: ingress-nginx
  annotations:
    component.kustomize.io/version: v4.1.0
    component.kustomize.io/description: "NGINX Ingress Controller with SSL termination"

resources:
  - namespace.yaml
  - controller-deployment.yaml
  - controller-service.yaml
  - controller-configmap.yaml
  - default-backend.yaml
  - rbac.yaml

commonLabels:
  component: ingress-nginx
  ingress-class: nginx

# Ingress controller configuration
configMapGenerator:
  - name: nginx-configuration
    literals:
      - use-forwarded-headers=true
      - compute-full-forwarded-for=true
      - proxy-real-ip-cidr=10.0.0.0/8
      - ssl-protocols=TLSv1.2 TLSv1.3
      - ssl-ciphers=ECDHE-RSA-AES128-GCM-SHA256:ECDHE-RSA-AES256-GCM-SHA384

images:
  - name: ingress-nginx-controller
    newTag: v1.5.1
  - name: defaultbackend
    newTag: "1.5"

# Variables for customization
vars:
  - name: INGRESS_CLASS
    objref:
      kind: ConfigMap
      name: nginx-configuration
      apiVersion: v1
    fieldref:
      fieldpath: data.ingress-class
  - name: SSL_PROTOCOLS
    objref:
      kind: ConfigMap
      name: nginx-configuration
      apiVersion: v1
    fieldref:
      fieldpath: data.ssl-protocols
```

## ğŸ”§ Advanced Component Patterns

### Conditional Component Inclusion
```yaml
# Example: Include monitoring only in production
# overlays/production/kustomization.yaml
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

resources:
  - ../../base

# Conditional components based on environment
components:
  - ../../components/monitoring        # Always include
  - ../../components/security-policies # Always include
  - ../../components/postgresql-stack  # Production database
  # Development uses external managed database

# Environment-specific configuration
configMapGenerator:
  - name: environment-config
    behavior: merge
    literals:
      - ENVIRONMENT=production
      - MONITORING_ENABLED=true
      - DATABASE_TYPE=internal
```

### Component Composition
```yaml
# components/complete-stack/kustomization.yaml
apiVersion: kustomize.config.k8s.io/v1alpha1
kind: Component

metadata:
  name: complete-application-stack
  annotations:
    component.kustomize.io/description: "Complete application stack with all dependencies"

# Compose multiple components
components:
  - ../postgresql-stack      # Database layer
  - ../monitoring           # Observability layer  
  - ../ingress-nginx        # Ingress layer
  - ../security-policies    # Security layer

# Override configurations for the complete stack
patches:
  - target:
      kind: ConfigMap
      name: postgresql-config
    patch: |-
      apiVersion: v1
      kind: ConfigMap
      metadata:
        name: postgresql-config
      data:
        max_connections: "200"  # Higher for complete stack
        
  - target:
      kind: ConfigMap
      name: nginx-configuration
    patch: |-
      apiVersion: v1
      kind: ConfigMap
      metadata:
        name: nginx-configuration
      data:
        worker-processes: "auto"
        worker-connections: "1024"
```

### Parameterized Components
```yaml
# components/redis-cache/kustomization.yaml
apiVersion: kustomize.config.k8s.io/v1alpha1
kind: Component

metadata:
  name: redis-cache
  
# Use replacements for parameterization
replacements:
  - source:
      kind: ConfigMap
      name: redis-config
      fieldPath: data.memory-limit
    targets:
      - select:
          kind: Deployment
          name: redis
        fieldPaths:
          - spec.template.spec.containers.[name=redis].args.[=--maxmemory]
        options:
          index: 1

  - source:
      kind: ConfigMap
      name: redis-config
      fieldPath: data.instance-count
    targets:
      - select:
          kind: Deployment
          name: redis
        fieldPaths:
          - spec.replicas

configMapGenerator:
  - name: redis-config
    literals:
      - memory-limit=512mb
      - instance-count=1
      - eviction-policy=allkeys-lru
```

## ğŸ“š Component Library Organization

### Directory Structure
```
components/
â”œâ”€â”€ README.md                 # Component library documentation
â”œâ”€â”€ index.yaml               # Component catalog
â”œâ”€â”€ infrastructure/          # Infrastructure components
â”‚   â”œâ”€â”€ monitoring/
â”‚   â”œâ”€â”€ logging/
â”‚   â”œâ”€â”€ security/
â”‚   â””â”€â”€ networking/
â”œâ”€â”€ databases/               # Database components
â”‚   â”œâ”€â”€ postgresql/
â”‚   â”œâ”€â”€ mysql/
â”‚   â”œâ”€â”€ redis/
â”‚   â””â”€â”€ mongodb/
â”œâ”€â”€ applications/           # Application-specific components
â”‚   â”œâ”€â”€ web-frontend/
â”‚   â”œâ”€â”€ api-backend/
â”‚   â””â”€â”€ message-queue/
â””â”€â”€ platform/              # Platform-wide components
    â”œâ”€â”€ base-policies/
    â”œâ”€â”€ standard-labels/
    â””â”€â”€ common-configs/
```

### Component Catalog
```yaml
# components/index.yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: component-catalog
data:
  catalog.yaml: |
    components:
      monitoring:
        version: v1.2.0
        description: "Prometheus and Grafana monitoring stack"
        maintainer: platform-team@company.com
        dependencies: []
        path: infrastructure/monitoring
        tags: [observability, prometheus, grafana]
        
      postgresql-stack:
        version: v3.0.0
        description: "Production PostgreSQL with backup and monitoring"
        maintainer: database-team@company.com
        dependencies: [monitoring]
        path: databases/postgresql
        tags: [database, postgresql, backup]
        
      security-policies:
        version: v2.1.0
        description: "Standard security policies and network controls"
        maintainer: security-team@company.com
        dependencies: []
        path: platform/security
        tags: [security, network-policy, rbac]
        
      ingress-nginx:
        version: v4.1.0
        description: "NGINX Ingress Controller with SSL termination"
        maintainer: networking-team@company.com
        dependencies: []
        path: infrastructure/networking/ingress-nginx
        tags: [ingress, nginx, ssl]
```

### Component Documentation Template
```markdown
# Component Name: PostgreSQL Stack

## ğŸ“– Overview
Production-ready PostgreSQL deployment with backup, monitoring, and connection pooling.

## ğŸ”§ Configuration Options
| Variable | Description | Default | Required |
|----------|-------------|---------|----------|
| POSTGRES_PASSWORD | Database password | - | Yes |
| DATABASE_SIZE | Storage size | 10Gi | No |
| BACKUP_ENABLED | Enable backups | true | No |
| MONITORING_ENABLED | Enable monitoring | true | No |

## ğŸ“¦ Dependencies
- monitoring (optional): For database metrics
- security-policies (recommended): For network policies

## ğŸš€ Usage Examples

### Basic Usage
```yaml
# kustomization.yaml
components:
  - ../../components/postgresql-stack
```

### Advanced Usage
```yaml
# kustomization.yaml
components:
  - ../../components/postgresql-stack
  - ../../components/monitoring

configMapGenerator:
  - name: postgresql-config
    behavior: merge
    literals:
      - storage-size=50Gi
      - max_connections=300
```

## ğŸ§ª Testing
```bash
# Validate component
kubectl kustomize components/postgresql-stack --dry-run=client

# Test with consumer
kubectl kustomize overlays/production --dry-run=client
```
```

## ğŸ”„ Component Versioning and Lifecycle

### Semantic Versioning for Components
```yaml
# Component version scheme
metadata:
  annotations:
    component.kustomize.io/version: v2.1.3
    component.kustomize.io/api-version: v1beta1
    component.kustomize.io/compatibility: ">=v1.0.0,<v3.0.0"

# Version changelog
component.kustomize.io/changelog: |
  v2.1.3:
    - Fixed: Security context not applied to init containers
    - Updated: PostgreSQL image to 14.6
  v2.1.2:
    - Added: Support for custom backup retention
    - Fixed: PVC size expansion issue
  v2.1.0:
    - Added: PgBouncer connection pooling
    - Breaking: Removed legacy backup method
```

### Component Migration Guide
```yaml
# Migration between component versions
# components/postgresql-stack/MIGRATION.md

## v2.x to v3.x Migration

### Breaking Changes
1. **Backup Configuration**: Moved from ConfigMap to Secret
2. **Service Names**: Changed from `postgres` to `postgresql`
3. **Volume Claims**: Now uses StatefulSet volume claim templates

### Migration Steps
1. Export existing data:
   ```bash
   kubectl exec postgresql-0 -- pg_dumpall > backup.sql
   ```

2. Update component reference:
   ```yaml
   # Before
   components:
     - ../../components/postgresql-stack  # v2.x
   
   # After  
   components:
     - ../../components/postgresql-stack  # v3.x
   ```

3. Update configuration format:
   ```yaml
   # Before (v2.x)
   configMapGenerator:
     - name: postgres-config
   
   # After (v3.x)
   configMapGenerator:
     - name: postgresql-config
   ```
```

## âš¡ Performance Optimization

### Component Caching Strategy
```bash
#!/bin/bash
# scripts/component-cache.sh

# Build component cache for faster builds
COMPONENT_DIR="components"
CACHE_DIR=".kustomize-cache"

mkdir -p "$CACHE_DIR"

for component in $(find "$COMPONENT_DIR" -name "kustomization.yaml" -exec dirname {} \;); do
    component_name=$(basename "$component")
    echo "Caching component: $component_name"
    
    # Pre-validate and cache component
    kubectl kustomize "$component" > "$CACHE_DIR/$component_name.yaml" || {
        echo "âŒ Failed to cache $component_name"
        exit 1
    }
done

echo "âœ… Component cache built successfully"
```

### Component Build Optimization
```yaml
# .kustomize/optimization.yaml
# Optimization configurations for large component libraries

buildOptimizations:
  parallelBuilds: true
  cacheEnabled: true
  validateOnBuild: false  # Skip validation for trusted components
  
cacheConfig:
  ttl: 24h
  invalidateOnChange: true
  sharedCache: true
```

## ğŸ¯ Best Practices Summary

### âœ… Component Design Principles
1. **Single Responsibility**: Each component should have one clear purpose
2. **Composability**: Components should work well together
3. **Configurability**: Provide sensible defaults with override options
4. **Documentation**: Clear usage examples and configuration options
5. **Versioning**: Use semantic versioning for compatibility

### âœ… Component Organization
```
Good Component Structure:
components/monitoring/
â”œâ”€â”€ kustomization.yaml      # Component definition
â”œâ”€â”€ README.md              # Documentation
â”œâ”€â”€ CHANGELOG.md           # Version history
â”œâ”€â”€ examples/              # Usage examples
â”œâ”€â”€ tests/                 # Validation tests
â””â”€â”€ resources/             # Kubernetes resources
    â”œâ”€â”€ prometheus.yaml
    â”œâ”€â”€ grafana.yaml
    â””â”€â”€ servicemonitor.yaml
```

### âœ… Consumer Best Practices
```yaml
# Good: Explicit component usage
components:
  - ../../components/monitoring
  - ../../components/security-policies

# Good: Override component defaults
configMapGenerator:
  - name: prometheus-config
    behavior: merge
    literals:
      - retention=30d

# Good: Component-specific patches
patches:
  - target:
      kind: Deployment
      name: prometheus
      labelSelector: component=monitoring-stack
    patch: |-
      # Patch content
```

## ğŸ“ Summary

### Key Concepts Learned
1. **Component Architecture**: Reusable, composable configuration units
2. **Component Library**: Organized collection of standardized components
3. **Component Versioning**: Semantic versioning and lifecycle management
4. **Advanced Patterns**: Composition, parameterization, and conditional inclusion

### Benefits Achieved
- **Reusability**: Share components across projects and teams
- **Consistency**: Standardized configurations reduce errors
- **Maintainability**: Update once, apply everywhere
- **Modularity**: Build complex systems from simple, tested parts

Components represent the pinnacle of Kustomize's power, enabling organizations to build reusable, maintainable infrastructure as code that scales across teams and projects.

## â¡ï¸ Next Steps
Now that you understand how to create reusable components, proceed to [9. Including-Components-in-Overlays.md](9.%20Including-Components-in-Overlays.md) to learn how to effectively integrate components into your overlay configurations and manage complex component dependencies.