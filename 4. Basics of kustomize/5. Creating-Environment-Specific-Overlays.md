# 5. Creating Environment-Specific Overlays (dev/staging/prod)

## ðŸŽ¯ Learning Objectives
- [ ] Design environment-specific overlay architectures
- [ ] Create development, staging, and production configurations
- [ ] Implement environment-appropriate resource scaling and security
- [ ] Master configuration management across environments
- [ ] Practice real-world multi-environment deployment scenarios

## ðŸ“‹ Environment Strategy Overview

### Multi-Environment Architecture
```
Environment Hierarchy and Progression:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Base Configuration                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ â€¢ Common Kubernetes resources                   â”‚    â”‚
â”‚  â”‚ â€¢ Default resource limits                       â”‚    â”‚
â”‚  â”‚ â€¢ Base application configuration               â”‚    â”‚
â”‚  â”‚ â€¢ Standard health checks                        â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚         â”‚         â”‚
          â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â” â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â” â”Œâ”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”
          â”‚ Dev      â”‚ â”‚Staging â”‚ â”‚Productionâ”‚
          â”‚Overlay   â”‚ â”‚Overlay â”‚ â”‚ Overlay  â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Environment Characteristics:
Development:     Resource-light, debugging enabled, rapid iteration
Staging:         Production-like, testing focus, automated deployment
Production:      High availability, security hardened, monitored
```

### Directory Structure
```
project/
â”œâ”€â”€ base/                          # Common base configuration
â”‚   â”œâ”€â”€ kustomization.yaml
â”‚   â”œâ”€â”€ deployment.yaml
â”‚   â”œâ”€â”€ service.yaml
â”‚   â”œâ”€â”€ configmap.yaml
â”‚   â””â”€â”€ serviceaccount.yaml
â”‚
â”œâ”€â”€ overlays/
â”‚   â”œâ”€â”€ development/               # Development environment
â”‚   â”‚   â”œâ”€â”€ kustomization.yaml
â”‚   â”‚   â”œâ”€â”€ dev-config-patch.yaml
â”‚   â”‚   â”œâ”€â”€ dev-ingress.yaml
â”‚   â”‚   â””â”€â”€ dev-secrets.yaml
â”‚   â”‚
â”‚   â”œâ”€â”€ staging/                   # Staging environment
â”‚   â”‚   â”œâ”€â”€ kustomization.yaml
â”‚   â”‚   â”œâ”€â”€ staging-patch.yaml
â”‚   â”‚   â”œâ”€â”€ staging-hpa.yaml
â”‚   â”‚   â””â”€â”€ staging-monitoring.yaml
â”‚   â”‚
â”‚   â””â”€â”€ production/                # Production environment
â”‚       â”œâ”€â”€ kustomization.yaml
â”‚       â”œâ”€â”€ prod-patches/
â”‚       â”‚   â”œâ”€â”€ resources.yaml
â”‚       â”‚   â”œâ”€â”€ security.yaml
â”‚       â”‚   â””â”€â”€ monitoring.yaml
â”‚       â”œâ”€â”€ prod-ingress.yaml
â”‚       â”œâ”€â”€ prod-secrets.yaml
â”‚       â”œâ”€â”€ network-policies.yaml
â”‚       â””â”€â”€ backup-cronjob.yaml
â”‚
â””â”€â”€ environments/                  # Optional: environment templates
    â”œâ”€â”€ non-production/
    â”‚   â””â”€â”€ kustomization.yaml
    â””â”€â”€ production/
        â””â”€â”€ kustomization.yaml
```

## ðŸ› ï¸ Development Environment

### Development Overlay Configuration
```yaml
# overlays/development/kustomization.yaml
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

metadata:
  name: webapp-development
  annotations:
    environment: development
    tier: non-production

# Base configuration reference
resources:
  - ../../base
  - dev-ingress.yaml              # Development ingress
  - dev-secrets.yaml              # Development secrets (non-sensitive)

# Development-specific naming
namePrefix: dev-
nameSuffix: -v1

# Development labels and annotations
commonLabels:
  environment: development
  tier: non-production
  managed-by: kustomize

commonAnnotations:
  environment: development
  cost-center: development
  auto-cleanup: "true"

# Development image configuration
images:
  - name: webapp
    newTag: dev-latest            # Use latest development image
  - name: redis
    newTag: 7-alpine              # Lightweight Redis for dev

# Development configuration
configMapGenerator:
  - name: app-config
    behavior: merge
    literals:
      # Development-specific settings
      - LOG_LEVEL=DEBUG
      - DEBUG_MODE=true
      - HOT_RELOAD=true
      - CORS_ENABLED=true
      - RATE_LIMITING=false
      - CACHE_TTL=60
      
      # Development database
      - DATABASE_HOST=dev-postgres.internal
      - DATABASE_NAME=webapp_dev
      - DATABASE_POOL_MIN=1
      - DATABASE_POOL_MAX=5
      
      # Development services
      - REDIS_HOST=dev-redis.internal
      - ELASTICSEARCH_URL=http://dev-elasticsearch:9200
      
      # Feature flags for development
      - FEATURE_NEW_UI=true
      - FEATURE_BETA_FEATURES=true
      - FEATURE_ANALYTICS=false

secretGenerator:
  - name: app-secrets
    literals:
      # Non-sensitive development secrets
      - database-password=devpassword123
      - jwt-secret=dev-jwt-secret
      - api-key=dev-api-key

# Development resource scaling
replicas:
  - name: webapp
    count: 1                      # Single replica for development

# Development patches
patches:
  - path: dev-config-patch.yaml
    target:
      kind: Deployment
      name: webapp
```

### Development Resource Patch
```yaml
# overlays/development/dev-config-patch.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: webapp
spec:
  strategy:
    type: RollingUpdate
    rollingUpdate:
      maxSurge: 1
      maxUnavailable: 0          # Ensure availability even with 1 replica
  template:
    metadata:
      annotations:
        # Development annotations for debugging
        debug.alpha.kubernetes.io/enabled: "true"
        config.linkerd.io/proxy-log-level: debug
    spec:
      # Development-friendly settings
      restartPolicy: Always
      terminationGracePeriodSeconds: 10  # Faster restarts
      
      containers:
      - name: webapp
        env:
        - name: ENV
          value: development
        - name: NODE_ENV
          value: development
        - name: DEVELOPMENT_MODE
          value: "true"
        - name: HOT_RELOAD_PORT
          value: "35729"
        
        # Development resource limits (resource-efficient)
        resources:
          requests:
            cpu: 50m             # Minimal CPU request
            memory: 128Mi        # Minimal memory request
          limits:
            cpu: 500m            # Allow bursting for development
            memory: 512Mi
        
        # Development-optimized probes
        livenessProbe:
          httpGet:
            path: /health
            port: 8080
          initialDelaySeconds: 10  # Quick startup
          periodSeconds: 30
          timeoutSeconds: 5
          failureThreshold: 5      # More tolerant of failures
          
        readinessProbe:
          httpGet:
            path: /ready
            port: 8080
          initialDelaySeconds: 5
          periodSeconds: 10
          timeoutSeconds: 3
          failureThreshold: 3
        
        # Development volume mounts for debugging
        volumeMounts:
        - name: dev-logs
          mountPath: /app/logs
        - name: dev-config
          mountPath: /app/config/development
      
      # Development-specific volumes
      volumes:
      - name: dev-logs
        emptyDir: {}
      - name: dev-config
        configMap:
          name: dev-config
```

### Development Ingress
```yaml
# overlays/development/dev-ingress.yaml
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: webapp-ingress
  annotations:
    nginx.ingress.kubernetes.io/rewrite-target: /
    nginx.ingress.kubernetes.io/cors-allow-origin: "*"
    nginx.ingress.kubernetes.io/cors-allow-methods: "GET, POST, PUT, DELETE, OPTIONS"
    nginx.ingress.kubernetes.io/cors-allow-headers: "DNT,X-CustomHeader,Keep-Alive,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Authorization"
    nginx.ingress.kubernetes.io/enable-cors: "true"
    cert-manager.io/cluster-issuer: "letsencrypt-staging"  # Staging certificates
spec:
  tls:
  - hosts:
    - dev-webapp.company.com
    - dev-api.company.com
    secretName: webapp-dev-tls
  rules:
  - host: dev-webapp.company.com
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: webapp-service
            port:
              number: 80
  - host: dev-api.company.com
    http:
      paths:
      - path: /api
        pathType: Prefix
        backend:
          service:
            name: webapp-service
            port:
              number: 80
```

## ðŸ§ª Staging Environment

### Staging Overlay Configuration
```yaml
# overlays/staging/kustomization.yaml
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

metadata:
  name: webapp-staging
  annotations:
    environment: staging
    tier: non-production

resources:
  - ../../base
  - staging-hpa.yaml             # Horizontal Pod Autoscaler
  - staging-monitoring.yaml      # Basic monitoring
  - staging-ingress.yaml         # Staging ingress configuration

namePrefix: staging-
nameSuffix: -v2

commonLabels:
  environment: staging
  tier: non-production
  stability: beta

commonAnnotations:
  environment: staging
  test-automation: enabled
  performance-testing: enabled

# Staging image tags (specific versions for testing)
images:
  - name: webapp
    newTag: v2.1.0-rc.3          # Release candidate
  - name: redis
    newTag: 7.0.8                # Stable Redis version

# Staging configuration (production-like)
configMapGenerator:
  - name: app-config
    behavior: replace
    literals:
      # Staging-specific settings
      - LOG_LEVEL=INFO
      - DEBUG_MODE=false
      - PERFORMANCE_MONITORING=true
      - METRICS_ENABLED=true
      - CACHE_TTL=300
      
      # Staging database (production-like)
      - DATABASE_HOST=staging-postgres.internal
      - DATABASE_NAME=webapp_staging
      - DATABASE_POOL_MIN=2
      - DATABASE_POOL_MAX=10
      
      # Staging services
      - REDIS_HOST=staging-redis.internal
      - ELASTICSEARCH_URL=http://staging-elasticsearch:9200
      
      # Feature flags for staging testing
      - FEATURE_NEW_UI=true
      - FEATURE_BETA_FEATURES=true
      - FEATURE_ANALYTICS=true
      - FEATURE_A_B_TESTING=true

secretGenerator:
  - name: app-secrets
    files:
      # Staging secrets from files (more secure)
      - database-password=secrets/staging-db-password
      - jwt-secret=secrets/staging-jwt-secret
    literals:
      - api-key=staging-api-key-placeholder

# Staging resource scaling
replicas:
  - name: webapp
    count: 3                     # Multiple replicas for load testing

patches:
  - path: staging-patch.yaml
    target:
      kind: Deployment
      name: webapp
```

### Staging Resource Patch
```yaml
# overlays/staging/staging-patch.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: webapp
  labels:
    version: staging-v2.1.0
spec:
  strategy:
    type: RollingUpdate
    rollingUpdate:
      maxSurge: 1
      maxUnavailable: 1          # Allow some unavailability for testing
  template:
    metadata:
      annotations:
        prometheus.io/scrape: "true"
        prometheus.io/port: "9090"
    spec:
      terminationGracePeriodSeconds: 30
      
      containers:
      - name: webapp
        env:
        - name: ENV
          value: staging
        - name: NODE_ENV
          value: staging
        - name: PERFORMANCE_TESTING
          value: "true"
        - name: LOAD_TESTING_ENDPOINT
          value: "/load-test"
        
        # Staging resources (production-like but smaller)
        resources:
          requests:
            cpu: 200m            # Higher than dev
            memory: 256Mi
          limits:
            cpu: 1000m           # Allow higher CPU for load testing
            memory: 1Gi
        
        # Production-like probes but more tolerant
        livenessProbe:
          httpGet:
            path: /health
            port: 8080
          initialDelaySeconds: 30
          periodSeconds: 15
          timeoutSeconds: 10
          failureThreshold: 3
          
        readinessProbe:
          httpGet:
            path: /ready
            port: 8080
          initialDelaySeconds: 15
          periodSeconds: 10
          timeoutSeconds: 5
          failureThreshold: 2
        
        # Monitoring and metrics ports
        ports:
        - containerPort: 8080
          name: http
        - containerPort: 9090
          name: metrics
        
        volumeMounts:
        - name: staging-config
          mountPath: /app/config/staging
          readOnly: true
      
      volumes:
      - name: staging-config
        configMap:
          name: staging-config
```

### Staging HPA Configuration
```yaml
# overlays/staging/staging-hpa.yaml
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: webapp-hpa
  labels:
    app: webapp
    environment: staging
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: webapp
  minReplicas: 2                 # Minimum for load testing
  maxReplicas: 10                # Allow scaling for performance tests
  metrics:
  - type: Resource
    resource:
      name: cpu
      target:
        type: Utilization
        averageUtilization: 70   # Trigger scaling at 70% CPU
  - type: Resource
    resource:
      name: memory
      target:
        type: Utilization
        averageUtilization: 80   # Trigger scaling at 80% memory
  behavior:
    scaleDown:
      stabilizationWindowSeconds: 300  # Wait 5 minutes before scaling down
      policies:
      - type: Percent
        value: 25                # Scale down by 25% at a time
        periodSeconds: 60
    scaleUp:
      stabilizationWindowSeconds: 60   # Quick scaling up for tests
      policies:
      - type: Percent
        value: 100               # Double the replicas quickly
        periodSeconds: 60
```

## ðŸ­ Production Environment

### Production Overlay Configuration
```yaml
# overlays/production/kustomization.yaml
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

metadata:
  name: webapp-production
  annotations:
    environment: production
    tier: production
    backup-policy: daily
    monitoring-tier: critical

resources:
  - ../../base
  - prod-ingress.yaml           # Production ingress with TLS
  - network-policies.yaml       # Network security policies
  - backup-cronjob.yaml        # Automated backups
  - pod-disruption-budget.yaml  # Pod disruption budget

# Production naming (clean, no prefixes)
commonLabels:
  environment: production
  tier: production
  criticality: high
  backup: enabled

commonAnnotations:
  environment: production
  backup-schedule: "0 2 * * *"
  monitoring-alerts: critical
  sla-tier: gold

# Production images (specific, tested versions)
images:
  - name: webapp
    newTag: v2.1.0              # Tested release version
  - name: redis
    newTag: 7.0.8               # Stable version
  - name: postgres
    newTag: 14.6                # LTS version

# Production configuration
configMapGenerator:
  - name: app-config
    behavior: replace
    literals:
      # Production settings
      - LOG_LEVEL=WARN
      - DEBUG_MODE=false
      - PRODUCTION_MODE=true
      - METRICS_ENABLED=true
      - HEALTH_CHECKS_ENABLED=true
      - CACHE_TTL=3600
      
      # Production database
      - DATABASE_HOST=prod-postgres-primary.internal
      - DATABASE_REPLICA_HOST=prod-postgres-replica.internal
      - DATABASE_NAME=webapp_prod
      - DATABASE_POOL_MIN=5
      - DATABASE_POOL_MAX=50
      - DATABASE_SSL_MODE=require
      
      # Production services
      - REDIS_HOST=prod-redis-cluster.internal
      - ELASTICSEARCH_URL=https://prod-elasticsearch:9200
      
      # Production feature flags (stable features only)
      - FEATURE_NEW_UI=true
      - FEATURE_BETA_FEATURES=false
      - FEATURE_ANALYTICS=true
      - FEATURE_A_B_TESTING=false

secretGenerator:
  - name: app-secrets
    files:
      # Production secrets from secure files
      - database-password=secrets/prod-db-password
      - database-ssl-cert=secrets/prod-db-ssl-cert
      - jwt-secret=secrets/prod-jwt-secret
      - tls-cert=secrets/prod-tls-cert
      - tls-key=secrets/prod-tls-key
      - external-api-key=secrets/prod-external-api-key

# Production scaling
replicas:
  - name: webapp
    count: 5                    # High availability replicas

# Production patches
patches:
  - path: prod-patches/resources.yaml
    target:
      kind: Deployment
      name: webapp
  - path: prod-patches/security.yaml
    target:
      kind: Deployment
      name: webapp
  - path: prod-patches/monitoring.yaml
    target:
      kind: Deployment
      name: webapp
```

### Production Resource Patch
```yaml
# overlays/production/prod-patches/resources.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: webapp
  labels:
    version: production-v2.1.0
    backup: "true"
spec:
  strategy:
    type: RollingUpdate
    rollingUpdate:
      maxSurge: 2               # Allow 2 extra pods during update
      maxUnavailable: 1         # Minimize downtime
  template:
    metadata:
      annotations:
        prometheus.io/scrape: "true"
        prometheus.io/port: "9090"
        backup.velero.io/backup-volumes: data-volume
    spec:
      terminationGracePeriodSeconds: 60  # Graceful shutdown
      
      # Production affinity rules
      affinity:
        podAntiAffinity:
          preferredDuringSchedulingIgnoredDuringExecution:
          - weight: 100
            podAffinityTerm:
              labelSelector:
                matchExpressions:
                - key: app
                  operator: In
                  values:
                  - webapp
              topologyKey: kubernetes.io/hostname
      
      containers:
      - name: webapp
        env:
        - name: ENV
          value: production
        - name: NODE_ENV
          value: production
        - name: JAVA_OPTS
          value: "-Xmx2g -XX:+UseG1GC -XX:MaxGCPauseMillis=200"
        
        # Production resource allocation
        resources:
          requests:
            cpu: 1000m          # Guaranteed CPU
            memory: 2Gi         # Guaranteed memory
          limits:
            cpu: 2000m          # CPU limit
            memory: 4Gi         # Memory limit
        
        # Production-grade health checks
        livenessProbe:
          httpGet:
            path: /health
            port: 8080
          initialDelaySeconds: 60  # Allow startup time
          periodSeconds: 30
          timeoutSeconds: 10
          failureThreshold: 3
          
        readinessProbe:
          httpGet:
            path: /ready
            port: 8080
          initialDelaySeconds: 30
          periodSeconds: 10
          timeoutSeconds: 5
          failureThreshold: 2
        
        # Production startup probe
        startupProbe:
          httpGet:
            path: /startup
            port: 8080
          initialDelaySeconds: 10
          periodSeconds: 10
          timeoutSeconds: 5
          failureThreshold: 30
        
        # Production ports
        ports:
        - containerPort: 8080
          name: http
        - containerPort: 8443
          name: https
        - containerPort: 9090
          name: metrics
        
        # Production volume mounts
        volumeMounts:
        - name: prod-config
          mountPath: /app/config/production
          readOnly: true
        - name: prod-secrets
          mountPath: /app/secrets
          readOnly: true
        - name: data-volume
          mountPath: /app/data
        - name: logs-volume
          mountPath: /app/logs
      
      volumes:
      - name: prod-config
        configMap:
          name: prod-config
      - name: prod-secrets
        secret:
          secretName: app-secrets
      - name: data-volume
        persistentVolumeClaim:
          claimName: webapp-data-pvc
      - name: logs-volume
        persistentVolumeClaim:
          claimName: webapp-logs-pvc
```

### Production Security Patch
```yaml
# overlays/production/prod-patches/security.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: webapp
spec:
  template:
    spec:
      # Production security context
      securityContext:
        runAsNonRoot: true
        runAsUser: 1000
        runAsGroup: 1000
        fsGroup: 2000
        fsGroupChangePolicy: "OnRootMismatch"
      
      containers:
      - name: webapp
        securityContext:
          # Container-level security
          allowPrivilegeEscalation: false
          readOnlyRootFilesystem: true
          runAsNonRoot: true
          runAsUser: 1000
          runAsGroup: 1000
          capabilities:
            drop:
            - ALL
            add:
            - NET_BIND_SERVICE  # Allow binding to privileged ports
        
        # Environment variables from secrets
        envFrom:
        - secretRef:
            name: app-secrets
        
        env:
        - name: DATABASE_PASSWORD
          valueFrom:
            secretKeyRef:
              name: app-secrets
              key: database-password
        - name: JWT_SECRET
          valueFrom:
            secretKeyRef:
              name: app-secrets
              key: jwt-secret
        
        # Additional security volume mounts
        volumeMounts:
        - name: tmp-volume
          mountPath: /tmp
        - name: var-cache
          mountPath: /var/cache
        - name: var-run
          mountPath: /var/run
      
      volumes:
      - name: tmp-volume
        emptyDir: {}
      - name: var-cache
        emptyDir: {}
      - name: var-run
        emptyDir: {}
```

### Production Network Policies
```yaml
# overlays/production/network-policies.yaml
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: webapp-network-policy
  labels:
    app: webapp
    environment: production
spec:
  podSelector:
    matchLabels:
      app: webapp
  policyTypes:
  - Ingress
  - Egress
  ingress:
  - from:
    - namespaceSelector:
        matchLabels:
          name: ingress-nginx
    - podSelector:
        matchLabels:
          app: monitoring
    ports:
    - protocol: TCP
      port: 8080
    - protocol: TCP
      port: 9090
  egress:
  - to:
    - namespaceSelector:
        matchLabels:
          name: database
    ports:
    - protocol: TCP
      port: 5432
  - to:
    - namespaceSelector:
        matchLabels:
          name: cache
    ports:
    - protocol: TCP
      port: 6379
  - to: []
    ports:
    - protocol: TCP
      port: 53
    - protocol: UDP
      port: 53
```

## ðŸ“Š Environment Comparison

### Resource Allocation Comparison
```yaml
# Resource allocation across environments
Environment    | Replicas | CPU Request | Memory Request | CPU Limit | Memory Limit
---------------|----------|-------------|----------------|-----------|-------------
Development    |    1     |    50m      |     128Mi      |   500m    |    512Mi
Staging        |    3     |   200m      |     256Mi      |  1000m    |     1Gi
Production     |    5     |  1000m      |      2Gi       |  2000m    |     4Gi

# Feature flags across environments
Feature        | Development | Staging | Production
---------------|-------------|---------|------------
DEBUG_MODE     |    true     |  false  |   false
HOT_RELOAD     |    true     |  false  |   false
NEW_UI         |    true     |  true   |   true
BETA_FEATURES  |    true     |  true   |   false
ANALYTICS      |   false     |  true   |   true
A_B_TESTING    |   false     |  true   |   false
```

### Configuration Validation
```bash
# Validate all environments
kubectl kustomize overlays/development --dry-run=client
kubectl kustomize overlays/staging --dry-run=client
kubectl kustomize overlays/production --dry-run=client

# Compare configurations
kubectl kustomize overlays/development > dev.yaml
kubectl kustomize overlays/staging > staging.yaml
kubectl kustomize overlays/production > prod.yaml

# Extract specific configurations for comparison
yq e '.spec.replicas' dev.yaml staging.yaml prod.yaml
yq e '.spec.template.spec.containers[0].resources' dev.yaml staging.yaml prod.yaml
```

## ðŸ“ Practice Exercise

### Exercise 1: Create Complete Environment Set
```bash
# Create the full directory structure
mkdir -p webapp/{base,overlays/{dev,staging,prod}}

# Create base kustomization
cat > webapp/base/kustomization.yaml << 'EOF'
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

resources:
  - deployment.yaml
  - service.yaml

commonLabels:
  app: webapp
  managed-by: kustomize

images:
  - name: webapp
    newTag: latest
EOF

# Create environments following the patterns shown above
# Test each environment
cd webapp
kubectl kustomize overlays/dev | head -50
kubectl kustomize overlays/staging | head -50
kubectl kustomize overlays/prod | head -50
```

### Exercise 2: Environment-Specific Deployment
```bash
#!/bin/bash
# multi-env-test.sh

ENVIRONMENTS=("dev" "staging" "prod")

for env in "${ENVIRONMENTS[@]}"; do
    echo "Testing $env environment..."
    
    # Validate configuration
    kubectl kustomize "overlays/$env" --dry-run=client || {
        echo "âŒ $env validation failed"
        continue
    }
    
    # Check resource allocation
    echo "Resource allocation for $env:"
    kubectl kustomize "overlays/$env" | yq e 'select(.kind == "Deployment") | .spec.template.spec.containers[0].resources' -
    
    # Check replica count
    echo "Replicas for $env:"
    kubectl kustomize "overlays/$env" | yq e 'select(.kind == "Deployment") | .spec.replicas' -
    
    echo "âœ… $env environment validated"
    echo "---"
done
```

## ðŸŽ¯ Best Practices

### Environment Design Principles
```yaml
# âœ… DO: Progressive complexity
# Development: Simple, fast feedback
# Staging: Production-like, comprehensive testing
# Production: Secure, highly available, monitored

# âœ… DO: Use appropriate resource allocation
# Scale resources progressively across environments
# Development: Minimal resources for fast iteration
# Production: Sufficient resources for performance and reliability

# âŒ DON'T: Use production secrets in non-production
# Each environment should have its own secrets management
```

### Configuration Management
```yaml
# âœ… DO: Environment-specific feature flags
configMapGenerator:
  - name: app-config
    literals:
      - FEATURE_EXPERIMENTAL=false  # Disabled in production
      - DEBUG_LOGGING=false         # Only in development

# âœ… DO: Progressive security hardening
# Development: Relaxed for debugging
# Staging: Production-like security testing
# Production: Full security hardening

# âŒ DON'T: Share configurations across incompatible environments
# Avoid using staging configs in production
```

## âž¡ï¸ Next Steps
Now that you understand environment-specific overlays, proceed to [6. namePrefix-nameSuffix-commonLabels.md](6.%20namePrefix-nameSuffix-commonLabels.md) to learn advanced resource naming and labeling strategies for better organization and management.