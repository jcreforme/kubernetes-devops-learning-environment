# 3. Commands: kubectl kustomize, kubectl apply -k

## üéØ Learning Objectives
- [ ] Master essential Kustomize CLI commands
- [ ] Understand the difference between `kubectl kustomize` and `kubectl apply -k`
- [ ] Learn command options and flags for different use cases
- [ ] Practice building, validating, and deploying configurations
- [ ] Troubleshoot common command-line issues

## üìã Core Commands Overview

### Command Comparison
```bash
# Build and Preview (without applying)
kubectl kustomize [directory]           # Build manifests from kustomization
kustomize build [directory]             # Same as above (standalone kustomize)

# Build and Apply Directly  
kubectl apply -k [directory]            # Build and apply in one step
kubectl delete -k [directory]           # Build and delete resources

# Validation Commands
kubectl kustomize [dir] --dry-run=client   # Client-side validation
kubectl kustomize [dir] --dry-run=server   # Server-side validation
kubectl apply -k [dir] --dry-run=client    # Preview changes without applying
```

### Command Workflow
```
Typical Kustomize Workflow:
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ 1. Develop/Edit Configuration                       ‚îÇ
‚îÇ    ‚îú‚îÄ‚îÄ Edit kustomization.yaml                     ‚îÇ
‚îÇ    ‚îú‚îÄ‚îÄ Modify patches                               ‚îÇ
‚îÇ    ‚îî‚îÄ‚îÄ Update resource files                       ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ 2. Build and Validate                              ‚îÇ
‚îÇ    ‚îú‚îÄ‚îÄ kubectl kustomize .                         ‚îÇ
‚îÇ    ‚îú‚îÄ‚îÄ kubectl kustomize . --dry-run=client        ‚îÇ
‚îÇ    ‚îî‚îÄ‚îÄ kubectl kustomize . | kubectl apply --dry-run ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ 3. Deploy                                          ‚îÇ
‚îÇ    ‚îú‚îÄ‚îÄ kubectl apply -k .                          ‚îÇ
‚îÇ    ‚îú‚îÄ‚îÄ kubectl apply -k . --wait                   ‚îÇ
‚îÇ    ‚îî‚îÄ‚îÄ kubectl get pods -l app=myapp               ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ 4. Monitor and Update                              ‚îÇ
‚îÇ    ‚îú‚îÄ‚îÄ kubectl rollout status deployment/myapp     ‚îÇ
‚îÇ    ‚îú‚îÄ‚îÄ kubectl logs -l app=myapp                   ‚îÇ
‚îÇ    ‚îî‚îÄ‚îÄ kubectl apply -k . (for updates)           ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

## üõ†Ô∏è kubectl kustomize Command

### Basic Usage
```bash
# Build manifests from current directory
kubectl kustomize .

# Build from specific directory
kubectl kustomize ./overlays/production

# Build from remote repository
kubectl kustomize https://github.com/kubernetes-sigs/kustomize//examples/multibases/dev

# Output to file
kubectl kustomize ./overlays/prod > production-manifest.yaml

# Pipe to other commands
kubectl kustomize . | kubectl apply -f -
kubectl kustomize . | kubectl diff -f -
```

### Advanced kubectl kustomize Options
```bash
# Validation options
kubectl kustomize . --dry-run=client      # Client-side validation only
kubectl kustomize . --dry-run=server      # Server-side validation (requires cluster access)

# Enable experimental features
kubectl kustomize . --enable-alpha-plugins
kubectl kustomize . --load-restrictor=none

# Helm integration (if available)
kubectl kustomize . --enable-helm

# Output formatting
kubectl kustomize . -o yaml              # YAML output (default)
kubectl kustomize . -o json              # JSON output

# Debugging
kubectl kustomize . --v=3                # Verbose output
kubectl kustomize . --help               # Show help and options
```

### Practical Examples
```bash
# Example 1: Build and inspect before applying
kubectl kustomize overlays/staging | head -50     # Preview first 50 lines
kubectl kustomize overlays/staging | grep image   # Check image configurations
kubectl kustomize overlays/staging | yq e '.metadata.name' -  # Extract resource names

# Example 2: Validate configuration
kubectl kustomize overlays/production --dry-run=server | kubectl apply --dry-run=client -f -

# Example 3: Compare environments
diff <(kubectl kustomize overlays/dev) <(kubectl kustomize overlays/prod)

# Example 4: Check specific resources
kubectl kustomize . | kubectl apply --dry-run=client -f - | grep -A 10 "kind: Deployment"
```

## üöÄ kubectl apply -k Command

### Basic Usage
```bash
# Apply kustomization from current directory
kubectl apply -k .

# Apply from specific directory
kubectl apply -k ./overlays/production

# Apply from URL
kubectl apply -k https://github.com/myorg/configs//overlays/prod

# Apply with specific context and namespace
kubectl apply -k . --context=production-cluster --namespace=myapp
```

### Common Flags and Options
```bash
# Deployment control
kubectl apply -k . --wait                    # Wait for resources to be ready
kubectl apply -k . --timeout=300s            # Set timeout for wait
kubectl apply -k . --cascade=foreground      # Control cascade deletion

# Validation and testing
kubectl apply -k . --dry-run=client          # Preview changes (client-side)
kubectl apply -k . --dry-run=server          # Preview changes (server-side)
kubectl apply -k . --validate=false          # Skip validation

# Output and debugging
kubectl apply -k . --output=yaml             # Show applied configuration
kubectl apply -k . -v=6                      # Verbose output
kubectl apply -k . --record                  # Record the command in annotations

# Field management
kubectl apply -k . --force                   # Force apply (use with caution)
kubectl apply -k . --server-side             # Use server-side apply
kubectl apply -k . --field-manager=kustomize # Set field manager name
```

### Advanced Deployment Patterns
```bash
# Pattern 1: Staged deployment with validation
kubectl apply -k overlays/staging --dry-run=server  # Validate first
kubectl apply -k overlays/staging --wait            # Deploy staging
kubectl rollout status deployment/myapp -n staging  # Wait for rollout
kubectl apply -k overlays/production                # Deploy to production

# Pattern 2: Blue-green deployment preparation
kubectl kustomize overlays/blue > blue-manifest.yaml
kubectl kustomize overlays/green > green-manifest.yaml
kubectl apply -f blue-manifest.yaml                 # Deploy blue
# Test blue environment
kubectl apply -f green-manifest.yaml                # Deploy green

# Pattern 3: Rollback preparation
kubectl apply -k . --record=true                    # Record for rollback
kubectl rollout undo deployment/myapp               # Rollback if needed
```

## üîç Validation and Testing

### Client-Side Validation
```bash
# Validate YAML syntax and Kubernetes schema
kubectl kustomize . --dry-run=client

# Validate without cluster access
kubectl kustomize . | kubectl apply --dry-run=client -f -

# Check for common issues
kubectl kustomize . | kubeval --strict
kubectl kustomize . | kube-score score -
```

### Server-Side Validation
```bash
# Validate against actual cluster
kubectl kustomize . --dry-run=server

# Test admission controllers
kubectl apply -k . --dry-run=server

# Validate with specific context
kubectl apply -k . --dry-run=server --context=prod-cluster
```

### Diff and Preview Commands
```bash
# Compare current state with kustomization
kubectl diff -k .

# Compare different overlays
kubectl kustomize overlays/staging > staging.yaml
kubectl kustomize overlays/prod > prod.yaml
diff staging.yaml prod.yaml

# Preview changes before applying
kubectl apply -k . --dry-run=client -o yaml | kubectl diff -f -
```

## üìä Resource Management Commands

### Deployment Commands
```bash
# Deploy with monitoring
kubectl apply -k . && kubectl rollout status deployment/myapp

# Deploy with resource watching
kubectl apply -k . --wait && kubectl get pods -l app=myapp -w

# Deploy specific resources only
kubectl kustomize . | kubectl apply -f - --selector=app=myapp

# Force deployment (recreate resources)
kubectl apply -k . --force
```

### Update and Maintenance Commands
```bash
# Update existing deployment
kubectl apply -k .                           # Apply changes

# Replace resources (for major changes)
kubectl replace -k .                         # Replace instead of patch

# Scale resources
kubectl kustomize . | kubectl scale --replicas=5 -f -

# Annotate resources
kubectl apply -k . --record=true             # Record command in annotations
```

### Cleanup Commands
```bash
# Delete resources created by kustomization
kubectl delete -k .

# Delete with confirmation
kubectl delete -k . --wait=true

# Delete specific resources
kubectl kustomize . | kubectl delete -f - --selector=component=frontend

# Force delete (immediate)
kubectl delete -k . --force --grace-period=0
```

## üêõ Troubleshooting Commands

### Debugging Build Issues
```bash
# Debug kustomization build
kubectl kustomize . --v=5                    # Verbose kustomize output
kubectl kustomize . --enable-alpha-plugins   # Enable experimental features
kubectl kustomize . --load-restrictor=none   # Allow loading from outside

# Check for syntax errors
kubectl kustomize . --dry-run=client 2>&1 | grep -i error

# Validate individual files
kubectl apply --dry-run=client -f base/deployment.yaml
kubectl apply --dry-run=client -f overlays/prod/patch.yaml
```

### Debugging Apply Issues
```bash
# Debug apply with verbose output
kubectl apply -k . -v=8                      # Maximum verbosity

# Check API server connectivity
kubectl cluster-info
kubectl auth can-i create deployments

# Debug resource conflicts
kubectl apply -k . --dry-run=server --v=5

# Check resource status after apply
kubectl apply -k . && kubectl get events --sort-by=.metadata.creationTimestamp
```

### Common Error Patterns
```bash
# Error: "no such file or directory"
# Solution: Check file paths in kustomization.yaml
ls -la $(kubectl kustomize . --dry-run=client 2>&1 | grep "no such file" | awk '{print $NF}')

# Error: "resource already exists"
# Solution: Use replace or delete first
kubectl delete -k . && kubectl apply -k .
# OR
kubectl replace -k .

# Error: "validation failed"
# Solution: Check API version and fields
kubectl api-versions | grep apps
kubectl explain deployment.spec.template.spec.containers
```

## üìù Practical Workflows

### Development Workflow
```bash
#!/bin/bash
# development-deploy.sh

set -e  # Exit on error

echo "üèóÔ∏è  Building development configuration..."
kubectl kustomize overlays/dev --dry-run=client > /dev/null || {
    echo "‚ùå Kustomization build failed"
    exit 1
}

echo "‚úÖ Build successful. Validating against cluster..."
kubectl apply -k overlays/dev --dry-run=server || {
    echo "‚ùå Server-side validation failed"
    exit 1
}

echo "‚úÖ Validation successful. Deploying to development..."
kubectl apply -k overlays/dev --wait

echo "üöÄ Checking deployment status..."
kubectl rollout status deployment/dev-webapp --timeout=300s

echo "üìä Deployment complete. Resource status:"
kubectl get pods,svc,ingress -l app=webapp,environment=development
```

### Production Workflow
```bash
#!/bin/bash
# production-deploy.sh

set -e

# Safety checks
if [[ $(kubectl config current-context) != "production-cluster" ]]; then
    echo "‚ùå Not connected to production cluster"
    exit 1
fi

# Generate and review manifest
echo "üìã Generating production manifest..."
kubectl kustomize overlays/production > production-manifest.yaml

echo "üîç Please review production-manifest.yaml before proceeding..."
read -p "Continue with deployment? (y/N): " -n 1 -r
echo
if [[ ! $REPLY =~ ^[Yy]$ ]]; then
    echo "Deployment cancelled"
    exit 1
fi

# Backup current state
echo "üíæ Backing up current state..."
kubectl get all -l app=webapp -o yaml > backup-$(date +%Y%m%d-%H%M%S).yaml

# Deploy with monitoring
echo "üöÄ Deploying to production..."
kubectl apply -k overlays/production --record=true

# Monitor rollout
echo "üìä Monitoring rollout..."
kubectl rollout status deployment/webapp --timeout=600s

# Health check
echo "üè• Performing health check..."
kubectl get pods -l app=webapp | grep -v Running && echo "‚ùå Some pods not running" || echo "‚úÖ All pods running"

echo "‚úÖ Production deployment complete!"
```

### Multi-Environment Deployment
```bash
#!/bin/bash
# multi-env-deploy.sh

ENVIRONMENTS=("dev" "staging" "prod")

for env in "${ENVIRONMENTS[@]}"; do
    echo "üåç Deploying to $env environment..."
    
    # Validate first
    kubectl kustomize "overlays/$env" --dry-run=server || {
        echo "‚ùå Validation failed for $env"
        continue
    }
    
    # Deploy
    kubectl apply -k "overlays/$env" --wait || {
        echo "‚ùå Deployment failed for $env"
        continue
    }
    
    # Verify
    kubectl rollout status deployment/"$env"-webapp --timeout=180s
    
    echo "‚úÖ $env deployment complete"
    
    # Wait between environments (except for last)
    if [[ "$env" != "prod" ]]; then
        echo "‚è≥ Waiting 30 seconds before next environment..."
        sleep 30
    fi
done
```

## üéØ Best Practices

### Command Usage Guidelines
```bash
# ‚úÖ DO: Always validate before applying
kubectl kustomize . --dry-run=client        # Local validation
kubectl apply -k . --dry-run=server         # Server validation
kubectl apply -k .                          # Actual deployment

# ‚úÖ DO: Use specific paths
kubectl apply -k overlays/production        # Explicit path
kubectl apply -k .                          # Only if in correct directory

# ‚ùå DON'T: Skip validation in production
kubectl apply -k . --force                  # Dangerous without validation
```

### Safety Patterns
```bash
# ‚úÖ DO: Use context and namespace verification
kubectl config current-context              # Verify cluster
kubectl config view --minify -o jsonpath='{.contexts[0].context.namespace}'  # Verify namespace

# ‚úÖ DO: Use timeouts and waiting
kubectl apply -k . --wait --timeout=300s    # Wait with timeout

# ‚úÖ DO: Record deployments for rollback
kubectl apply -k . --record=true            # Enable rollback capability
```

### Error Handling
```bash
# ‚úÖ DO: Handle errors gracefully
kubectl apply -k . || {
    echo "Deployment failed, checking status..."
    kubectl get events --sort-by=.metadata.creationTimestamp
    kubectl describe pods -l app=myapp
    exit 1
}

# ‚úÖ DO: Use verbose output for debugging
kubectl apply -k . -v=5 > deployment.log 2>&1
```

## ‚ö° Quick Reference

### Essential Commands
```bash
# Build and preview
kubectl kustomize .                          # Build manifests
kubectl kustomize . --dry-run=client        # Validate locally
kubectl kustomize . --dry-run=server        # Validate on server

# Deploy and manage
kubectl apply -k .                          # Deploy
kubectl apply -k . --wait                   # Deploy and wait
kubectl delete -k .                         # Remove resources

# Debug and troubleshoot
kubectl diff -k .                           # Show changes
kubectl apply -k . --dry-run=client -o yaml # Preview deployment
kubectl apply -k . -v=5                     # Verbose deployment
```

### Common Flags Quick Reference
```bash
--dry-run=client        # Client-side validation
--dry-run=server        # Server-side validation  
--wait                  # Wait for resources to be ready
--timeout=300s          # Set operation timeout
--force                 # Force apply (dangerous)
--record                # Record command for rollback
-v=5                    # Verbose output
-o yaml                 # YAML output format
```

## ‚û°Ô∏è Next Steps
Now that you've mastered the essential Kustomize commands, proceed to [4. Strategic-Merge-Patches-vs-JSON-Patches.md](4.%20Strategic-Merge-Patches-vs-JSON-Patches.md) to learn the different patching mechanisms for customizing your Kubernetes resources.