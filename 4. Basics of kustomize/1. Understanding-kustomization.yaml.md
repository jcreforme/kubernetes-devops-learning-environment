# 1. Understanding kustomization.yaml

## ðŸŽ¯ Learning Objectives
- [ ] Understand the structure and purpose of kustomization.yaml
- [ ] Learn the core fields and their functions
- [ ] Master basic kustomization configuration
- [ ] Practice creating and validating kustomization files
- [ ] Understand the relationship between resources and kustomization

## ðŸ“‹ What is kustomization.yaml?

### Overview
```yaml
# kustomization.yaml is the core configuration file for Kustomize
# It defines how to customize Kubernetes resources without modifying original files

apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

# Basic structure
metadata:
  name: my-app
  namespace: default

resources:
  - deployment.yaml
  - service.yaml
  - configmap.yaml

images:
  - name: my-app
    newTag: v1.2.3

namePrefix: dev-
nameSuffix: -v1

commonLabels:
  app: my-application
  version: v1.2.3
  environment: development

commonAnnotations:
  managed-by: kustomize
  team: platform
```

### Core Fields Explained
```yaml
# Resource Management
resources:              # List of resource files to include
  - deployment.yaml
  - service.yaml
  - ../base              # Can reference directories

bases:                  # Deprecated, use resources instead
  - ../base

# Transformations
namePrefix: "dev-"      # Prefix added to resource names
nameSuffix: "-v1"       # Suffix added to resource names

# Labels and Annotations
commonLabels:           # Labels applied to all resources
  environment: dev
  team: platform

commonAnnotations:      # Annotations applied to all resources
  managed-by: kustomize

# Image Management
images:                 # Image tag/name modifications
  - name: nginx
    newTag: 1.21.0
  - name: app
    newName: my-registry/app
    newTag: v2.0.0

# Configuration Management
configMapGenerator:     # Generate ConfigMaps
  - name: app-config
    files:
      - config.properties
    literals:
      - DATABASE_URL=postgresql://localhost:5432/mydb

secretGenerator:        # Generate Secrets
  - name: app-secrets
    literals:
      - username=admin
      - password=secret123

# Patches
patches:                # Strategic merge patches
  - deployment-patch.yaml
patchesStrategicMerge:  # Deprecated, use patches
  - deployment-patch.yaml
patchesJson6902:        # JSON patches
  - target:
      kind: Deployment
      name: my-app
    path: json-patch.yaml

# Components
components:             # Reusable components
  - ../components/monitoring
  - ../components/security
```

## ðŸ—ï¸ Directory Structure Best Practices

### Standard Project Layout
```
project/
â”œâ”€â”€ base/
â”‚   â”œâ”€â”€ kustomization.yaml
â”‚   â”œâ”€â”€ deployment.yaml
â”‚   â”œâ”€â”€ service.yaml
â”‚   â””â”€â”€ configmap.yaml
â”œâ”€â”€ overlays/
â”‚   â”œâ”€â”€ dev/
â”‚   â”‚   â”œâ”€â”€ kustomization.yaml
â”‚   â”‚   â””â”€â”€ dev-patch.yaml
â”‚   â”œâ”€â”€ staging/
â”‚   â”‚   â”œâ”€â”€ kustomization.yaml
â”‚   â”‚   â””â”€â”€ staging-patch.yaml
â”‚   â””â”€â”€ prod/
â”‚       â”œâ”€â”€ kustomization.yaml
â”‚       â””â”€â”€ prod-patch.yaml
â””â”€â”€ components/
    â”œâ”€â”€ monitoring/
    â”‚   â”œâ”€â”€ kustomization.yaml
    â”‚   â””â”€â”€ prometheus.yaml
    â””â”€â”€ security/
        â”œâ”€â”€ kustomization.yaml
        â””â”€â”€ rbac.yaml
```

### Base Configuration Example
```yaml
# base/kustomization.yaml
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

metadata:
  name: webapp-base

resources:
  - deployment.yaml
  - service.yaml
  - configmap.yaml

commonLabels:
  app: webapp
  version: "1.0"

images:
  - name: webapp
    newTag: latest
```

### Base Resources
```yaml
# base/deployment.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: webapp
  labels:
    app: webapp
spec:
  replicas: 3
  selector:
    matchLabels:
      app: webapp
  template:
    metadata:
      labels:
        app: webapp
    spec:
      containers:
      - name: webapp
        image: webapp:latest
        ports:
        - containerPort: 8080
        env:
        - name: ENV
          value: "base"
        resources:
          requests:
            cpu: 100m
            memory: 128Mi
          limits:
            cpu: 500m
            memory: 512Mi

---
# base/service.yaml
apiVersion: v1
kind: Service
metadata:
  name: webapp-service
spec:
  selector:
    app: webapp
  ports:
  - protocol: TCP
    port: 80
    targetPort: 8080
  type: ClusterIP

---
# base/configmap.yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: webapp-config
data:
  app.properties: |
    debug=false
    log.level=INFO
    database.url=postgresql://localhost:5432/webapp
```

## ðŸ”§ Advanced kustomization.yaml Features

### Resource Selectors
```yaml
# Advanced resource selection
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

resources:
  - deployment.yaml
  - service.yaml

# Transform only specific resources
transformers:
  - path: transformer.yaml

# Replace specific values
replacements:
  - source:
      kind: ConfigMap
      name: app-config
      fieldPath: data.version
    targets:
    - select:
        kind: Deployment
        name: webapp
      fieldPaths:
      - spec.template.metadata.labels.version

# Inventory management
inventory:
  type: ConfigMap
  configMap:
    name: inventory-configmap
    namespace: default
```

### Generator Options
```yaml
# ConfigMap generation with options
configMapGenerator:
  - name: app-config
    behavior: create  # create, replace, merge
    files:
      - application.yaml
      - config.properties
    literals:
      - DATABASE_URL=postgresql://db:5432/app
      - LOG_LEVEL=INFO
    options:
      disableNameSuffixHash: false
      labels:
        config-type: application
      annotations:
        config-version: "1.0"

# Secret generation
secretGenerator:
  - name: app-secrets
    type: Opaque  # kubernetes.io/tls, kubernetes.io/dockerconfigjson
    files:
      - tls.crt
      - tls.key
    literals:
      - username=admin
    envs:
      - .env
    options:
      disableNameSuffixHash: true
```

### Build Metadata
```yaml
# Build information and validation
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

metadata:
  name: my-app
  namespace: default
  labels:
    app.kubernetes.io/name: myapp
    app.kubernetes.io/version: "1.2.3"
  annotations:
    config.kubernetes.io/local-config: "true"

buildMetadata:
  - originAnnotations
  - transformerAnnotations
  - managedByLabel

# Validation
openapi:
  path: openapi/swagger.json

# Sort order
sortOptions:
  order: fifo  # legacy, fifo
  legacySortOptions:
    orderFirst:
      - Namespace
      - ResourceQuota
      - StorageClass
    orderLast:
      - MutatingWebhookConfiguration
      - ValidatingWebhookConfiguration
```

## ðŸ§ª Validation and Testing

### Validation Commands
```bash
# Validate kustomization.yaml syntax
kustomize build . --validate

# Check resource generation without applying
kubectl kustomize . --dry-run=client

# Validate against Kubernetes API
kubectl kustomize . --dry-run=server

# Debug kustomization processing
kustomize build . --enable-alpha-plugins --load-restrictor=none

# Show all resources that would be created
kubectl kustomize . | kubectl apply --dry-run=client -f -
```

### Common Validation Issues
```yaml
# âŒ Common mistakes to avoid
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

# Wrong: Missing resources section
images:
  - name: app
    newTag: v1.0.0

# Wrong: Invalid field names
resource:  # Should be 'resources'
  - deployment.yaml

# Wrong: Incorrect file paths
resources:
  - ./missing-file.yaml  # File doesn't exist

# âœ… Correct configuration
resources:
  - deployment.yaml
  - service.yaml

images:
  - name: app
    newTag: v1.0.0
```

## ðŸ“ Practice Exercise

### Exercise 1: Basic kustomization.yaml
```bash
# Create a basic project structure
mkdir -p myapp/base
cd myapp/base

# Create base deployment
cat > deployment.yaml << EOF
apiVersion: apps/v1
kind: Deployment
metadata:
  name: myapp
spec:
  replicas: 2
  selector:
    matchLabels:
      app: myapp
  template:
    metadata:
      labels:
        app: myapp
    spec:
      containers:
      - name: myapp
        image: nginx:latest
        ports:
        - containerPort: 80
EOF

# Create kustomization.yaml
cat > kustomization.yaml << EOF
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

resources:
  - deployment.yaml

commonLabels:
  environment: base
  managed-by: kustomize

images:
  - name: nginx
    newTag: "1.21"

namePrefix: webapp-
EOF

# Test the configuration
kubectl kustomize .
```

### Exercise 2: Advanced Configuration
```yaml
# Advanced kustomization with multiple features
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

metadata:
  name: advanced-app
  annotations:
    config.kubernetes.io/local-config: "true"

resources:
  - deployment.yaml
  - service.yaml
  - ingress.yaml

# Image management
images:
  - name: webapp
    newName: myregistry/webapp
    newTag: v2.1.0
  - name: sidecar
    newTag: stable

# Configuration generation
configMapGenerator:
  - name: app-config
    literals:
      - LOG_LEVEL=INFO
      - DATABASE_URL=postgresql://db:5432/app
    files:
      - config/application.yaml

secretGenerator:
  - name: app-secrets
    literals:
      - username=admin
      - password=secret123
    options:
      disableNameSuffixHash: true

# Transformations
commonLabels:
  app: webapp
  version: v2.1.0
  environment: production

commonAnnotations:
  deployment.kubernetes.io/revision: "3"
  managed-by: kustomize

namePrefix: prod-
nameSuffix: -v2

# Patches for customization
patches:
  - path: patches/replica-count.yaml
    target:
      kind: Deployment
      name: webapp

# Components for reusable configurations
components:
  - ../components/monitoring
  - ../components/security-policies
```

## ðŸ” Debugging and Troubleshooting

### Common Issues and Solutions
```bash
# Issue: Resources not found
Error: couldn't make target for path './missing-file.yaml'
# Solution: Check file paths and ensure files exist

# Issue: Invalid kustomization format
Error: invalid Kustomization: missing 'resources' field
# Solution: Ensure required fields are present

# Issue: Image not found in resources
Error: image name 'nginx' not found in resources
# Solution: Ensure image names match those in resource files

# Debug commands
kubectl kustomize . --enable-alpha-plugins -v=3
kustomize build . --load-restrictor=none --enable-helm
```

### Validation Checklist
```yaml
# âœ… Validation checklist for kustomization.yaml
- [ ] Valid YAML syntax
- [ ] Correct apiVersion and kind
- [ ] Resources field present with valid file paths
- [ ] Image names match those in resource files
- [ ] File paths are relative to kustomization.yaml location
- [ ] No duplicate resource names after transformations
- [ ] Valid label and annotation formats
- [ ] Patch targets match existing resources
```

## ðŸŽ¯ Best Practices Summary

### Configuration Management
```yaml
# âœ… DO: Organize configurations logically
resources:
  - bases/common
  - deployment.yaml
  - service.yaml

commonLabels:
  app.kubernetes.io/name: myapp
  app.kubernetes.io/version: "1.0.0"

# âœ… DO: Use semantic versioning for images
images:
  - name: myapp
    newTag: v1.2.3

# âŒ DON'T: Hardcode environment-specific values in base
# Instead use overlays for environment-specific configurations
```

### File Organization
```
# âœ… DO: Follow standard directory structure
base/
  kustomization.yaml
  deployment.yaml
  service.yaml
overlays/
  dev/kustomization.yaml
  prod/kustomization.yaml

# âŒ DON'T: Mix base and overlay configurations
```

## âž¡ï¸ Next Steps
Now that you understand kustomization.yaml structure, proceed to [2. Base-vs-Overlays-Concept.md](2.%20Base-vs-Overlays-Concept.md) to learn the fundamental concepts of base configurations and environment-specific overlays.