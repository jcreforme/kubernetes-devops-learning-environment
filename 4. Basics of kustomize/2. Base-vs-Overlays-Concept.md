# 2. Base vs Overlays Concept

## ğŸ¯ Learning Objectives
- [ ] Understand the fundamental concept of base and overlays
- [ ] Learn the inheritance model of Kustomize
- [ ] Master directory organization for multi-environment deployments
- [ ] Practice creating base configurations and environment-specific overlays
- [ ] Implement configuration reusability and maintainability

## ğŸ“‹ Base vs Overlays Architecture

### Conceptual Overview
```
Kustomize Inheritance Model:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Base                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ Common configurations shared across envs    â”‚    â”‚
â”‚  â”‚ - Deployment template                       â”‚    â”‚
â”‚  â”‚ - Service definition                        â”‚    â”‚
â”‚  â”‚ - ConfigMap structure                       â”‚    â”‚
â”‚  â”‚ - Default resource limits                   â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚ (inherited by)
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚         â”‚         â”‚
   â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â” â”Œâ”€â”€â”€â–¼â”€â”€â”€â”€â” â”Œâ”€â”€â–¼â”€â”€â”€â”€â”€â”
   â”‚  Dev   â”‚ â”‚Staging â”‚ â”‚  Prod  â”‚
   â”‚Overlay â”‚ â”‚Overlay â”‚ â”‚Overlay â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   
Each overlay inherits from base and adds/modifies:
- Environment-specific configurations
- Resource scaling (replicas, limits)
- Image tags and registries  
- Environment variables
- Ingress hosts and certificates
```

### Directory Structure Pattern
```
project-root/
â”œâ”€â”€ base/                           # Base configurations
â”‚   â”œâ”€â”€ kustomization.yaml         # Base kustomization
â”‚   â”œâ”€â”€ deployment.yaml            # Common deployment template
â”‚   â”œâ”€â”€ service.yaml               # Service definition
â”‚   â”œâ”€â”€ configmap.yaml             # Base configuration
â”‚   â””â”€â”€ rbac.yaml                  # Role-based access control
â”‚
â”œâ”€â”€ overlays/                      # Environment-specific overlays
â”‚   â”œâ”€â”€ development/
â”‚   â”‚   â”œâ”€â”€ kustomization.yaml     # Dev-specific kustomization
â”‚   â”‚   â”œâ”€â”€ dev-config-patch.yaml  # Development configuration overrides
â”‚   â”‚   â”œâ”€â”€ dev-resources.yaml     # Development-specific resources
â”‚   â”‚   â””â”€â”€ ingress-dev.yaml       # Development ingress
â”‚   â”‚
â”‚   â”œâ”€â”€ staging/
â”‚   â”‚   â”œâ”€â”€ kustomization.yaml     # Staging-specific kustomization
â”‚   â”‚   â”œâ”€â”€ staging-patch.yaml     # Staging configuration overrides
â”‚   â”‚   â””â”€â”€ hpa.yaml               # Horizontal Pod Autoscaler for staging
â”‚   â”‚
â”‚   â””â”€â”€ production/
â”‚       â”œâ”€â”€ kustomization.yaml     # Production-specific kustomization
â”‚       â”œâ”€â”€ prod-patch.yaml        # Production configuration overrides
â”‚       â”œâ”€â”€ prod-secrets.yaml      # Production secrets
â”‚       â”œâ”€â”€ monitoring.yaml        # Production monitoring
â”‚       â””â”€â”€ backup-cronjob.yaml    # Production backup jobs
â”‚
â””â”€â”€ components/                    # Reusable components (optional)
    â”œâ”€â”€ monitoring/
    â”œâ”€â”€ security/
    â””â”€â”€ networking/
```

## ğŸ—ï¸ Base Configuration

### Base kustomization.yaml
```yaml
# base/kustomization.yaml
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

metadata:
  name: webapp-base
  annotations:
    config.kubernetes.io/local-config: "true"

# Resources included in the base
resources:
  - deployment.yaml
  - service.yaml
  - configmap.yaml
  - serviceaccount.yaml

# Common labels applied to all resources
commonLabels:
  app.kubernetes.io/name: webapp
  app.kubernetes.io/component: backend
  app.kubernetes.io/part-of: ecommerce-platform

# Default image configuration
images:
  - name: webapp
    newTag: latest

# Base configuration that can be overridden
configMapGenerator:
  - name: app-config
    literals:
      - LOG_LEVEL=INFO
      - DATABASE_POOL_SIZE=10
      - CACHE_TTL=300
    files:
      - app.properties
```

### Base Deployment Template
```yaml
# base/deployment.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: webapp
  labels:
    app: webapp
spec:
  replicas: 2                      # Default replica count
  selector:
    matchLabels:
      app: webapp
  template:
    metadata:
      labels:
        app: webapp
    spec:
      serviceAccountName: webapp-sa
      containers:
      - name: webapp
        image: webapp:latest        # Will be customized per environment
        ports:
        - containerPort: 8080
        env:
        - name: ENV
          value: "base"             # Will be overridden in overlays
        - name: PORT
          value: "8080"
        envFrom:
        - configMapRef:
            name: app-config
        resources:
          requests:                 # Conservative defaults
            cpu: 100m
            memory: 128Mi
          limits:
            cpu: 500m
            memory: 512Mi
        livenessProbe:
          httpGet:
            path: /health
            port: 8080
          initialDelaySeconds: 30
          periodSeconds: 10
        readinessProbe:
          httpGet:
            path: /ready
            port: 8080
          initialDelaySeconds: 5
          periodSeconds: 5
```

### Base Service
```yaml
# base/service.yaml
apiVersion: v1
kind: Service
metadata:
  name: webapp-service
  labels:
    app: webapp
spec:
  type: ClusterIP               # Default service type
  ports:
  - port: 80
    targetPort: 8080
    protocol: TCP
    name: http
  selector:
    app: webapp
```

### Base ConfigMap
```yaml
# base/configmap.yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: webapp-config-base
  labels:
    app: webapp
data:
  app.properties: |
    # Base application configuration
    server.port=8080
    logging.level.root=INFO
    
    # Database configuration (will be overridden)
    database.host=localhost
    database.port=5432
    database.name=webapp
    
    # Cache configuration
    cache.enabled=true
    cache.ttl=300
    
    # Feature flags (base defaults)
    features.newUI=false
    features.analytics=false
    features.monitoring=false
```

## ğŸŒ Environment Overlays

### Development Overlay
```yaml
# overlays/development/kustomization.yaml
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

# Reference to base configuration
resources:
  - ../../base
  - ingress-dev.yaml           # Dev-specific ingress

# Environment-specific naming
namePrefix: dev-
nameSuffix: -v1

# Development-specific labels
commonLabels:
  environment: development
  tier: non-production

commonAnnotations:
  managed-by: kustomize
  environment: development

# Development image tag
images:
  - name: webapp
    newTag: dev-latest

# Override base ConfigMap with development values
configMapGenerator:
  - name: app-config
    behavior: merge              # Merge with base ConfigMap
    literals:
      - LOG_LEVEL=DEBUG
      - DATABASE_HOST=dev-db.internal
      - DATABASE_NAME=webapp_dev
      - FEATURES_NEW_UI=true
      - FEATURES_ANALYTICS=true

# Development-specific patches
patches:
  - path: dev-config-patch.yaml
    target:
      kind: Deployment
      name: webapp

# Development replicas (lower resource usage)
replicas:
  - name: webapp
    count: 1
```

### Development Patch
```yaml
# overlays/development/dev-config-patch.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: webapp
spec:
  template:
    spec:
      containers:
      - name: webapp
        env:
        - name: ENV
          value: "development"
        - name: DEBUG_MODE
          value: "true"
        - name: HOT_RELOAD
          value: "true"
        resources:
          requests:
            cpu: 50m               # Lower resource requests for dev
            memory: 64Mi
          limits:
            cpu: 200m
            memory: 256Mi
        # Development-specific volume mounts for hot reload
        volumeMounts:
        - name: dev-code
          mountPath: /app/src
      volumes:
      - name: dev-code
        hostPath:
          path: /host/dev/webapp/src
          type: Directory
```

### Development Ingress
```yaml
# overlays/development/ingress-dev.yaml
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: webapp-ingress
  annotations:
    nginx.ingress.kubernetes.io/rewrite-target: /
    cert-manager.io/cluster-issuer: letsencrypt-staging
spec:
  tls:
  - hosts:
    - dev.webapp.company.com
    secretName: webapp-dev-tls
  rules:
  - host: dev.webapp.company.com
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: webapp-service
            port:
              number: 80
```

### Production Overlay
```yaml
# overlays/production/kustomization.yaml
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

# Reference to base configuration
resources:
  - ../../base
  - prod-secrets.yaml          # Production secrets
  - hpa.yaml                   # Horizontal Pod Autoscaler
  - network-policy.yaml        # Network security policies
  - monitoring.yaml            # Production monitoring
  - backup-cronjob.yaml        # Backup jobs

# Production naming (no prefix for clean names)
commonLabels:
  environment: production
  tier: production

commonAnnotations:
  managed-by: kustomize
  environment: production
  backup-policy: daily

# Production image tag (specific version)
images:
  - name: webapp
    newTag: v2.1.3

# Production configuration
configMapGenerator:
  - name: app-config
    behavior: replace           # Replace base ConfigMap entirely
    literals:
      - LOG_LEVEL=WARN
      - DATABASE_HOST=prod-db.internal
      - DATABASE_NAME=webapp_prod
      - DATABASE_POOL_SIZE=50
      - CACHE_TTL=600
      - FEATURES_NEW_UI=true
      - FEATURES_ANALYTICS=true
      - FEATURES_MONITORING=true

secretGenerator:
  - name: app-secrets
    literals:
      - database-username=webapp_prod_user
    files:
      - database-password=secrets/db-password.txt
      - api-key=secrets/api-key.txt

# Production-specific patches
patches:
  - path: prod-resources-patch.yaml
    target:
      kind: Deployment
      name: webapp
  - path: prod-security-patch.yaml
    target:
      kind: Deployment
      name: webapp

# Production replica count
replicas:
  - name: webapp
    count: 5
```

### Production Resource Patch
```yaml
# overlays/production/prod-resources-patch.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: webapp
spec:
  strategy:
    type: RollingUpdate
    rollingUpdate:
      maxSurge: 2
      maxUnavailable: 1
  template:
    spec:
      containers:
      - name: webapp
        env:
        - name: ENV
          value: "production"
        - name: JAVA_OPTS
          value: "-Xmx1g -XX:+UseG1GC"
        resources:
          requests:
            cpu: 500m             # Higher resource requests for prod
            memory: 1Gi
          limits:
            cpu: 2000m
            memory: 2Gi
        # Production-optimized probes
        livenessProbe:
          httpGet:
            path: /health
            port: 8080
          initialDelaySeconds: 60  # Longer startup time in prod
          periodSeconds: 30
          timeoutSeconds: 10
          failureThreshold: 3
        readinessProbe:
          httpGet:
            path: /ready
            port: 8080
          initialDelaySeconds: 10
          periodSeconds: 10
          timeoutSeconds: 5
          failureThreshold: 2
```

### Production HPA
```yaml
# overlays/production/hpa.yaml
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: webapp-hpa
  labels:
    app: webapp
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: webapp
  minReplicas: 3
  maxReplicas: 20
  metrics:
  - type: Resource
    resource:
      name: cpu
      target:
        type: Utilization
        averageUtilization: 70
  - type: Resource
    resource:
      name: memory
      target:
        type: Utilization
        averageUtilization: 80
  behavior:
    scaleDown:
      stabilizationWindowSeconds: 300
      policies:
      - type: Percent
        value: 10
        periodSeconds: 60
    scaleUp:
      stabilizationWindowSeconds: 60
      policies:
      - type: Percent
        value: 50
        periodSeconds: 60
```

## ğŸ”„ Overlay Inheritance Patterns

### Cascading Configuration
```yaml
# Multiple inheritance levels
project/
â”œâ”€â”€ base/                          # Level 1: Common base
â”‚   â””â”€â”€ kustomization.yaml
â”œâ”€â”€ environments/                  # Level 2: Environment templates  
â”‚   â”œâ”€â”€ non-production/
â”‚   â”‚   â””â”€â”€ kustomization.yaml
â”‚   â””â”€â”€ production/
â”‚       â””â”€â”€ kustomization.yaml
â””â”€â”€ overlays/                     # Level 3: Specific deployments
    â”œâ”€â”€ dev/
    â”‚   â””â”€â”€ kustomization.yaml    # Inherits from non-production
    â”œâ”€â”€ staging/
    â”‚   â””â”€â”€ kustomization.yaml    # Inherits from non-production
    â””â”€â”€ prod/
        â””â”€â”€ kustomization.yaml    # Inherits from production

# overlays/dev/kustomization.yaml
resources:
  - ../../environments/non-production  # Inherits non-prod template
  - ingress-dev.yaml                   # Adds dev-specific resources

namePrefix: dev-
```

### Component-Based Inheritance
```yaml
# Using components for modular inheritance
overlays/production/kustomization.yaml:
resources:
  - ../../base

components:
  - ../../components/monitoring     # Add monitoring stack
  - ../../components/security       # Add security policies
  - ../../components/backup         # Add backup solutions
  - ../../components/logging        # Add centralized logging

# Each component has its own kustomization.yaml
components/monitoring/kustomization.yaml:
apiVersion: kustomize.config.k8s.io/v1alpha1
kind: Component

resources:
  - prometheus.yaml
  - grafana.yaml
  - alertmanager.yaml

images:
  - name: prometheus/prometheus
    newTag: v2.40.0
```

## ğŸ§ª Testing and Validation

### Environment Validation
```bash
# Validate each environment overlay
kubectl kustomize overlays/development --dry-run=client
kubectl kustomize overlays/staging --dry-run=client  
kubectl kustomize overlays/production --dry-run=client

# Compare configurations between environments
diff <(kubectl kustomize overlays/staging) <(kubectl kustomize overlays/production)

# Validate against API server
kubectl kustomize overlays/production --dry-run=server

# Check for resource conflicts
kubectl kustomize overlays/production | kubectl apply --dry-run=client -f -
```

### Configuration Comparison
```bash
# Generate and compare manifests
kubectl kustomize base > base-manifests.yaml
kubectl kustomize overlays/dev > dev-manifests.yaml
kubectl kustomize overlays/prod > prod-manifests.yaml

# Compare specific configurations
yq eval '.spec.replicas' dev-manifests.yaml  # Should show 1
yq eval '.spec.replicas' prod-manifests.yaml # Should show 5

# Verify image tags
yq eval '.spec.template.spec.containers[0].image' dev-manifests.yaml
yq eval '.spec.template.spec.containers[0].image' prod-manifests.yaml
```

## ğŸ“ Practice Exercise

### Exercise 1: Create Multi-Environment Setup
```bash
# Create directory structure
mkdir -p webapp/{base,overlays/{dev,staging,prod}}

# Create base files
cd webapp/base
cat > kustomization.yaml << EOF
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

resources:
  - deployment.yaml
  - service.yaml

commonLabels:
  app: webapp

images:
  - name: webapp
    newTag: latest
EOF

# Create base deployment
cat > deployment.yaml << EOF
apiVersion: apps/v1
kind: Deployment
metadata:
  name: webapp
spec:
  replicas: 2
  selector:
    matchLabels:
      app: webapp
  template:
    metadata:
      labels:
        app: webapp
    spec:
      containers:
      - name: webapp
        image: webapp:latest
        ports:
        - containerPort: 8080
        resources:
          requests:
            cpu: 100m
            memory: 128Mi
EOF

# Create dev overlay
cd ../overlays/dev
cat > kustomization.yaml << EOF
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

resources:
  - ../../base

namePrefix: dev-

commonLabels:
  environment: development

images:
  - name: webapp
    newTag: dev-latest

replicas:
  - name: webapp
    count: 1
EOF

# Test the overlays
kubectl kustomize .
kubectl kustomize ../prod
```

### Exercise 2: Advanced Configuration Inheritance
```yaml
# Create staging overlay that inherits specific patterns
overlays/staging/kustomization.yaml:
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

resources:
  - ../../base
  - staging-ingress.yaml

namePrefix: staging-

commonLabels:
  environment: staging
  tier: non-production

images:
  - name: webapp
    newTag: staging-v2.1.0

configMapGenerator:
  - name: app-config
    behavior: merge
    literals:
      - ENV=staging
      - LOG_LEVEL=INFO
      - DATABASE_URL=postgresql://staging-db:5432/webapp

patches:
  - path: staging-resources.yaml
    target:
      kind: Deployment
      name: webapp

replicas:
  - name: webapp
    count: 3
```

## ğŸ¯ Best Practices

### Base Configuration Guidelines
```yaml
# âœ… DO: Keep base generic and reusable
base/kustomization.yaml:
  # Use conservative resource defaults
  # Avoid environment-specific configurations
  # Include only common resources
  # Use generic image tags

# âŒ DON'T: Include environment-specific values in base
# Avoid: hardcoded hostnames, specific image tags, env-specific configs
```

### Overlay Organization
```
# âœ… DO: Organize overlays by purpose
overlays/
â”œâ”€â”€ environments/        # Environment-based
â”‚   â”œâ”€â”€ dev/
â”‚   â”œâ”€â”€ staging/
â”‚   â””â”€â”€ prod/
â”œâ”€â”€ features/           # Feature-based
â”‚   â”œâ”€â”€ monitoring/
â”‚   â””â”€â”€ security/
â””â”€â”€ regions/            # Region-based
    â”œâ”€â”€ us-east/
    â””â”€â”€ eu-west/

# âŒ DON'T: Mix different overlay purposes in same directory
```

### Inheritance Depth
```
# âœ… DO: Keep inheritance chains shallow (2-3 levels max)
base â†’ environment-template â†’ specific-overlay

# âŒ DON'T: Create deep inheritance chains
base â†’ template â†’ sub-template â†’ environment â†’ region â†’ specific
```

## â¡ï¸ Next Steps
Now that you understand base and overlay concepts, proceed to [3. Commands-kubectl-kustomize-apply.md](3.%20Commands-kubectl-kustomize-apply.md) to master the essential commands for building and deploying Kustomize configurations.