# 6. namePrefix, nameSuffix, commonLabels

## ðŸŽ¯ Learning Objectives
- [ ] Master resource naming strategies with namePrefix and nameSuffix
- [ ] Implement consistent labeling with commonLabels and commonAnnotations  
- [ ] Understand label propagation and selector behavior
- [ ] Practice advanced naming and labeling patterns
- [ ] Avoid common naming conflicts and label management issues

## ðŸ“‹ Resource Naming Overview

### Naming Strategy Architecture
```
Resource Naming Flow:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                Original Resource Name                       â”‚
â”‚                     "webapp"                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                 â†“ namePrefix                                â”‚
â”‚               "dev-webapp"                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                 â†“ nameSuffix                                â”‚
â”‚              "dev-webapp-v1"                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                â†“ commonLabels                               â”‚
â”‚    Labels: app=webapp, environment=dev, version=v1         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Benefits:
âœ… Environment isolation through naming
âœ… Version management with suffixes  
âœ… Consistent labeling across resources
âœ… Simplified resource identification
âœ… Automated label propagation
```

### Directory Structure for Naming Practice
```
naming-example/
â”œâ”€â”€ base/
â”‚   â”œâ”€â”€ kustomization.yaml
â”‚   â”œâ”€â”€ deployment.yaml
â”‚   â”œâ”€â”€ service.yaml
â”‚   â””â”€â”€ configmap.yaml
â”œâ”€â”€ overlays/
â”‚   â”œâ”€â”€ dev/
â”‚   â”‚   â””â”€â”€ kustomization.yaml      # dev- prefix
â”‚   â”œâ”€â”€ staging/
â”‚   â”‚   â””â”€â”€ kustomization.yaml      # staging- prefix
â”‚   â””â”€â”€ prod/
â”‚       â””â”€â”€ kustomization.yaml      # No prefix (clean names)
â””â”€â”€ versions/
    â”œâ”€â”€ v1/
    â”‚   â””â”€â”€ kustomization.yaml      # -v1 suffix
    â””â”€â”€ v2/
        â””â”€â”€ kustomization.yaml      # -v2 suffix
```

## ðŸ·ï¸ namePrefix Configuration

### Basic namePrefix Usage
```yaml
# base/kustomization.yaml
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

resources:
  - deployment.yaml
  - service.yaml
  - configmap.yaml

# No prefix in base (generic names)
commonLabels:
  app: webapp
```

```yaml
# overlays/dev/kustomization.yaml
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

resources:
  - ../../base

# Add development prefix
namePrefix: dev-

commonLabels:
  environment: development
  tier: non-production

# Result: webapp becomes dev-webapp
#         webapp-service becomes dev-webapp-service
#         webapp-config becomes dev-webapp-config
```

### Environment-Specific Prefixes
```yaml
# overlays/staging/kustomization.yaml
namePrefix: staging-

# overlays/production/kustomization.yaml
namePrefix: prod-
# OR leave empty for clean production names

# overlays/feature-branch/kustomization.yaml
namePrefix: feature-auth-

# overlays/hotfix/kustomization.yaml
namePrefix: hotfix-
```

### Multi-Level Prefixes
```yaml
# overlays/dev/feature-x/kustomization.yaml
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

resources:
  - ../../dev                    # Inherits dev- prefix

namePrefix: feature-x-           # Adds additional prefix

# Result: webapp becomes feature-x-dev-webapp
# Note: Order matters! This overlay's prefix comes first
```

## ðŸ”– nameSuffix Configuration

### Basic nameSuffix Usage
```yaml
# overlays/v1/kustomization.yaml
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

resources:
  - ../../base

# Add version suffix
nameSuffix: -v1

commonLabels:
  version: v1

# Result: webapp becomes webapp-v1
#         webapp-service becomes webapp-service-v1
```

### Version Management with Suffixes
```yaml
# overlays/releases/v1.0.0/kustomization.yaml
namePrefix: prod-
nameSuffix: -v1-0-0

commonLabels:
  version: v1.0.0
  release-type: stable

# overlays/releases/v2.0.0-beta/kustomization.yaml  
namePrefix: beta-
nameSuffix: -v2-0-0-beta

commonLabels:
  version: v2.0.0-beta
  release-type: beta
```

### Blue-Green Deployment Suffixes
```yaml
# overlays/blue-green/blue/kustomization.yaml
namePrefix: blue-
nameSuffix: -current

commonLabels:
  deployment-slot: blue
  traffic-weight: "100"

# overlays/blue-green/green/kustomization.yaml
namePrefix: green-
nameSuffix: -standby

commonLabels:
  deployment-slot: green  
  traffic-weight: "0"
```

## ðŸ·ï¸ commonLabels Deep Dive

### Basic commonLabels
```yaml
# Basic labeling strategy
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

resources:
  - deployment.yaml
  - service.yaml

commonLabels:
  app: webapp                           # Application identifier
  version: "1.0"                        # Version tracking
  component: backend                    # Component type
  part-of: ecommerce-platform          # Larger system
  managed-by: kustomize                 # Management tool
  environment: production               # Environment indicator
```

### Kubernetes Recommended Labels
```yaml
# Following Kubernetes label recommendations
commonLabels:
  # Kubernetes recommended labels
  app.kubernetes.io/name: webapp
  app.kubernetes.io/instance: webapp-prod
  app.kubernetes.io/version: "1.2.3"
  app.kubernetes.io/component: backend
  app.kubernetes.io/part-of: ecommerce
  app.kubernetes.io/managed-by: kustomize
  
  # Custom labels
  team: platform-team
  cost-center: engineering
  criticality: high
  backup-policy: daily
```

### Environment-Specific Labels
```yaml
# overlays/development/kustomization.yaml
commonLabels:
  environment: development
  tier: non-production
  auto-cleanup: "true"
  resource-policy: development
  cost-allocation: development
  
# overlays/staging/kustomization.yaml  
commonLabels:
  environment: staging
  tier: pre-production
  testing: automated
  performance-monitoring: enabled
  
# overlays/production/kustomization.yaml
commonLabels:
  environment: production
  tier: production
  sla-tier: gold
  monitoring: critical
  backup: enabled
```

### Label Inheritance and Propagation
```yaml
# base/kustomization.yaml
commonLabels:
  app: webapp                          # Inherited by all overlays
  managed-by: kustomize               # Inherited by all overlays

# overlays/dev/kustomization.yaml
resources:
  - ../../base

commonLabels:
  environment: development            # Added to base labels
  debug-mode: "true"                 # Added to base labels

# Final result combines both:
# app: webapp (from base)
# managed-by: kustomize (from base)  
# environment: development (from overlay)
# debug-mode: "true" (from overlay)
```

## ðŸ“ commonAnnotations

### Basic Annotations
```yaml
# Basic annotation strategy
commonAnnotations:
  # Deployment metadata
  deployment.kubernetes.io/revision: "3"
  kubernetes.io/change-cause: "Update to version 1.2.3"
  
  # Contact information
  contact.team: platform-team@company.com
  contact.slack: "#platform-team"
  
  # Documentation
  documentation.url: https://docs.company.com/webapp
  runbook.url: https://runbooks.company.com/webapp
  
  # Monitoring
  prometheus.io/scrape: "true"
  prometheus.io/port: "9090"
  prometheus.io/path: "/metrics"
```

### Environment-Specific Annotations
```yaml
# overlays/development/kustomization.yaml
commonAnnotations:
  environment: development
  auto-cleanup.time: "24h"
  debug.enabled: "true"
  cost-tracking.environment: development

# overlays/production/kustomization.yaml
commonAnnotations:
  environment: production
  backup.schedule: "0 2 * * *"
  monitoring.tier: critical
  sla.availability: "99.9%"
  security.compliance: "required"
```

### Service Mesh Annotations
```yaml
# Service mesh specific annotations
commonAnnotations:
  # Istio annotations
  sidecar.istio.io/inject: "true"
  traffic.sidecar.istio.io/includeInboundPorts: "8080,9090"
  
  # Linkerd annotations
  linkerd.io/inject: enabled
  config.linkerd.io/proxy-cpu-request: "10m"
  config.linkerd.io/proxy-memory-request: "20Mi"
  
  # Application-specific
  config.alpha.kubernetes.io/description: "Main web application"
```

## ðŸ”„ Advanced Naming and Labeling Patterns

### Multi-Tenant Naming
```yaml
# overlays/tenant-a/kustomization.yaml
namePrefix: tenant-a-
nameSuffix: -prod

commonLabels:
  tenant: tenant-a
  billing-account: tenant-a-production
  isolation-level: namespace

# overlays/tenant-b/kustomization.yaml  
namePrefix: tenant-b-
nameSuffix: -prod

commonLabels:
  tenant: tenant-b
  billing-account: tenant-b-production
  isolation-level: namespace
```

### Feature Flag Management
```yaml
# overlays/features/feature-new-ui/kustomization.yaml
namePrefix: new-ui-
nameSuffix: -beta

commonLabels:
  feature-flag: new-ui
  feature-state: beta
  canary-deployment: "true"
  traffic-percentage: "10"

commonAnnotations:
  feature.description: "New UI implementation"
  feature.jira-ticket: "WEBAPP-1234"
  feature.owner: "ui-team@company.com"
```

### Geographic/Regional Naming
```yaml
# overlays/regions/us-east-1/kustomization.yaml
namePrefix: use1-
nameSuffix: -prod

commonLabels:
  region: us-east-1
  availability-zone: us-east-1a
  data-residency: us
  latency-tier: low

# overlays/regions/eu-west-1/kustomization.yaml
namePrefix: euw1-  
nameSuffix: -prod

commonLabels:
  region: eu-west-1
  availability-zone: eu-west-1b
  data-residency: eu
  compliance: gdpr
```

## ðŸŽ¯ Selector Behavior and Label Management

### Understanding Selector Propagation
```yaml
# Original deployment.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: webapp
  labels:
    app: webapp                    # Will be enhanced by commonLabels
spec:
  selector:
    matchLabels:
      app: webapp                  # Kustomize updates this automatically
  template:
    metadata:
      labels:
        app: webapp               # Kustomize updates this automatically

# After kustomization with commonLabels:
# Deployment labels: app: webapp + all commonLabels
# Selector matchLabels: app: webapp + all commonLabels  
# Pod template labels: app: webapp + all commonLabels
```

### Service Selector Behavior
```yaml
# Original service.yaml
apiVersion: v1
kind: Service
metadata:
  name: webapp-service
spec:
  selector:
    app: webapp                   # Kustomize updates this

# After kustomization:
# Service selector will match pods with enhanced labels
# Service can find pods even with additional commonLabels
```

### Label Selector Conflicts
```yaml
# âŒ PROBLEMATIC: Conflicting selectors
# base/deployment.yaml
spec:
  selector:
    matchLabels:
      app: webapp
      version: v1              # Hardcoded version

# overlay with commonLabels
commonLabels:
  version: v2                  # Conflicts with hardcoded v1

# âœ… SOLUTION: Use generic selectors in base
spec:
  selector:
    matchLabels:
      app: webapp             # Only use stable selectors
      # Let version be added by commonLabels
```

## ðŸ§ª Practical Examples

### Complete Environment Setup
```yaml
# overlays/dev/kustomization.yaml
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

resources:
  - ../../base

namePrefix: dev-
nameSuffix: -v1

commonLabels:
  # Standard labels
  app: webapp
  environment: development
  version: v1.0.0
  
  # Kubernetes recommended labels
  app.kubernetes.io/name: webapp
  app.kubernetes.io/instance: webapp-dev
  app.kubernetes.io/version: v1.0.0
  app.kubernetes.io/component: backend
  app.kubernetes.io/part-of: ecommerce
  app.kubernetes.io/managed-by: kustomize
  
  # Custom operational labels
  team: platform
  cost-center: engineering
  tier: non-production
  auto-cleanup: enabled

commonAnnotations:
  # Environment metadata
  environment: development
  deployed-by: kustomize
  deployment-time: "2024-02-03T14:30:00Z"
  
  # Operational metadata
  contact.team: platform-team@company.com
  contact.slack: "#platform-support"
  documentation: https://wiki.company.com/webapp-dev
  
  # Development-specific
  debug.enabled: "true"
  hot-reload.enabled: "true"
  profiling.enabled: "true"
```

### Blue-Green Deployment Example
```yaml
# overlays/blue-green/blue/kustomization.yaml
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

resources:
  - ../../../base

namePrefix: blue-
nameSuffix: -current

commonLabels:
  app: webapp
  deployment-strategy: blue-green
  deployment-slot: blue
  version: v2.1.0
  traffic-routing: active

commonAnnotations:
  deployment-strategy: blue-green
  deployment-slot: blue
  traffic-weight: "100"
  deployment-time: "2024-02-03T14:30:00Z"
  previous-version: v2.0.8

images:
  - name: webapp
    newTag: v2.1.0

# overlays/blue-green/green/kustomization.yaml
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

resources:
  - ../../../base

namePrefix: green-
nameSuffix: -standby

commonLabels:
  app: webapp
  deployment-strategy: blue-green
  deployment-slot: green
  version: v2.2.0
  traffic-routing: standby

commonAnnotations:
  deployment-strategy: blue-green
  deployment-slot: green
  traffic-weight: "0"
  deployment-time: "2024-02-03T15:00:00Z"
  target-version: v2.2.0

images:
  - name: webapp
    newTag: v2.2.0
```

## ðŸ” Validation and Testing

### Label and Name Validation
```bash
# Validate naming transformations
kubectl kustomize overlays/dev | grep "name:"
kubectl kustomize overlays/dev | yq e '.metadata.name' -

# Validate label propagation
kubectl kustomize overlays/dev | yq e '.metadata.labels' -

# Check selector consistency
kubectl kustomize overlays/dev | yq e 'select(.kind == "Deployment") | .spec.selector.matchLabels' -
kubectl kustomize overlays/dev | yq e 'select(.kind == "Service") | .spec.selector' -

# Validate annotation application
kubectl kustomize overlays/dev | yq e '.metadata.annotations' -
```

### Label Selector Testing
```bash
# Test label selectors work correctly
kubectl kustomize overlays/dev > dev-manifest.yaml
kubectl apply -f dev-manifest.yaml --dry-run=client

# Verify service can find pods
kubectl get pods -l app=webapp,environment=development
kubectl get svc dev-webapp-service-v1 -o yaml | yq e '.spec.selector' -
```

### Resource Identification
```bash
# Find resources by labels
kubectl get all -l app=webapp
kubectl get all -l environment=development
kubectl get all -l team=platform

# Find resources by name patterns
kubectl get all | grep dev-
kubectl get all | grep -v1

# Complex label queries
kubectl get pods -l 'app in (webapp,api),environment!=production'
kubectl get pods -l 'tier=non-production,auto-cleanup=enabled'
```

## ðŸ“ Practice Exercise

### Exercise 1: Multi-Environment Naming
```bash
# Create environment-specific configurations
mkdir -p naming-practice/{base,overlays/{dev,staging,prod}}

# Base configuration (no naming)
cat > naming-practice/base/kustomization.yaml << 'EOF'
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

resources:
  - deployment.yaml
  - service.yaml

commonLabels:
  app: webapp
  managed-by: kustomize
EOF

# Development overlay  
cat > naming-practice/overlays/dev/kustomization.yaml << 'EOF'
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

resources:
  - ../../base

namePrefix: dev-
nameSuffix: -v1

commonLabels:
  environment: development
  tier: non-production
  team: platform

commonAnnotations:
  environment: development
  auto-cleanup: "true"
EOF

# Test the naming
kubectl kustomize naming-practice/overlays/dev
```

### Exercise 2: Label Management
```bash
# Create label-focused configuration
cat > label-example.yaml << 'EOF'
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

resources:
  - deployment.yaml

commonLabels:
  # Standard app labels
  app: myapp
  version: v1.0.0
  
  # Kubernetes recommended labels
  app.kubernetes.io/name: myapp
  app.kubernetes.io/version: v1.0.0
  app.kubernetes.io/component: backend
  
  # Operational labels
  team: platform
  environment: development
  cost-center: engineering

commonAnnotations:
  prometheus.io/scrape: "true"
  prometheus.io/port: "9090"
  contact.team: platform@company.com
EOF

# Validate label application
kubectl kustomize . --filename=label-example.yaml
```

## ðŸŽ¯ Best Practices

### Naming Conventions
```yaml
# âœ… DO: Use consistent naming patterns
namePrefix: dev-                    # Environment-based prefixes
nameSuffix: -v1                     # Version-based suffixes

# âœ… DO: Keep names DNS-compliant  
namePrefix: feature-auth-           # Use hyphens, lowercase
# âŒ DON'T: feature_auth_ or FeatureAuth

# âœ… DO: Use meaningful prefixes
namePrefix: canary-                 # Indicates deployment type
namePrefix: hotfix-                 # Indicates urgency/type
```

### Label Strategy
```yaml
# âœ… DO: Use hierarchical labeling
commonLabels:
  app: webapp                       # Application level
  component: backend                # Component level  
  tier: production                  # Environment level
  team: platform                    # Organizational level

# âœ… DO: Follow Kubernetes recommendations
app.kubernetes.io/name: webapp
app.kubernetes.io/component: backend
app.kubernetes.io/part-of: ecommerce
app.kubernetes.io/managed-by: kustomize

# âŒ DON'T: Use dynamic values in labels that affect selectors
# version: ${CURRENT_TIMESTAMP}     # Will break selectors
```

### Annotation Guidelines
```yaml
# âœ… DO: Use annotations for metadata
commonAnnotations:
  contact.team: platform@company.com    # Contact information
  documentation: https://wiki.com/app   # Documentation links
  deployment-time: "2024-02-03"         # Deployment metadata

# âœ… DO: Use tool-specific annotations appropriately
prometheus.io/scrape: "true"            # Monitoring
linkerd.io/inject: enabled              # Service mesh
```

## âš¡ Quick Reference

### Naming Quick Reference
```yaml
namePrefix: dev-           # Adds prefix to all resource names
nameSuffix: -v1           # Adds suffix to all resource names
# Result: webapp becomes dev-webapp-v1
```

### Labels Quick Reference  
```yaml
commonLabels:             # Applied to all resources and selectors
  app: webapp
  environment: dev
  
commonAnnotations:        # Applied to all resources (not selectors)
  team: platform
  contact: team@company.com
```

### Validation Commands
```bash
kubectl kustomize . | grep "name:"              # Check naming
kubectl kustomize . | yq e '.metadata.labels' - # Check labels
kubectl get pods -l app=webapp                  # Test selectors
```

## âž¡ï¸ Next Steps
Now that you've mastered naming and labeling strategies, proceed to [7. Practice-Create-Base-Plus-Dev-Prod.md](7.%20Practice-Create-Base-Plus-Dev-Prod.md) to apply these concepts in a comprehensive hands-on exercise creating base configurations with development and production overlays.