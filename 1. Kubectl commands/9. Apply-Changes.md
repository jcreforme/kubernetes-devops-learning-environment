# Apply Changes - ConfigMap Updates

## [ ] Understanding pod restarts after ConfigMap updates

### ConfigMap Update Behavior

**Critical Understanding:**
- **Environment variables** from ConfigMaps are NOT updated automatically
- **Volume mounts** from ConfigMaps ARE updated automatically (with delay)
- **Pods must be restarted** to see environment variable changes
- **Volume updates** happen within ~1 minute (configurable)

### Environment Variables vs Volume Mounts

#### Environment Variables (Static)
```bash
# Environment variables are set at pod creation time
# They do NOT change when ConfigMap is updated
# Pod restart is REQUIRED for changes

# Example: Pod with ConfigMap environment variables
apiVersion: v1
kind: Pod
spec:
  containers:
  - name: app
    env:
    - name: DATABASE_HOST
      valueFrom:
        configMapKeyRef:
          name: app-config
          key: database_host
    envFrom:
    - configMapRef:
        name: app-config
```

#### Volume Mounts (Dynamic)
```bash
# Volume mounts are updated automatically
# Changes appear in mounted files within ~1 minute
# NO pod restart required

# Example: Pod with ConfigMap volume mount
apiVersion: v1
kind: Pod
spec:
  containers:
  - name: app
    volumeMounts:
    - name: config-volume
      mountPath: /etc/config
  volumes:
  - name: config-volume
    configMap:
      name: app-config
```

## Testing ConfigMap Updates

### Update ConfigMap and Verify Changes
```bash
# 1. Create initial ConfigMap
kubectl create configmap test-config \
  --from-literal=database_host=original-host \
  --from-literal=debug_mode=false

# 2. Create test pod with both env vars and volume mount
cat << EOF | kubectl apply -f -
apiVersion: v1
kind: Pod
metadata:
  name: config-test-pod
spec:
  containers:
  - name: app
    image: busybox
    command: ["/bin/sh", "-c"]
    args: ["while true; do echo 'ENV: DATABASE_HOST='$DATABASE_HOST; echo 'FILE:'; cat /etc/config/database_host 2>/dev/null || echo 'file not found'; sleep 30; done"]
    env:
    - name: DATABASE_HOST
      valueFrom:
        configMapKeyRef:
          name: test-config
          key: database_host
    volumeMounts:
    - name: config-volume
      mountPath: /etc/config
  volumes:
  - name: config-volume
    configMap:
      name: test-config
EOF

# 3. Check initial values
kubectl logs config-test-pod --tail=5

# 4. Update ConfigMap
kubectl patch configmap test-config -p '{"data":{"database_host":"updated-host"}}'

# 5. Check values after update
# Environment variable: Still shows "original-host" (unchanged)
# File content: Shows "updated-host" (after ~1 minute)
kubectl logs config-test-pod --tail=10

# 6. Verify file was updated (volume mount)
kubectl exec config-test-pod -- cat /etc/config/database_host

# 7. Verify environment variable unchanged
kubectl exec config-test-pod -- echo $DATABASE_HOST
```

## Pod Restart Strategies

### Method 1: Rolling Restart (Recommended)
```bash
# Restart deployment to pick up ConfigMap changes
kubectl rollout restart deployment/<deployment-name>

# Check rollout status
kubectl rollout status deployment/<deployment-name>

# This performs a rolling update, maintaining availability
```

### Method 2: Delete Pods (For ReplicaSets/Deployments)
```bash
# Delete pods - ReplicaSet/Deployment will recreate them
kubectl delete pods -l app=myapp

# Pods are recreated automatically with new ConfigMap values
# Causes temporary downtime
```

### Method 3: Scale to Zero and Back
```bash
# Scale down to zero (causes downtime)
kubectl scale deployment myapp --replicas=0

# Wait for pods to terminate
kubectl get pods -l app=myapp

# Scale back up
kubectl scale deployment myapp --replicas=3

# Not recommended for production
```

### Method 4: Force Restart with Annotation
```bash
# Add restart annotation to force deployment update
kubectl patch deployment myapp -p \
  '{"spec":{"template":{"metadata":{"annotations":{"kubectl.kubernetes.io/restartedAt":"'$(date +%Y-%m-%dT%H:%M:%S%z)'"}}}}}'

# This triggers a rolling update
kubectl rollout status deployment/myapp
```

## Automated ConfigMap Reloading

### Using Reloader (Third-party tool)
```bash
# Install Reloader (automatically restarts pods when ConfigMap changes)
kubectl apply -f https://raw.githubusercontent.com/stakater/Reloader/master/deployments/kubernetes/reloader.yaml

# Add annotation to deployment to enable auto-reload
kubectl annotate deployment myapp configmap.reloader.stakater.com/reload="app-config"

# Now pods will automatically restart when app-config ConfigMap changes
```

### Using ConfigMap Hash in Deployment
```yaml
# Include ConfigMap hash in deployment template to force updates
apiVersion: apps/v1
kind: Deployment
spec:
  template:
    metadata:
      annotations:
        configmap/hash: "{{ configmap-hash }}"  # Updated by CI/CD
    spec:
      containers:
      - name: app
        image: myapp:latest
        envFrom:
        - configMapRef:
            name: app-config
```

## Monitoring ConfigMap Changes

### Check ConfigMap Update Time
```bash
# Check when ConfigMap was last modified
kubectl get configmap app-config -o jsonpath='{.metadata.resourceVersion}'

# Get ConfigMap creation time
kubectl get configmap app-config -o jsonpath='{.metadata.creationTimestamp}'

# Compare ConfigMap versions
kubectl get configmap app-config -o yaml > current-config.yaml
```

### Monitor Pod Restarts
```bash
# Check pod restart count after ConfigMap update
kubectl get pods -l app=myapp -o custom-columns=NAME:.metadata.name,RESTARTS:.status.containerStatuses[0].restartCount

# Check pod ages (newly restarted pods will be younger)
kubectl get pods -l app=myapp -o wide

# Watch pod events during restart
kubectl get events --sort-by=.metadata.creationTimestamp
```

## Volume Mount Update Timing

### ConfigMap Volume Update Process
```bash
# Volume mounts are updated via kubelet sync
# Default sync period: 1 minute
# Can be configured with --sync-frequency flag on kubelet

# Check current file in pod
kubectl exec pod-name -- cat /etc/config/config-file

# Update ConfigMap
kubectl patch configmap my-config -p '{"data":{"config-file":"new-content"}}'

# Wait up to sync period (default 1 minute)
# Check file again - should show updated content
kubectl exec pod-name -- cat /etc/config/config-file
```

### Subpath Volume Mounts
```bash
# Important: Subpath mounts are NOT updated automatically
# These require pod restart even for file changes

# Example subpath mount (NOT auto-updated):
volumeMounts:
- name: config-volume
  mountPath: /etc/nginx/nginx.conf
  subPath: nginx.conf  # This will NOT update automatically

# Regular mount (auto-updated):
volumeMounts:
- name: config-volume
  mountPath: /etc/nginx/  # Files in this directory will update
```

## Best Practices for ConfigMap Updates

### 1. Design for Updates
```bash
# Use volume mounts for config files that need dynamic updates
# Use environment variables for static configuration
# Consider using both for different types of configuration
```

### 2. Update Strategy Planning
```bash
# Plan restart strategy based on application type:
# - Stateless apps: Rolling restart is fine
# - Stateful apps: May need careful restart planning
# - Critical apps: Consider blue-green deployment
```

### 3. Testing Updates
```bash
# Always test ConfigMap updates in non-production first
# Verify both environment variables and volume mounts
# Check application behavior after restart
```

### 4. Monitoring and Validation
```bash
# Monitor application health after ConfigMap updates
# Validate configuration is correctly applied
# Have rollback plan ready
```

## Quick Reference Commands

```bash
# Update ConfigMap
kubectl patch configmap app-config -p '{"data":{"key":"new-value"}}'

# Restart deployment to pick up changes
kubectl rollout restart deployment/myapp

# Check restart status
kubectl rollout status deployment/myapp

# Verify environment variables (requires restart)
kubectl exec deployment/myapp -- env | grep CONFIG

# Check volume mount files (updates automatically)
kubectl exec deployment/myapp -- cat /etc/config/config-file

# Monitor pod restarts
kubectl get pods -l app=myapp --watch
```

## Summary Table

| Update Type | Automatic Update | Restart Required | Update Time |
|-------------|------------------|------------------|-------------|
| Environment Variables | ❌ No | ✅ Yes | Immediate after restart |
| Volume Mounts | ✅ Yes | ❌ No | ~1 minute |
| Subpath Mounts | ❌ No | ✅ Yes | Immediate after restart |
| Command/Args | ❌ No | ✅ Yes | Immediate after restart |