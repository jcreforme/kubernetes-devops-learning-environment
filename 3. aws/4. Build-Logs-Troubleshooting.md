# 4. Build Logs and Troubleshooting

## üéØ Learning Objectives
- [ ] Access and navigate CodeBuild logs
- [ ] Understand different log levels and formats
- [ ] Master troubleshooting failed builds
- [ ] Learn to identify common build issues
- [ ] Implement effective debugging strategies

## üìä Accessing Build Logs

### CodeBuild Console Logs
```
Navigation Path:
AWS Console ‚Üí CodeBuild ‚Üí Build Projects ‚Üí [Project Name] ‚Üí Build History ‚Üí [Build Run]

Log Sections Available:
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ Build Logs                              ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ Phase details                           ‚îÇ
‚îÇ ‚îú‚îÄ‚îÄ Install       ‚úÖ 2m 34s            ‚îÇ
‚îÇ ‚îú‚îÄ‚îÄ Pre_build     ‚úÖ 1m 12s            ‚îÇ
‚îÇ ‚îú‚îÄ‚îÄ Build         ‚ùå 0m 45s            ‚îÇ
‚îÇ ‚îî‚îÄ‚îÄ Post_build    ‚è∏Ô∏è  Not executed     ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ Complete logs                           ‚îÇ
‚îÇ Environment logs                        ‚îÇ
‚îÇ S3 logs (if configured)                ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### CloudWatch Logs Integration
```bash
# CodeBuild automatically creates log groups:
/aws/codebuild/[project-name]

# Log stream naming pattern:
[build-id]

# Example:
/aws/codebuild/my-web-app-build
‚îú‚îÄ‚îÄ a1b2c3d4-e5f6-7890-abcd-ef1234567890
‚îú‚îÄ‚îÄ b2c3d4e5-f6g7-8901-bcde-f21234567890
‚îî‚îÄ‚îÄ c3d4e5f6-g7h8-9012-cdef-321234567890
```

### Direct CloudWatch Access
```bash
# AWS CLI to get logs
aws logs get-log-events \
  --log-group-name "/aws/codebuild/my-project" \
  --log-stream-name "a1b2c3d4-e5f6-7890-abcd-ef1234567890" \
  --start-time 1609459200000

# Filter logs with specific pattern
aws logs filter-log-events \
  --log-group-name "/aws/codebuild/my-project" \
  --filter-pattern "ERROR" \
  --start-time 1609459200000
```

## üìã Understanding Log Structure

### Log Entry Format
```
[Container] YYYY/MM/DD HH:MM:SS Running command [COMMAND]
[Container] YYYY/MM/DD HH:MM:SS Phase complete: [PHASE] State: [STATE] Duration: [TIME]
[Container] YYYY/MM/DD HH:MM:SS Phase context status code: [CODE] Message: [MESSAGE]

Examples:
[Container] 2024/02/03 14:30:15 Running command npm install
[Container] 2024/02/03 14:32:45 Phase complete: INSTALL State: SUCCEEDED Duration: 2m 30s
[Container] 2024/02/03 14:32:46 Phase context status code: 0 Message: 
```

### Phase States and Status Codes
```
Phase States:
‚úÖ SUCCEEDED (0)    - Phase completed successfully
‚ùå FAILED (non-zero) - Phase failed with error
‚è∏Ô∏è STOPPED          - Build was manually stopped
üîÑ IN_PROGRESS      - Phase currently executing
‚è≠Ô∏è TIMED_OUT        - Phase exceeded timeout limit

Common Exit Codes:
0   - Success
1   - General error
2   - Misuse of shell built-ins
126 - Command invoked cannot execute
127 - Command not found
128 - Invalid argument to exit
130 - Script terminated by Ctrl+C
```

### Log Levels and Types
```
Environment Setup Logs:
[Container] 2024/02/03 14:30:00 Waiting for agent ping
[Container] 2024/02/03 14:30:01 Waiting for DOWNLOAD_SOURCE
[Container] 2024/02/03 14:30:02 Phase complete: DOWNLOAD_SOURCE State: SUCCEEDED

Command Execution Logs:
[Container] 2024/02/03 14:30:15 Running command npm ci
[Container] 2024/02/03 14:30:16 npm WARN using --force Recommended protections disabled.

Error Logs:
[Container] 2024/02/03 14:31:20 Command did not exit successfully npm run build exit status 1
[Container] 2024/02/03 14:31:20 Phase complete: BUILD State: FAILED
```

## üîç Common Build Issues and Solutions

### Dependency Installation Failures
```bash
# Common Error Pattern:
[Container] 2024/02/03 14:30:20 npm ERR! network request to https://registry.npmjs.org/package failed
[Container] 2024/02/03 14:30:20 npm ERR! network timeout

# Troubleshooting Steps:
1. Check network connectivity
2. Verify package registry accessibility
3. Implement retry logic
4. Use local caching

# Solutions in buildspec.yml:
phases:
  install:
    commands:
      # Add retry logic
      - npm ci --retry=3 --retry-delay=10000
      # Use specific registry
      - npm config set registry https://registry.npmjs.org/
      # Clear npm cache if needed
      - npm cache clean --force
```

### Build Command Failures
```bash
# Common Error Pattern:
[Container] 2024/02/03 14:32:15 > myapp@1.0.0 build
[Container] 2024/02/03 14:32:15 > webpack --mode production
[Container] 2024/02/03 14:32:16 ERROR in ./src/index.js Module not found: Error: Can't resolve './config'
[Container] 2024/02/03 14:32:16 Command did not exit successfully npm run build exit status 1

# Troubleshooting Steps:
1. Verify source code completeness
2. Check file paths and imports
3. Validate environment-specific configurations
4. Review build tool configurations

# Solutions:
phases:
  pre_build:
    commands:
      # Verify source structure
      - find src -name "*.js" -type f | head -20
      # Check for required files
      - test -f src/config.js || echo "Warning: config.js missing"
  
  build:
    commands:
      # Add verbose logging
      - npm run build --verbose
      # List output directory after build
      - ls -la dist/ || echo "Build output directory not created"
```

### Environment and Runtime Issues
```bash
# Common Error Pattern:
[Container] 2024/02/03 14:30:10 COMMAND_EXECUTION_ERROR: Error while executing command: npm ci
[Container] 2024/02/03 14:30:10 Reason: exit status 127

# Troubleshooting Steps:
1. Verify runtime versions
2. Check command availability
3. Validate environment setup
4. Review PATH configuration

# Solutions in buildspec.yml:
phases:
  install:
    runtime-versions:
      nodejs: 18  # Specify explicit version
    commands:
      # Verify runtime installation
      - node --version
      - npm --version
      # Check command availability
      - which npm || (echo "npm not found" && exit 1)
      # Install missing tools
      - npm install -g yarn
```

### Permission and Access Issues
```bash
# Common Error Pattern:
[Container] 2024/02/03 14:31:00 aws: error: Unable to locate credentials
[Container] 2024/02/03 14:31:00 Command did not exit successfully aws s3 cp dist/ s3://my-bucket/ --recursive exit status 255

# Troubleshooting Steps:
1. Review IAM role permissions
2. Check service role attachment
3. Verify resource access policies
4. Test AWS CLI configuration

# Solutions:
phases:
  pre_build:
    commands:
      # Verify AWS credentials
      - aws sts get-caller-identity
      # Test S3 access
      - aws s3 ls s3://my-bucket/ || echo "S3 access denied"
      # Check ECR login
      - aws ecr get-login-password --region $AWS_DEFAULT_REGION | docker login --username AWS --password-stdin $REPOSITORY_URI
```

### Memory and Resource Issues
```bash
# Common Error Pattern:
[Container] 2024/02/03 14:35:20 SIGKILL received
[Container] 2024/02/03 14:35:20 Command did not exit successfully npm run build exit status 137
[Container] 2024/02/03 14:35:20 Phase complete: BUILD State: FAILED

# Troubleshooting Steps:
1. Monitor memory usage during build
2. Optimize build process
3. Increase compute type
4. Implement memory-efficient strategies

# Solutions:
phases:
  build:
    commands:
      # Monitor memory usage
      - free -h
      # Optimize Node.js memory
      - export NODE_OPTIONS="--max-old-space-size=4096"
      # Build with limited parallelism
      - npm run build -- --max-workers=2
      # Clean up during build
      - npm run build && npm cache clean --force
```

## üõ†Ô∏è Advanced Troubleshooting Techniques

### Debugging with Enhanced Logging
```yaml
# Enhanced buildspec.yml for debugging
version: 0.2

env:
  variables:
    DEBUG: "true"
    VERBOSE: "true"

phases:
  pre_build:
    commands:
      # System information
      - echo "=== System Information ==="
      - uname -a
      - df -h
      - free -m
      - env | sort
      
      # Build environment details
      - echo "=== Build Environment ==="
      - echo "CodeBuild Build ID: $CODEBUILD_BUILD_ID"
      - echo "Source Version: $CODEBUILD_RESOLVED_SOURCE_VERSION"
      - echo "Branch: $CODEBUILD_WEBHOOK_HEAD_REF"
      
      # Dependency verification
      - echo "=== Dependencies ==="
      - node --version || echo "Node.js not available"
      - npm --version || echo "npm not available"
      - python3 --version || echo "Python not available"
      - docker --version || echo "Docker not available"

  build:
    commands:
      # Detailed build logging
      - echo "=== Starting Build Process ==="
      - set -x  # Enable command tracing
      - npm run build
      - set +x  # Disable command tracing
      - echo "=== Build Process Complete ==="
      
      # Post-build verification
      - echo "=== Build Artifacts ==="
      - find dist -type f | head -20
      - du -sh dist/ || echo "No dist directory"

  post_build:
    commands:
      # Build summary
      - echo "=== Build Summary ==="
      - echo "Build Status: $CODEBUILD_BUILD_SUCCEEDING"
      - echo "Build Duration: $(($SECONDS / 60))m $(($SECONDS % 60))s"
    
    finally:
      # Always collect debug information
      - echo "=== Debug Information ==="
      - ps aux | head -20
      - df -h
      - free -m
      - find /tmp -name "*.log" -type f | head -10
```

### Log Analysis Scripts
```bash
#!/bin/bash
# analyze-build-logs.sh - Analyze CodeBuild logs

BUILD_ID=$1
PROJECT_NAME=$2

if [[ -z "$BUILD_ID" || -z "$PROJECT_NAME" ]]; then
    echo "Usage: $0 <build-id> <project-name>"
    exit 1
fi

LOG_GROUP="/aws/codebuild/$PROJECT_NAME"

echo "Analyzing build logs for $BUILD_ID"

# Extract error messages
echo "=== Error Analysis ==="
aws logs filter-log-events \
    --log-group-name "$LOG_GROUP" \
    --log-stream-name "$BUILD_ID" \
    --filter-pattern "ERROR" \
    --query 'events[].message' \
    --output text

# Extract warning messages
echo "=== Warning Analysis ==="
aws logs filter-log-events \
    --log-group-name "$LOG_GROUP" \
    --log-stream-name "$BUILD_ID" \
    --filter-pattern "WARN" \
    --query 'events[].message' \
    --output text

# Extract phase failures
echo "=== Phase Failures ==="
aws logs filter-log-events \
    --log-group-name "$LOG_GROUP" \
    --log-stream-name "$BUILD_ID" \
    --filter-pattern "State: FAILED" \
    --query 'events[].message' \
    --output text

# Build duration analysis
echo "=== Phase Duration Analysis ==="
aws logs filter-log-events \
    --log-group-name "$LOG_GROUP" \
    --log-stream-name "$BUILD_ID" \
    --filter-pattern "Duration:" \
    --query 'events[].message' \
    --output text
```

### Interactive Debugging Session
```yaml
# Debug buildspec.yml with interactive session
version: 0.2

phases:
  build:
    commands:
      # Enable interactive debugging when needed
      - |
        if [ "$ENABLE_DEBUG" = "true" ]; then
          echo "Starting debug session..."
          # Install debugging tools
          apt-get update && apt-get install -y htop strace
          
          # Run interactive commands
          echo "Current directory: $(pwd)"
          echo "Files in current directory:"
          ls -la
          
          echo "Environment variables:"
          env | grep -E "(CODEBUILD_|AWS_|NODE_|NPM_)" | sort
          
          echo "System resources:"
          free -h
          df -h
          
          # Pause for manual investigation (remove for automated builds)
          # read -p "Press Enter to continue..."
        fi
      
      # Continue with normal build
      - npm run build
```

## üìä Log Monitoring and Alerting

### CloudWatch Metrics and Alarms
```json
{
  "MetricName": "FailedBuilds",
  "Namespace": "AWS/CodeBuild",
  "Dimensions": [
    {
      "Name": "ProjectName",
      "Value": "my-web-app-build"
    }
  ],
  "Statistic": "Sum",
  "Period": 300,
  "EvaluationPeriods": 1,
  "Threshold": 1,
  "ComparisonOperator": "GreaterThanOrEqualToThreshold"
}
```

### Custom Log Analysis with CloudWatch Insights
```sql
-- Find all failed builds in the last 24 hours
fields @timestamp, @message
| filter @message like /FAILED/
| filter @timestamp > dateadd(hour, -24, now())
| sort @timestamp desc

-- Analyze build durations
fields @timestamp, @message
| filter @message like /Duration:/
| parse @message "Duration: * " as duration
| stats avg(duration) by bin(5m)

-- Find memory-related failures
fields @timestamp, @message
| filter @message like /SIGKILL/ or @message like /out of memory/
| sort @timestamp desc
```

### Automated Error Notification
```yaml
# Lambda function for build failure notifications
import json
import boto3
import os

def lambda_handler(event, context):
    # Parse CloudWatch event
    detail = event['detail']
    project_name = detail['project-name']
    build_status = detail['build-status']
    build_id = detail['build-id']
    
    if build_status == 'FAILED':
        # Get build logs
        logs_client = boto3.client('logs')
        log_group = f"/aws/codebuild/{project_name}"
        
        try:
            response = logs_client.filter_log_events(
                logGroupName=log_group,
                logStreamNames=[build_id],
                filterPattern='ERROR'
            )
            
            error_messages = [event['message'] for event in response['events']]
            
            # Send notification (SNS, Slack, etc.)
            send_notification({
                'project': project_name,
                'build_id': build_id,
                'status': build_status,
                'errors': error_messages[:5]  # First 5 errors
            })
            
        except Exception as e:
            print(f"Error processing build failure: {str(e)}")
    
    return {'statusCode': 200}
```

## üìù Practice Exercises

### Exercise 1: Log Navigation
1. **Access a failed build** in CodeBuild console
2. **Navigate through different log sections**
3. **Identify the specific failure point**
4. **Extract relevant error messages**

### Exercise 2: Debug Build Issues
1. **Create a buildspec.yml** with intentional errors
2. **Run the build** and analyze failure logs
3. **Fix the issues** one by one
4. **Document troubleshooting steps**

### Exercise 3: Advanced Log Analysis
1. **Set up CloudWatch Insights queries**
2. **Create custom log analysis scripts**
3. **Implement error alerting**
4. **Build a troubleshooting runbook**

## üéì Troubleshooting Best Practices

### Proactive Debugging
- ‚úÖ Implement comprehensive logging throughout build process
- ‚úÖ Use meaningful commit messages for better context
- ‚úÖ Add health checks and validation steps
- ‚úÖ Monitor build performance trends
- ‚úÖ Set up automated failure notifications

### Efficient Problem Solving
- ‚úÖ Start with the most recent error messages
- ‚úÖ Check for environment or dependency changes
- ‚úÖ Verify IAM permissions and access rights
- ‚úÖ Test build steps locally when possible
- ‚úÖ Use systematic elimination approach

### Documentation and Knowledge Sharing
- ‚úÖ Document common issues and solutions
- ‚úÖ Create troubleshooting runbooks
- ‚úÖ Share knowledge with team members
- ‚úÖ Maintain build configuration versioning
- ‚úÖ Regular review of build processes and optimizations

## üö® Emergency Troubleshooting Checklist

### When Build Fails Suddenly
1. ‚ö†Ô∏è **Check recent changes** - commits, configuration updates
2. ‚ö†Ô∏è **Verify external dependencies** - registries, APIs, services
3. ‚ö†Ô∏è **Review IAM permissions** - roles, policies, access keys
4. ‚ö†Ô∏è **Check resource availability** - compute limits, quotas
5. ‚ö†Ô∏è **Validate environment variables** - Parameter Store, Secrets Manager
6. ‚ö†Ô∏è **Test connectivity** - VPC, security groups, endpoints

### Quick Recovery Steps
1. üîÑ **Retry the build** - transient issues often resolve automatically
2. üîÑ **Rollback recent changes** - if issue started after recent updates
3. üîÑ **Use last known good configuration** - previous working buildspec
4. üîÑ **Scale up compute resources** - if resource-related failures
5. üîÑ **Clear caches** - dependencies, Docker layers, local caches
6. üîÑ **Switch to alternative approach** - different base image, tools

## ‚û°Ô∏è Next Steps
Now that you understand build logs and troubleshooting, proceed to [5. Pipeline-Practice.md](5.%20Pipeline-Practice.md) to practice triggering pipelines, reviewing build logs, and understanding artifacts in real scenarios.