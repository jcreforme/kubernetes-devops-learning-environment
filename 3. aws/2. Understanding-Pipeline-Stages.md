# 2. Understanding Pipeline Stages

## ğŸ¯ Learning Objectives
- [ ] Master the Source â†’ Build â†’ Deploy pipeline flow
- [ ] Understand stage dependencies and execution order
- [ ] Learn about stage actions and providers
- [ ] Identify stage inputs, outputs, and artifacts
- [ ] Recognize common pipeline patterns and variations

## ğŸ“‹ Pipeline Stage Architecture

### Standard Three-Stage Pattern
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   SOURCE   â”‚â”€â”€â”€â†’â”‚   BUILD    â”‚â”€â”€â”€â†’â”‚   DEPLOY   â”‚
â”‚            â”‚    â”‚            â”‚    â”‚            â”‚
â”‚ Git Repo   â”‚    â”‚ CodeBuild  â”‚    â”‚ ECS/Lambda â”‚
â”‚ S3 Bucket  â”‚    â”‚ Jenkins    â”‚    â”‚ EC2/Beanstalk â”‚
â”‚ CodeCommit â”‚    â”‚ Custom     â”‚    â”‚ S3 Static  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚                  â”‚                  â”‚
     â–¼                  â–¼                  â–¼
Source Artifact   Build Artifacts   Deployment
```

### Pipeline Flow Concepts
```
Execution Flow:
1. Pipeline triggered (manual/automatic)
2. Source stage fetches latest code
3. Build stage processes and tests code  
4. Deploy stage releases to target environment
5. Pipeline completes (success/failure)

Stage Dependencies:
- Each stage waits for previous to complete
- Failure in any stage stops pipeline
- Artifacts flow between stages
- Parallel actions within stages possible
```

## ğŸ”„ Source Stage Deep Dive

### Source Stage Purpose
```
Responsibilities:
âœ… Fetch source code or artifacts
âœ… Detect changes (triggers)
âœ… Create source artifact for downstream stages
âœ… Provide version/commit information
```

### Common Source Providers
```
GitHub:
â”œâ”€â”€ Repository: organization/repository-name
â”œâ”€â”€ Branch: main, develop, feature/*
â”œâ”€â”€ Webhook: Automatic trigger on push
â””â”€â”€ Output: Source code artifact

AWS CodeCommit:
â”œâ”€â”€ Repository: Internal AWS Git repository
â”œâ”€â”€ Branch: Any branch monitoring
â”œâ”€â”€ CloudWatch Events: Change detection
â””â”€â”€ Output: Source code artifact

Amazon S3:
â”œâ”€â”€ Bucket: s3://my-artifacts-bucket
â”œâ”€â”€ Object: application.zip, config.json
â”œâ”€â”€ Versioning: Object version tracking
â””â”€â”€ Output: File artifacts

Bitbucket:
â”œâ”€â”€ Repository: workspace/repository
â”œâ”€â”€ Branch: master, release/*
â”œâ”€â”€ Webhook: Push/PR triggers
â””â”€â”€ Output: Source code artifact
```

### Source Configuration Examples
```yaml
# GitHub Source Configuration
Source:
  ActionTypeId:
    Category: Source
    Owner: ThirdParty
    Provider: GitHub
    Version: '1'
  Configuration:
    Owner: myorganization
    Repo: my-web-app
    Branch: main
    OAuthToken: !Ref GitHubToken
  OutputArtifacts:
    - Name: SourceOutput
```

```yaml
# S3 Source Configuration  
Source:
  ActionTypeId:
    Category: Source
    Owner: AWS
    Provider: S3
    Version: '1'
  Configuration:
    S3Bucket: my-pipeline-artifacts
    S3ObjectKey: releases/app-v1.2.zip
    PollForSourceChanges: true
  OutputArtifacts:
    - Name: S3SourceOutput
```

## ğŸ”¨ Build Stage Deep Dive

### Build Stage Purpose
```
Responsibilities:
âœ… Compile/package source code
âœ… Run unit tests and code quality checks
âœ… Create deployment artifacts
âœ… Generate build reports and metrics
âœ… Cache dependencies for faster builds
```

### Common Build Providers
```
AWS CodeBuild:
â”œâ”€â”€ Managed build service
â”œâ”€â”€ Docker-based environments
â”œâ”€â”€ Scalable compute resources
â”œâ”€â”€ Integration with other AWS services
â””â”€â”€ Custom buildspec.yml configuration

Jenkins:
â”œâ”€â”€ Self-managed build server
â”œâ”€â”€ Extensive plugin ecosystem
â”œâ”€â”€ Custom build environments
â”œâ”€â”€ Advanced pipeline scripting
â””â”€â”€ On-premises or cloud deployment

AWS CodeStar:
â”œâ”€â”€ Integrated development experience
â”œâ”€â”€ Pre-configured build templates
â”œâ”€â”€ Project management integration
â””â”€â”€ Team collaboration features

Custom Build Actions:
â”œâ”€â”€ Lambda functions
â”œâ”€â”€ Step Functions
â”œâ”€â”€ External webhook calls
â””â”€â”€ Third-party build services
```

### Build Stage Configuration
```yaml
# CodeBuild Configuration
Build:
  ActionTypeId:
    Category: Build
    Owner: AWS
    Provider: CodeBuild
    Version: '1'
  Configuration:
    ProjectName: my-web-app-build
    PrimarySource: SourceOutput
  InputArtifacts:
    - Name: SourceOutput
  OutputArtifacts:
    - Name: BuildOutput
```

### Build Process Flow
```
Build Stage Execution:
1. Receive source artifacts from previous stage
2. Launch build environment (container/VM)
3. Download source code and dependencies
4. Execute build commands (buildspec.yml)
5. Run tests and quality gates
6. Package application artifacts
7. Upload artifacts to pipeline storage
8. Report build status and logs
```

## ğŸš€ Deploy Stage Deep Dive

### Deploy Stage Purpose
```
Responsibilities:
âœ… Deploy built artifacts to target environment
âœ… Execute deployment strategies (blue/green, rolling)
âœ… Run integration tests and health checks
âœ… Manage environment configuration
âœ… Handle deployment rollbacks if needed
```

### Common Deploy Providers
```
Amazon ECS:
â”œâ”€â”€ Container orchestration
â”œâ”€â”€ Service-based deployments
â”œâ”€â”€ Auto-scaling capabilities
â”œâ”€â”€ Load balancer integration
â””â”€â”€ Rolling/blue-green deployments

AWS Lambda:
â”œâ”€â”€ Serverless function deployment
â”œâ”€â”€ Version and alias management
â”œâ”€â”€ Automatic scaling
â”œâ”€â”€ Event-driven architecture
â””â”€â”€ Canary deployments

Amazon EC2/Auto Scaling:
â”œâ”€â”€ Virtual machine deployments
â”œâ”€â”€ CodeDeploy agent-based
â”œâ”€â”€ In-place and blue/green deployments
â”œâ”€â”€ Health check integration
â””â”€â”€ Rolling deployments

AWS Elastic Beanstalk:
â”œâ”€â”€ Platform-as-a-Service deployment
â”œâ”€â”€ Automatic capacity provisioning
â”œâ”€â”€ Health monitoring
â”œâ”€â”€ Configuration management
â””â”€â”€ Application version management

Amazon S3 (Static Sites):
â”œâ”€â”€ Static website hosting
â”œâ”€â”€ CloudFront integration
â”œâ”€â”€ High availability
â”œâ”€â”€ Cost-effective
â””â”€â”€ Global content delivery
```

### Deployment Strategies
```
Rolling Deployment:
â”Œâ”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”
â”‚ v1  â”‚ â”‚ v1  â”‚ â”‚ v1  â”‚ â”‚ v1  â”‚  Current
â””â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”
â”‚ v2  â”‚ â”‚ v1  â”‚ â”‚ v1  â”‚ â”‚ v1  â”‚  Step 1
â””â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”
â”‚ v2  â”‚ â”‚ v2  â”‚ â”‚ v2  â”‚ â”‚ v2  â”‚  Complete
â””â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”˜

Blue/Green Deployment:
Blue Environment (Current):
â”Œâ”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”
â”‚ v1  â”‚ â”‚ v1  â”‚ â”‚ v1  â”‚ â†â”€â”€ Traffic
â””â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”˜

Green Environment (New):
â”Œâ”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”
â”‚ v2  â”‚ â”‚ v2  â”‚ â”‚ v2  â”‚ â†â”€â”€ Switch Traffic
â””â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”˜
```

## ğŸ”— Stage Artifacts and Flow

### Artifact Management
```
Artifact Flow:
Source Stage â†’ Source Artifact â†’ Build Stage
Build Stage â†’ Build Artifact â†’ Deploy Stage
Deploy Stage â†’ Deployment Result

Artifact Storage:
- Temporary S3 bucket (managed by CodePipeline)
- Encrypted at rest and in transit
- Automatic cleanup after pipeline retention period
- Cross-region replication for multi-region deployments
```

### Artifact Types
```
Source Artifacts:
- Source code (Git repository contents)
- Configuration files
- Documentation
- Build scripts

Build Artifacts:
- Compiled binaries/executables
- Package files (JAR, ZIP, Docker images)
- Test reports
- Build metadata

Deploy Artifacts:
- Application packages
- Infrastructure templates
- Configuration manifests
- Deployment scripts
```

## ğŸ“Š Advanced Pipeline Patterns

### Multi-Environment Pipeline
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Source â”‚â†’â”‚ Build â”‚â†’â”‚ Dev     â”‚â†’â”‚ Staging â”‚â†’â”‚ Production â”‚
â”‚        â”‚ â”‚       â”‚ â”‚ Deploy  â”‚ â”‚ Deploy  â”‚ â”‚ Deploy     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚         â”‚            â”‚
                           â–¼         â–¼            â–¼
                       Dev Tests  Integration   UAT
                                     Tests    Testing
```

### Parallel Deployment Pipeline
```
                      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                   â”Œâ”€â†’â”‚ US-East-1   â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”  â”‚ Deploy      â”‚
â”‚ Source â”‚â†’â”‚ Build â”‚â”€â”€â”¤             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                   â””â”€â†’â”‚ EU-West-1   â”‚
                      â”‚ Deploy      â”‚
                      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Testing Integration Pipeline
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Source â”‚â†’â”‚ Build â”‚â†’â”‚ Unit     â”‚â†’â”‚ Deploy  â”‚â†’â”‚ E2E    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ Tests    â”‚ â”‚ Staging â”‚ â”‚ Tests  â”‚
                     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚            â”‚          â”‚
                           â–¼            â–¼          â–¼
                       Test Report   Health     Test
                       Generation    Checks    Reports
```

## ğŸ› ï¸ Stage Configuration Best Practices

### Source Stage Best Practices
```
âœ… Use webhook triggers for automatic pipeline execution
âœ… Monitor specific branches (main, develop, release/*)
âœ… Implement branch protection rules
âœ… Use meaningful commit messages for pipeline tracking
âœ… Tag releases for version tracking
```

### Build Stage Best Practices
```
âœ… Use caching to speed up builds
âœ… Run tests in parallel when possible
âœ… Implement quality gates (code coverage, security scans)
âœ… Generate consistent artifact naming
âœ… Store build logs for troubleshooting
```

### Deploy Stage Best Practices
```
âœ… Use deployment strategies appropriate for your application
âœ… Implement health checks and rollback mechanisms
âœ… Use environment-specific configuration
âœ… Monitor deployment metrics and alerts
âœ… Document deployment procedures and rollback plans
```

## ğŸ“ Practice Exercises

### Exercise 1: Stage Identification
1. **Open a pipeline** in the AWS console
2. **Identify each stage** and its purpose
3. **Examine stage actions** and their configurations
4. **Trace artifact flow** between stages

### Exercise 2: Stage Analysis
1. **Click into each stage** to view details
2. **Review input and output artifacts**
3. **Understand stage dependencies**
4. **Identify potential bottlenecks**

### Exercise 3: Pipeline Comparison
1. **Compare different pipeline architectures**
2. **Identify patterns and variations**
3. **Analyze stage complexity**
4. **Document common patterns**

## ğŸ“ Stage Design Principles

### Design Considerations
- **Separation of Concerns**: Each stage should have a single responsibility
- **Artifact Immutability**: Build once, deploy many times
- **Environment Parity**: Consistent environments across stages
- **Fail Fast**: Early detection of issues to reduce feedback time
- **Observability**: Comprehensive logging and monitoring

### Performance Optimization
- **Parallel Execution**: Run independent actions in parallel
- **Caching Strategies**: Cache dependencies and build artifacts
- **Resource Right-Sizing**: Match compute resources to workload needs
- **Artifact Optimization**: Minimize artifact sizes for faster transfers

## ğŸš¨ Common Stage Issues

### Source Stage Issues
```
âŒ Webhook not triggering pipeline
Solution: Verify webhook configuration and permissions

âŒ Wrong branch being monitored
Solution: Check branch configuration in source action

âŒ Access denied to repository
Solution: Validate OAuth tokens or IAM permissions
```

### Build Stage Issues
```
âŒ Build timeouts
Solution: Optimize build process or increase timeout settings

âŒ Test failures blocking pipeline
Solution: Review test results and fix failing tests

âŒ Artifact upload failures
Solution: Check S3 permissions and bucket configuration
```

### Deploy Stage Issues
```
âŒ Deployment rollback due to health check failures
Solution: Review application logs and health check configuration

âŒ Environment configuration errors
Solution: Validate environment-specific parameters

âŒ Insufficient deployment permissions
Solution: Review IAM roles and policies for deployment actions
```

## â¡ï¸ Next Steps
Now that you understand pipeline stage architecture, proceed to [3. CodeBuild-Basics.md](3.%20CodeBuild-Basics.md) to dive deep into CodeBuild projects and buildspec.yml configuration.