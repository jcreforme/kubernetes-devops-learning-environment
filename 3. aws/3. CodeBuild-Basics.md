# 3. CodeBuild Basics

## ğŸ¯ Learning Objectives
- [ ] Master buildspec.yml structure and syntax
- [ ] Understand CodeBuild environment configuration
- [ ] Learn environment variables and parameter usage
- [ ] Configure build phases and commands
- [ ] Implement caching and optimization strategies

## ğŸ“‹ CodeBuild Overview

### What is AWS CodeBuild?
```
AWS CodeBuild is a fully managed build service that:
âœ… Compiles source code
âœ… Runs unit tests
âœ… Produces deployment artifacts
âœ… Scales automatically
âœ… Integrates with other AWS services
âœ… Supports multiple programming languages and frameworks
```

### CodeBuild Architecture
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Source    â”‚â”€â”€â”€â†’â”‚   CodeBuild     â”‚â”€â”€â”€â†’â”‚  Artifacts   â”‚
â”‚             â”‚    â”‚                 â”‚    â”‚              â”‚
â”‚ GitHub      â”‚    â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚    â”‚ S3 Bucket    â”‚
â”‚ CodeCommit  â”‚    â”‚ â”‚Build        â”‚ â”‚    â”‚ ECR Registry â”‚
â”‚ S3          â”‚    â”‚ â”‚Environment  â”‚ â”‚    â”‚ Local Cache  â”‚
â”‚ Bitbucket   â”‚    â”‚ â”‚             â”‚ â”‚    â”‚              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚ â”‚buildspec.ymlâ”‚ â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ“„ buildspec.yml Fundamentals

### Basic buildspec.yml Structure
```yaml
version: 0.2

# Environment variables
env:
  variables:
    NODE_ENV: production
    API_URL: https://api.example.com
  parameter-store:
    DATABASE_URL: /myapp/database/url
  secrets-manager:
    DB_PASSWORD: prod/myapp/db:password

# Build phases
phases:
  install:
    runtime-versions:
      nodejs: 18
    commands:
      - echo "Installing dependencies"
      - npm install

  pre_build:
    commands:
      - echo "Running pre-build commands"
      - npm run lint
      - npm run test:unit

  build:
    commands:
      - echo "Building the application"
      - npm run build
      - echo "Build completed on `date`"

  post_build:
    commands:
      - echo "Running post-build commands"
      - npm run test:integration

# Artifacts configuration
artifacts:
  files:
    - '**/*'
  base-directory: dist
  name: myapp-$(date +%Y-%m-%d)

# Caching configuration
cache:
  paths:
    - '/root/.npm/**/*'
    - 'node_modules/**/*'
```

### buildspec.yml Version and Compatibility
```yaml
# Version 0.2 (Current and Recommended)
version: 0.2

# Version 0.1 (Legacy - Limited Features)
version: 0.1

# Key Differences:
# - Version 0.2 supports environment variables from Parameter Store/Secrets Manager
# - Version 0.2 has improved artifact handling
# - Version 0.2 supports build batching
# - Version 0.2 allows multiple artifacts
```

## âš™ï¸ Environment Configuration

### Compute Types
```yaml
# Available Compute Types:
BUILD_GENERAL1_SMALL:   # 3 GB memory, 2 vCPU
BUILD_GENERAL1_MEDIUM:  # 7 GB memory, 4 vCPU  
BUILD_GENERAL1_LARGE:   # 15 GB memory, 8 vCPU
BUILD_GENERAL1_2XLARGE: # 145 GB memory, 72 vCPU

# GPU-enabled (for ML workloads):
BUILD_GENERAL1_LARGE_GPU: # 244 GB memory, 32 vCPU, 1 NVIDIA Tesla V100

# ARM-based processors:
BUILD_GENERAL1_SMALL_ARM:  # 4 GB memory, 2 vCPU
BUILD_GENERAL1_MEDIUM_ARM: # 8 GB memory, 4 vCPU
BUILD_GENERAL1_LARGE_ARM:  # 16 GB memory, 8 vCPU
```

### Runtime Environments
```yaml
# Amazon Linux 2 Images
aws/codebuild/amazonlinux2-x86_64-standard:4.0
aws/codebuild/amazonlinux2-x86_64-standard:3.0
aws/codebuild/amazonlinux2-aarch64-standard:2.0

# Ubuntu Images
aws/codebuild/standard:6.0  # Ubuntu 20.04
aws/codebuild/standard:5.0  # Ubuntu 18.04

# Windows Images
aws/codebuild/windows-base:2019-1.0
aws/codebuild/windows-base:2016-1.0

# Custom Images (ECR/Docker Hub)
your-account.dkr.ecr.region.amazonaws.com/my-build-image:latest
```

### Runtime Versions Configuration
```yaml
phases:
  install:
    runtime-versions:
      # Node.js versions
      nodejs: 18
      nodejs: 16
      nodejs: 14
      
      # Python versions
      python: 3.9
      python: 3.8
      python: 3.7
      
      # Java versions
      java: corretto17
      java: corretto11
      java: corretto8
      
      # .NET versions
      dotnet: 6.0
      dotnet: 5.0
      dotnet: 3.1
      
      # Go versions
      golang: 1.19
      golang: 1.18
      
      # PHP versions
      php: 8.1
      php: 8.0
      php: 7.4
      
      # Ruby versions
      ruby: 3.1
      ruby: 3.0
      ruby: 2.7
```

## ğŸ”§ Environment Variables Deep Dive

### Variable Types and Sources
```yaml
env:
  # Plain text variables (not recommended for secrets)
  variables:
    BUILD_ENV: production
    NODE_ENV: production
    API_VERSION: v1
    REGION: us-east-1
    
  # AWS Systems Manager Parameter Store
  parameter-store:
    DATABASE_URL: /myapp/prod/database/url
    API_KEY: /myapp/prod/api/key
    REDIS_URL: /myapp/prod/redis/url
    
  # AWS Secrets Manager
  secrets-manager:
    DB_PASSWORD: prod/myapp/db:password
    JWT_SECRET: prod/myapp/auth:jwt_secret
    THIRD_PARTY_TOKEN: prod/myapp/integrations:api_token
    
  # Exported variables (from shell commands)
  exported-variables:
    - BUILD_ID
    - COMMIT_HASH
```

### Built-in Environment Variables
```bash
# CodeBuild provides these automatically:
$CODEBUILD_BUILD_ARN           # Build ARN
$CODEBUILD_BUILD_ID            # Unique build identifier
$CODEBUILD_BUILD_NUMBER        # Build number for project
$CODEBUILD_BUILD_SUCCEEDING    # 0 or 1 indicating build status
$CODEBUILD_INITIATOR           # Entity that started the build
$CODEBUILD_KMS_KEY_ID          # KMS key ID for encryption
$CODEBUILD_LOG_PATH            # CloudWatch Logs group/stream
$CODEBUILD_PROJECT_NAME        # Name of the CodeBuild project
$CODEBUILD_PUBLIC_BUILD_URL    # Public URL for build (if enabled)
$CODEBUILD_RESOLVED_SOURCE_VERSION  # Commit ID being built
$CODEBUILD_SOURCE_REPO_URL     # Source repository URL
$CODEBUILD_SOURCE_VERSION      # Branch/tag being built
$CODEBUILD_SRC_DIR             # Source code directory path
$CODEBUILD_START_TIME          # Build start time
$CODEBUILD_WEBHOOK_ACTOR_ACCOUNT_ID  # Webhook actor
$CODEBUILD_WEBHOOK_BASE_REF    # Base reference for PR
$CODEBUILD_WEBHOOK_EVENT       # Webhook event type
$CODEBUILD_WEBHOOK_HEAD_REF    # Head reference for PR
$CODEBUILD_WEBHOOK_MERGE_COMMIT # Merge commit SHA
$CODEBUILD_WEBHOOK_PREV_COMMIT # Previous commit SHA
$CODEBUILD_WEBHOOK_TRIGGER     # Webhook trigger type
```

### Dynamic Variable Examples
```yaml
phases:
  pre_build:
    commands:
      # Set dynamic variables
      - export BUILD_ID=$(date +%Y%m%d-%H%M%S)
      - export COMMIT_HASH=${CODEBUILD_RESOLVED_SOURCE_VERSION:0:8}
      - export BRANCH_NAME=${CODEBUILD_WEBHOOK_HEAD_REF#refs/heads/}
      - export IMAGE_TAG=${BRANCH_NAME}-${COMMIT_HASH}
      
  build:
    commands:
      # Use dynamic variables
      - echo "Building version $BUILD_ID"
      - docker build -t myapp:$IMAGE_TAG .
      - echo "Built image myapp:$IMAGE_TAG"
```

## ğŸ”„ Build Phases Explained

### Install Phase
```yaml
phases:
  install:
    runtime-versions:
      nodejs: 18
    commands:
      # Install system packages
      - apt-get update -y
      - apt-get install -y jq curl
      
      # Install application dependencies
      - npm ci --only=production
      - pip install -r requirements.txt
      
      # Install build tools
      - npm install -g @angular/cli
      - curl -fsSL https://get.docker.com -o get-docker.sh
      - sh get-docker.sh
    finally:
      # Cleanup commands (run even if install fails)
      - rm -f get-docker.sh
```

### Pre-Build Phase
```yaml
phases:
  pre_build:
    commands:
      # Environment setup
      - echo "Configuring environment"
      - export NODE_ENV=production
      
      # Authentication (e.g., Docker registry)
      - aws ecr get-login-password --region $AWS_DEFAULT_REGION | docker login --username AWS --password-stdin $ECR_REPOSITORY_URI
      
      # Code quality checks
      - npm run lint
      - npm run security-scan
      - npm audit --audit-level=high
      
      # Unit tests
      - npm run test:unit
      
      # Database migrations (if needed)
      - npm run migrate:latest
    finally:
      # Generate test reports
      - npm run test:coverage
```

### Build Phase
```yaml
phases:
  build:
    commands:
      # Compile/build application
      - echo "Starting build at $(date)"
      - npm run build
      - npm run build:prod
      
      # Create Docker image
      - docker build -t $IMAGE_REPO_NAME:$IMAGE_TAG .
      - docker tag $IMAGE_REPO_NAME:$IMAGE_TAG $ECR_REPOSITORY_URI:$IMAGE_TAG
      
      # Package application
      - zip -r application-$BUILD_ID.zip dist/
      
      # Generate build metadata
      - echo "Build completed at $(date)"
      - echo "{\"build_id\":\"$BUILD_ID\",\"commit\":\"$COMMIT_HASH\",\"branch\":\"$BRANCH_NAME\"}" > build-info.json
    finally:
      # Archive build logs
      - cp /tmp/codebuild-*.log build-logs/ || true
```

### Post-Build Phase
```yaml
phases:
  post_build:
    commands:
      # Integration tests
      - npm run test:integration
      
      # Push Docker images
      - docker push $ECR_REPOSITORY_URI:$IMAGE_TAG
      - docker push $ECR_REPOSITORY_URI:latest
      
      # Upload artifacts to S3
      - aws s3 cp application-$BUILD_ID.zip s3://$ARTIFACTS_BUCKET/builds/
      
      # Notify external systems
      - curl -X POST $WEBHOOK_URL -d "{\"status\":\"success\",\"build_id\":\"$BUILD_ID\"}"
      
      # Security scanning
      - docker run --rm -v /var/run/docker.sock:/var/run/docker.sock aquasec/trivy:latest image $ECR_REPOSITORY_URI:$IMAGE_TAG
    finally:
      # Cleanup
      - docker system prune -f
      - npm run cleanup
```

## ğŸ—‚ï¸ Artifacts Configuration

### Basic Artifacts Setup
```yaml
artifacts:
  files:
    - '**/*'                    # Include all files
    - 'dist/**/*'              # Include dist directory
    - 'build/libs/*.jar'       # Include JAR files
    - '!node_modules/**/*'     # Exclude node_modules
    - '!**/*.log'             # Exclude log files
  base-directory: dist          # Base directory for artifacts
  name: myapp-$(date +%Y-%m-%d-%H-%M-%S)  # Dynamic naming
  discard-paths: no            # Keep directory structure
```

### Multiple Artifacts
```yaml
artifacts:
  # Primary artifacts
  files:
    - 'dist/**/*'
  base-directory: dist
  name: application-artifacts
  
  # Secondary artifacts
  secondary-artifacts:
    test-reports:
      files:
        - 'test-results/**/*'
        - 'coverage/**/*'
      base-directory: reports
      name: test-reports
    
    documentation:
      files:
        - 'docs/**/*'
        - 'README.md'
      name: documentation
```

### Conditional Artifacts
```yaml
artifacts:
  files:
    - |
      if [ "$CODEBUILD_BUILD_SUCCEEDING" = "1" ]; then
        echo "dist/**/*"
      else
        echo "logs/**/*"
        echo "debug/**/*"
      fi
```

## ğŸ’¾ Caching Strategies

### Local Caching
```yaml
cache:
  paths:
    # Node.js dependencies
    - '/root/.npm/**/*'
    - 'node_modules/**/*'
    
    # Python dependencies
    - '/root/.cache/pip/**/*'
    - 'venv/**/*'
    
    # Java dependencies
    - '/root/.m2/**/*'
    - '/root/.gradle/**/*'
    
    # .NET dependencies
    - '/root/.nuget/**/*'
    
    # Docker layers
    - '/var/lib/docker/overlay2/**/*'
    
    # Custom cache directories
    - 'vendor/**/*'
    - '.cache/**/*'
```

### S3 Cache Configuration
```yaml
cache:
  type: S3
  location: my-build-cache-bucket/cache-key
  paths:
    - '/root/.npm/**/*'
    - 'node_modules/**/*'
```

### Cache Optimization
```yaml
phases:
  pre_build:
    commands:
      # Restore cache manually if needed
      - |
        if [ -f "node_modules/.cache-timestamp" ]; then
          echo "Cache found, checking freshness"
          if [ $(stat -c %Y package-lock.json) -gt $(cat node_modules/.cache-timestamp) ]; then
            echo "package-lock.json newer than cache, clearing cache"
            rm -rf node_modules
          fi
        fi
      
      # Install dependencies
      - npm ci
      
      # Update cache timestamp
      - date +%s > node_modules/.cache-timestamp
```

## ğŸ“Š Advanced buildspec.yml Examples

### Multi-Language Project
```yaml
version: 0.2

phases:
  install:
    runtime-versions:
      nodejs: 18
      python: 3.9
      java: corretto11
    commands:
      - npm install
      - pip install -r requirements.txt
      - ./gradlew build

  pre_build:
    commands:
      - npm run test
      - python -m pytest
      - ./gradlew test

  build:
    commands:
      - npm run build
      - python setup.py sdist bdist_wheel
      - ./gradlew jar

  post_build:
    commands:
      - echo "All builds completed successfully"

artifacts:
  files:
    - 'dist/**/*'
    - 'build/libs/*.jar'
    - 'dist/*.whl'
```

### Docker Multi-Stage Build
```yaml
version: 0.2

env:
  variables:
    AWS_DEFAULT_REGION: us-east-1
    AWS_ACCOUNT_ID: 123456789012
    IMAGE_REPO_NAME: my-web-app

phases:
  pre_build:
    commands:
      - echo Logging in to Amazon ECR...
      - aws ecr get-login-password --region $AWS_DEFAULT_REGION | docker login --username AWS --password-stdin $AWS_ACCOUNT_ID.dkr.ecr.$AWS_DEFAULT_REGION.amazonaws.com

  build:
    commands:
      - echo Build started on `date`
      - echo Building the Docker image...
      - docker build -t $IMAGE_REPO_NAME:$CODEBUILD_BUILD_NUMBER .
      - docker tag $IMAGE_REPO_NAME:$CODEBUILD_BUILD_NUMBER $AWS_ACCOUNT_ID.dkr.ecr.$AWS_DEFAULT_REGION.amazonaws.com/$IMAGE_REPO_NAME:$CODEBUILD_BUILD_NUMBER

  post_build:
    commands:
      - echo Build completed on `date`
      - echo Pushing the Docker image...
      - docker push $AWS_ACCOUNT_ID.dkr.ecr.$AWS_DEFAULT_REGION.amazonaws.com/$IMAGE_REPO_NAME:$CODEBUILD_BUILD_NUMBER
      - echo Writing image definitions file...
      - printf '[{"name":"my-container","imageUri":"%s"}]' $AWS_ACCOUNT_ID.dkr.ecr.$AWS_DEFAULT_REGION.amazonaws.com/$IMAGE_REPO_NAME:$CODEBUILD_BUILD_NUMBER > imagedefinitions.json

artifacts:
  files:
    - imagedefinitions.json
    - appspec.yml
```

## ğŸ“ Practice Exercises

### Exercise 1: Basic buildspec.yml Creation
1. **Create a simple buildspec.yml** for a Node.js application
2. **Include install, build, and test phases**
3. **Configure artifacts output**
4. **Test the buildspec locally** using CodeBuild Local

### Exercise 2: Environment Variables
1. **Add environment variables** from Parameter Store
2. **Use built-in CodeBuild variables**
3. **Create dynamic variables** in pre_build phase
4. **Reference variables** throughout the build process

### Exercise 3: Advanced Configuration
1. **Implement caching** for dependencies
2. **Create multiple artifacts** (app + tests)
3. **Add conditional logic** based on branch
4. **Optimize build performance**

## ğŸ“ buildspec.yml Best Practices

### Security Best Practices
- âœ… Never hardcode secrets in buildspec.yml
- âœ… Use Parameter Store or Secrets Manager for sensitive values
- âœ… Implement least-privilege IAM policies
- âœ… Scan for vulnerabilities in build process
- âœ… Use trusted base images for custom environments

### Performance Best Practices
- âœ… Implement comprehensive caching strategies
- âœ… Use appropriate compute types for workload
- âœ… Parallelize independent build tasks
- âœ… Optimize Docker layer caching
- âœ… Clean up temporary files and caches

### Maintainability Best Practices
- âœ… Use meaningful variable names and comments
- âœ… Modularize complex build scripts
- âœ… Version control your buildspec.yml files
- âœ… Document custom build processes
- âœ… Implement proper error handling and logging

## â¡ï¸ Next Steps
Now that you understand CodeBuild basics and buildspec.yml configuration, proceed to [4. Build-Logs-Troubleshooting.md](4.%20Build-Logs-Troubleshooting.md) to learn how to view build logs and troubleshoot failed builds.